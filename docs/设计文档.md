### **"Easy-QFNU"项目设计文档 (后端优先版)**

- **版本**: 7.0 (后端优先开发策略)
- **日期**: 2025 年 1 月
- **状态**: 重构版 - 后端先行

#### **📝 修订历史**

- **V1.0-V6.0**: 历史版本（全栈同步开发策略）
- **V7.0**: **后端优先版**。采用"API-First"开发策略，优先构建稳固的后端服务，为前端 AI 辅助开发预留最大灵活性。

---

## **🎯 1. 项目概述与开发策略**

#### **项目愿景**

开发一款以学生为中心的第三方教务辅助工具，提供比官方系统更高效、更具价值的数据服务，成为学生学业规划的贴心助手。

#### **📋 开发策略调整**

**🔥 核心思路：后端先行，前端灵活**

1. **优先完善后端架构** - 构建完整、稳定、文档完善的 RESTful API
2. **预留前端技术栈选择空间** - 微信原生 vs UniApp，根据 AI 开发能力动态决策
3. **API-First 设计** - 后端独立可测试，前端可快速接入

#### **目标用户**

本校在读学生（约 2-5 万用户规模）

#### **核心价值主张**

- 🚀 **快速查询** - 比官方系统更高效的数据检索
- 📊 **数据洞察** - 独家的成绩分析与历史数据
- 📈 **学业规划** - 基于众包数据的选课决策支持

---

## **🎯 2. 功能模块规划**

### **2.1 MVP 核心功能（Phase 1 - 后端优先实现）**

| 模块         | 功能点       | 后端 API                 | 优先级 |
| ------------ | ------------ | ------------------------ | ------ |
| **认证模块** | 学号密码登录 | `POST /api/auth/login`   | 🔴 P0  |
| **认证模块** | JWT 令牌刷新 | `POST /api/auth/refresh` | 🔴 P0  |
| **查询模块** | 个人成绩查询 | `GET /api/grades`        | 🔴 P0  |
| **查询模块** | 个人课表查询 | `GET /api/schedule`      | 🔴 P0  |
| **分析模块** | GPA 计算服务 | `GET /api/stats/gpa`     | 🟡 P1  |

### **2.2 数据增强功能（Phase 2）**

| 模块         | 功能点         | 后端 API                                    | 优先级 |
| ------------ | -------------- | ------------------------------------------- | ------ |
| **历史数据** | 课程历史平均分 | `GET /api/stats/course/{course_id}/history` | 🟡 P1  |
| **众包模块** | 成绩数据贡献   | `POST /api/contribute/grades`               | 🟡 P1  |
| **排名模块** | 班内成绩排名   | `GET /api/stats/class-rank/{course_id}`     | 🟢 P2  |

### **2.3 社区功能（Phase 3）**

| 模块         | 功能点       | 后端 API                               | 优先级 |
| ------------ | ------------ | -------------------------------------- | ------ |
| **评价系统** | 提交课程评价 | `POST /api/reviews`                    | 🟢 P2  |
| **评价系统** | 获取课程评价 | `GET /api/reviews/course/{course_id}`  | 🟢 P2  |
| **管理后台** | 评价审核接口 | `POST /api/admin/reviews/{id}/approve` | 🟢 P2  |

---

## **🛠️ 3. 技术架构 (后端优先)**

### **3.1 后端技术栈 (优先实现)**

| 组件         | 技术选择              | 理由                                  |
| ------------ | --------------------- | ------------------------------------- |
| **语言**     | Python 3.11+          | 开发效率高，生态丰富                  |
| **Web 框架** | FastAPI               | 自动 API 文档，类型检查，高性能       |
| **数据库**   | SQLite + SQLAlchemy   | 轻量级，易部署，支持迁移到 PostgreSQL |
| **认证**     | JWT + Passlib         | 无状态认证，安全可靠                  |
| **API 文档** | Swagger/OpenAPI       | 自动生成，前端开发友好                |
| **数据爬取** | httpx + BeautifulSoup | 异步 HTTP，HTML 解析                  |
| **部署**     | Docker + Nginx        | 容器化部署，便于扩展                  |

### **3.2 前端技术栈 (灵活选择)**

根据 AI 开发能力和实际效果，灵活选择以下方案：

#### **方案 A：微信原生小程序**

```javascript
// 优势：性能好，API丰富，审核宽松
{
  "框架": "微信原生 (WXML + WXSS + JS)",
  "状态管理": "小程序原生 + 本地存储",
  "UI组件": "WeUI / Vant Weapp",
  "HTTP请求": "wx.request",
  "适用场景": "功能复杂，需要性能优化"
}
```

#### **方案 B：UniApp 跨平台**

```javascript
// 优势：一码多端，Vue生态，AI开发友好
{
  "框架": "UniApp + Vue 3",
  "状态管理": "Pinia",
  "UI组件": "uni-ui / uView",
  "HTTP请求": "uni.request",
  "适用场景": "快速开发，后续扩展H5/App"
}
```

### **3.3 核心架构图**

```mermaid
graph TB
    A[前端应用] -->|HTTPS/WSS| B[Nginx反向代理]
    B --> C[FastAPI应用]
    C --> D[JWT认证中间件]
    C --> E[业务逻辑层]
    E --> F[数据访问层]
    F --> G[SQLite数据库]
    E --> H[学校官网API]
    E --> I[缓存层 Redis]

    subgraph "后端服务"
        C
        D
        E
        F
        G
        I
    end

    subgraph "前端技术栈 (待定)"
        A1[微信原生小程序]
        A2[UniApp应用]
        A1 -.->|选择一| A
        A2 -.->|选择一| A
    end
```

---

## **🔐 4. 认证与安全架构**

### **4.1 双重认证设计**

```mermaid
sequenceDiagram
    participant F as 前端应用
    participant B as 后端API
    participant S as 学校官网
    participant D as SQLite数据库

    F->>B: POST /api/auth/login {学号, 密码}
    B->>S: 模拟登录验证
    S->>B: 返回Session Cookie
    B->>D: 存储加密Session
    B->>B: 生成JWT Token
    B->>F: 返回JWT (有效期7天)

    Note over F,B: 后续API调用
    F->>B: API请求 + Authorization: Bearer JWT
    B->>B: 验证JWT有效性
    B->>D: 获取用户Session
    B->>S: 使用Session请求数据
    S->>B: 返回业务数据
    B->>F: 返回处理后的数据
```

### **4.2 Session 管理策略**

| 场景         | 处理策略     | HTTP 状态码 | 前端行为           |
| ------------ | ------------ | ----------- | ------------------ |
| Session 有效 | 正常返回数据 | 200         | 正常显示           |
| Session 过期 | 返回特定错误 | 401         | 清除 JWT，跳转登录 |
| JWT 过期     | 返回认证错误 | 401         | 自动刷新或跳转登录 |
| 并发登录     | 允许多设备   | 200         | 正常使用           |

---

## **🌐 5. API 接口设计 (详细规范)**

### **5.1 认证相关 API**

#### **POST /api/auth/login**

```json
// 请求
{
  "student_id": "2021001001",
  "password": "user_password"
}

// 响应 (成功)
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "token_type": "bearer",
    "expires_in": 604800,
    "user_info": {
      "student_id": "2021001001",
      "name": "张三",
      "class": "计算机科学与技术2021-1班"
    }
  }
}

// 响应 (失败)
{
  "code": 40001,
  "message": "学号或密码错误",
  "data": null
}
```

### **5.2 成绩查询 API**

#### **GET /api/grades**

```json
// 请求头
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...

// 查询参数 (可选)
?semester=2023-2024-1&year=2023

// 响应
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "semesters": [
      {
        "semester": "2023-2024-1",
        "courses": [
          {
            "course_id": "CS101",
            "course_name": "程序设计基础",
            "credit": 4.0,
            "score": 85,
            "grade_point": 3.7,
            "teacher": "李老师",
            "course_type": "必修"
          }
        ],
        "semester_gpa": 3.65,
        "total_credits": 20.0
      }
    ],
    "overall_gpa": 3.72,
    "total_credits": 120.0
  }
}
```

### **5.3 课表查询 API**

#### **GET /api/schedule**

```json
// 响应
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "semester": "2023-2024-2",
    "weeks": [
      {
        "week": 1,
        "days": [
          {
            "date": "2024-02-26",
            "day_of_week": 1,
            "courses": [
              {
                "period": "1-2节",
                "time": "08:00-09:40",
                "course_name": "数据结构",
                "teacher": "王老师",
                "location": "教学楼A101",
                "weeks": "1-16周"
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### **5.4 统计分析 API**

#### **GET /api/stats/course/{course_id}/history**

```json
// 响应
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "course_info": {
      "course_id": "CS101",
      "course_name": "程序设计基础",
      "teacher": "李老师"
    },
    "historical_stats": {
      "sample_size": 1580,
      "data_range": "2019-2023年",
      "average_score": 78.5,
      "score_distribution": {
        "90-100": 15.2,
        "80-89": 35.8,
        "70-79": 32.1,
        "60-69": 14.6,
        "0-59": 2.3
      }
    },
    "current_stats": {
      "sample_size": 89,
      "data_range": "本学期众包数据",
      "average_score": 81.2,
      "last_updated": "2024-01-15T10:30:00Z"
    }
  }
}
```

---

## **🗃️ 6. 数据库设计**

### **6.1 核心表结构**

#### **用户表 (users)**

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(50),
    class_name VARCHAR(100),
    openid VARCHAR(64),  -- 微信openid
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    -- 隐私设置
    allow_data_contribution BOOLEAN DEFAULT FALSE,
    allow_ranking_display BOOLEAN DEFAULT FALSE
);
```

#### **会话表 (sessions)**

```sql
CREATE TABLE sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id VARCHAR(20) NOT NULL,
    session_data TEXT NOT NULL,  -- 加密存储的session信息
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES users(student_id)
);
```

#### **课程统计表 (course_statistics)**

```sql
CREATE TABLE course_statistics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id VARCHAR(20) NOT NULL,
    course_name VARCHAR(100) NOT NULL,
    teacher VARCHAR(50),
    semester VARCHAR(20) NOT NULL,
    -- 匿名统计数据
    score INTEGER NOT NULL,
    student_class VARCHAR(100),  -- 脱敏后的班级信息
    contributed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    -- 数据验证
    is_verified BOOLEAN DEFAULT FALSE
);
```

#### **历史数据表 (historical_course_stats)**

```sql
CREATE TABLE historical_course_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id VARCHAR(20) NOT NULL,
    course_name VARCHAR(100) NOT NULL,
    year_range VARCHAR(20) NOT NULL,  -- "2019-2023"
    sample_size INTEGER NOT NULL,
    average_score DECIMAL(5,2) NOT NULL,
    score_distribution TEXT NOT NULL,  -- JSON格式的分数分布
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **6.2 数据关系图**

```mermaid
erDiagram
    users ||--o{ sessions : "has"
    users ||--o{ course_statistics : "contributes"
    users ||--o{ teacher_reviews : "writes"

    users {
        int id PK
        string student_id UK
        string name
        string class_name
        string openid
        boolean allow_data_contribution
        timestamp created_at
    }

    sessions {
        int id PK
        string student_id FK
        text session_data
        timestamp expires_at
    }

    course_statistics {
        int id PK
        string course_id
        string course_name
        int score
        string semester
        boolean is_verified
    }

    historical_course_stats {
        int id PK
        string course_id
        string year_range
        int sample_size
        decimal average_score
    }
```

---

## **🚀 7. 开发路线图 (后端优先)**

### **Phase 1: 后端 MVP (2-3 周)**

#### **Week 1: 基础架构**

- [ ] FastAPI 项目初始化，Docker 环境搭建
- [ ] SQLite 数据库设计与 SQLAlchemy 模型定义
- [ ] JWT 认证中间件实现
- [ ] 学校官网登录模拟实现

#### **Week 2: 核心 API 开发**

- [ ] 用户认证 API (`/api/auth/*`)
- [ ] 成绩查询 API (`/api/grades`)
- [ ] 课表查询 API (`/api/schedule`)
- [ ] 基础统计 API (`/api/stats/gpa`)

#### **Week 3: 测试与文档**

- [ ] API 单元测试编写
- [ ] Swagger 文档完善
- [ ] 部署脚本与 CI/CD 配置
- [ ] 性能测试与优化

### **Phase 2: 前端快速开发 (1-2 周)**

#### **技术栈决策点**

```mermaid
flowchart TD
    A[开始前端开发] --> B{AI开发能力评估}
    B -->|Vue生态熟悉| C[选择UniApp]
    B -->|微信API复杂| D[选择微信原生]
    C --> E[使用Cursor+AI快速开发]
    D --> F[使用微信开发者工具]
    E --> G[1周内完成基础界面]
    F --> G
    G --> H[API联调测试]
    H --> I[用户体验优化]
```

#### **前端开发计划**

- [ ] **技术栈确定** - 根据 AI 开发效果选择最佳方案
- [ ] **UI 框架集成** - 选择合适的组件库
- [ ] **API 集成** - 基于已完成的后端 API 快速开发
- [ ] **状态管理** - 用户认证状态与数据缓存
- [ ] **用户体验** - 加载状态、错误处理、交互优化

### **Phase 3: 数据增强功能 (2-3 周)**

- [ ] 历史数据导入系统
- [ ] 众包数据收集 API
- [ ] 班内排名算法实现
- [ ] 数据可视化界面

### **Phase 4: 社区功能与上线 (2-3 周)**

- [ ] 课程评价系统
- [ ] 管理后台开发
- [ ] 内容审核流程
- [ ] 小程序审核与发布

---

## **🛡️ 8. 合规与安全**

### **8.1 数据安全措施**

| 安全层面     | 具体措施                     |
| ------------ | ---------------------------- |
| **传输安全** | 全站 HTTPS，API 请求加密     |
| **存储安全** | 敏感数据加密存储，密码不落地 |
| **访问控制** | JWT 令牌，接口权限验证       |
| **数据脱敏** | 众包数据匿名化处理           |
| **会话管理** | Session 定期过期，安全存储   |

### **8.2 合规要求**

| 合规项         | 实现方案                   |
| -------------- | -------------------------- |
| **用户协议**   | 登录前强制确认，版本控制   |
| **隐私政策**   | 数据使用透明化，用户可控   |
| **数据授权**   | 众包功能独立授权，可撤销   |
| **非官方声明** | 所有界面明确标识第三方应用 |

---

## **📊 9. 监控与运维**

### **9.1 关键指标监控**

```python
# 示例监控指标
monitoring_metrics = {
    "业务指标": {
        "日活用户": "DAU",
        "API调用次数": "API_CALLS",
        "登录成功率": "LOGIN_SUCCESS_RATE",
        "数据贡献率": "DATA_CONTRIBUTION_RATE"
    },
    "技术指标": {
        "API响应时间": "API_RESPONSE_TIME",
        "错误率": "ERROR_RATE",
        "数据库连接": "DB_CONNECTIONS",
        "缓存命中率": "CACHE_HIT_RATE"
    }
}
```

### **9.2 部署配置**

```dockerfile
# Dockerfile示例
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## **🎯 10. 总结与下一步**

### **10.1 后端优先策略优势**

1. **API-First 设计** - 前后端解耦，并行开发
2. **技术栈灵活性** - 前端可根据 AI 开发效果选择最佳方案
3. **测试驱动** - 后端 API 可独立测试，保证质量
4. **文档驱动** - 完善的 API 文档支持前端快速开发

### **10.2 关键决策点**

1. **前端技术栈** - 根据 AI 开发实际效果在微信原生和 UniApp 间选择
2. **数据库迁移** - 用户增长后可无缝迁移到 PostgreSQL
3. **缓存策略** - 根据并发需求决定是否引入 Redis
4. **监控方案** - 选择适合的 APM 工具

### **10.3 立即行动项**

1. **开始后端开发** - 按 Phase 1 计划执行
2. **准备前端环境** - 搭建微信开发环境和 UniApp 环境
3. **API 文档编写** - 确保前端开发有完整参考
4. **CI/CD 配置** - 自动化测试和部署流程

---

**本文档将随着开发进展持续更新，确保团队始终基于最新的设计决策进行开发。**
