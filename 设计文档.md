### Easy-QFNUJW 微信小程序后端项目设计文档

- **版本**: 4.0 (最终集成版)
- **日期**: 2025 年 8 月 16 日
- **修订历史**:
  - V1.0: 初版构思。
  - V2.0: 确立“众包模式”以确保合规。
  - V3.0: 引入“历史参考数据”解决冷启动问题，确立混合数据模型。
  - V4.0: **最终版**。澄清并优化了班内排名功能，固化了安全架构和前后端交互模式。

#### **1. 项目概述**

- **项目愿景**: 开发一款以学生为中心的第三方教务辅助工具，提供比官方系统更高效、更具价值的数据服务，成为学生学业规划的贴心助手。
- **目标用户**: 本校在读学生。
- **核心价值**: 快速查询、数据洞察、学业规划。

#### **2. 核心功能清单**

| 模块         | 功能点                      | 详细描述                                                                                                                         |
| :----------- | :-------------------------- | :------------------------------------------------------------------------------------------------------------------------------- |
| **用户中心** | 登录/退出                   | 基于学号密码的登录认证，支持自动登录。                                                                                           |
| **核心查询** | 课表查询                    | 周视图课表，清晰展示时间、地点、教师。                                                                                           |
|              | 成绩查询                    | 按学期分组，展示个人完整成绩单。                                                                                                 |
|              | 课余量查询                  | 查询指定课程的剩余可选名额。                                                                                                     |
| **数据增强** | 绩点/均分计算               | 自动计算总 GPA、学期/学年 GPA、加权平均分。                                                                                      |
|              | 教师推荐                    | 基于历史问卷数据，提供选课时对教师的评价参考。                                                                                   |
|              | **课程成绩分析 (混合模式)** | 结合**经授权的历史参考数据**和**用户实时众包数据**，提供课程历史平均分。                                                         |
|              | **班内成绩分析 (个人可见)** | 基于用户授权的众包数据，为用户**单独、私密地展示**其单科成绩在班内的**百分位和精确排名**。该功能有数据量门槛，且结果仅本人可见。 |

#### **3. 技术架构与选型**

- **前端**: 微信原生小程序 (WXML, WXSS, JavaScript)
- **后端**: Python + FastAPI 框架
- **数据库**: SQLite (用于存储后端 Session 缓存及应用数据)
- **部署**: 云服务器 (ECS) + Nginx (HTTPS 与反向代理) + Uvicorn

#### **4. 认证与核心数据流 (Authentication & Data Flow)**

本项目存在两套独立且解耦的认证会话，这是保障安全和架构清晰的关键。

1.  **小程序 ⇌ 后端 (认证凭证: JWT)**

    - **流程**: 用户在小程序登录，后端验证其官网凭证后，生成一个 JWT 返回给小程序。
    - **原则**: 此 JWT 是小程序访问**我方后端**的唯一凭证。小程序**绝对不**接触、不存储学校官网的任何 Cookie。
    - **状态**: 无状态。每个请求都携带 JWT 来校验身份。

2.  **后端 ⇌ 学校官网 (认证凭证: Session/Cookie)**

    - **流程**: 后端在用户登录时，通过模拟登录获取学校官网的 Session，并将其**序列化后存储在后端的 SQLite 数据库**中。
    - **原则**: 此 Session 是后端**代替用户**访问学校官网的唯一凭证，**完全封装在后端，永不泄露给前端**。
    - **状态**: 有状态。后端通过数据库维护每个用户与学校官网的会话。

3.  **官网 Session 过期处理流程**

    - **触发**: 后端使用存储的 Session 请求学校官网，发现被重定向到登录页（或收到特定错误），判断 Session 已失效。
    - **处理**: 后端**立即放弃**本次请求，**不尝试**自动重登录（因为未存储密码）。
    - **响应**: 后端向小程序返回一个**特定的错误码**（如 `HTTP 401`，`{"code": "SESSION_EXPIRED", ...}`）。
    - **小程序动作**: 接收到此特定错误码后，立即**清除本地 JWT**，并**强制用户跳转**到登录页面重新登录。

#### **5. API 接口设计 (V4.0)**

| 路径                           | 方法   | 描述                     | 请求/响应 (摘要)                                                                      |
| :----------------------------- | :----- | :----------------------- | :------------------------------------------------------------------------------------ |
| `/api/login`                   | `POST` | 用户登录                 | **Req**: `{"student_id", "password"}`\<br\>**Res**: `{"access_token", "token_type"}`  |
| `/api/grades`                  | `GET`  | 获取个人成绩             | **Res**: `{"grades": [...]}`                                                          |
| `/api/schedule`                | `GET`  | 获取个人课表             | **Res**: `{"schedule": [...]}`                                                        |
| `/api/stats/course/`           | `GET`  | 查询课程综合成绩分析     | **Req**: `?course_id=xxx`\<br\>**Res**: `{"historical": ..., "crowdsourced": ...}`    |
| `/api/stats/grades/contribute` | `POST` | 用户贡献个人成绩         | **Req**: `[{"course_id", "score", "class_id", ...}]`                                  |
| `/api/stats/class_rank/`       | `GET`  | 获取个人在班内的成绩分析 | **Req**: `?course_id=xxx`\<br\>**Res**: `{"rank": "5 / 35", "percentile": 0.85, ...}` |

#### **6. 数据库设计 (V4.0)**

- **`users` 表**: 存储 `openid` 与 `student_id` 的绑定关系，并增加 `contribution_preference` 字段记录用户是否同意贡献数据。
- **`sessions` 表**: 存储 `student_id` 与序列化后的学校官网 `Session`。
- **`historical_course_stats` 表**: [一次性导入] 存储授权的历史平均分数据。
- **`course_statistics` 表**: [持续写入] 存储用户匿名贡献的成绩，包含 `course_id`, `score`, `class_id` 等字段，用于实时计算。

#### **7. 合规与隐私**

1.  **《用户协议》与《隐私政策》**: 必须提供，并在登录前由用户明确勾选同意。
2.  **数据贡献授权**: 对于“众包”功能，必须采用\*\*“一次性弹窗授权”**模式，获取用户的**单独同意\*\*。明确告知用户数据将用于计算平均分和个人排名，并承诺匿名与安全。
3.  **明确非官方立场**: 小程序所有界面和宣传材料，必须清晰标注“第三方”或“非官方”，避免用户混淆。
4.  **安全基础**: 全站 HTTPS，后端不存储用户密码，严格遵守最小必要原则。

#### **8. 开发路线图 (V4.0)**

1.  **阶段一：MVP 核心功能 (上线可用)**

    - **任务**:
      1.  完成用户登录/认证/会话管理的全流程。
      2.  完成个人成绩查询、课表查询。
      3.  **[核心]** 完成历史平均分数据的导入与展示，让产品上线即有亮点。
    - **目标**: 打造一个稳定、快速、有独家数据的查询工具。

2.  **阶段二：社区化与价值深化**

    - **任务**:
      1.  上线“实时众包”的成绩贡献与查询功能。
      2.  上线“个人可见”的班内成绩分析（排名/百分位）功能。
      3.  上线教师推荐等其他增强功能。
    - **目标**: 引入社区共建模式，增强产品的数据价值和互动性。

3.  **阶段三：体验优化与社群引流**

    - **任务**:
      1.  优化前端缓存、加载动画、异常处理等。
      2.  在各功能点全面植入 QQ 群的“情景化”引导入口。
    - **目标**: 提升产品流畅度和专业性，开始将小程序用户向私域社群转化。

4.  **阶段四：长期运营**

    - **任务**: 根据用户在 QQ 群的反馈，迭代新功能（如成绩推送），持续运营。
    - **目标**: 打造一个高黏性、高口碑的校园服务生态。
