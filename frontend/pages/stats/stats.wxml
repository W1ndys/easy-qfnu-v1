<!--æ•°æ®ç»Ÿè®¡é¡µé¢-->
<view class="container">
  <!-- æ ‡ç­¾æ  -->
  <view class="tab-bar card">
    <view 
      class="tab-item {{activeTab === 'course' ? 'active' : ''}}"
      data-tab="course"
      bindtap="switchTab"
    >
      ğŸ“Š è¯¾ç¨‹ç»Ÿè®¡
    </view>
    <view 
      class="tab-item {{activeTab === 'rank' ? 'active' : ''}}"
      data-tab="rank"
      bindtap="switchTab"
    >
      ğŸ“ˆ ç­å†…æ’å
    </view>
    <view 
      class="tab-item {{activeTab === 'contribute' ? 'active' : ''}}"
      data-tab="contribute"
      bindtap="switchTab"
    >
      ğŸ¤ æ•°æ®è´¡çŒ®
    </view>
  </view>

  <!-- è¯¾ç¨‹ç»Ÿè®¡æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'course'}}">
    <!-- æœç´¢æ¡† -->
    <view class="search-card card">
      <view class="search-header">
        <text class="search-title">è¯¾ç¨‹ç»Ÿè®¡æŸ¥è¯¢</text>
        <text class="search-desc">è¾“å…¥è¯¾ç¨‹IDæŸ¥çœ‹å†å²å¹³å‡åˆ†</text>
      </view>
      
      <view class="search-input-group">
        <input 
          class="search-input"
          placeholder="è¯·è¾“å…¥è¯¾ç¨‹ID"
          value="{{searchCourseId}}"
          bindinput="onSearchInput"
        />
        <button 
          class="search-btn {{isLoading ? 'loading' : ''}}"
          bindtap="searchCourseStats"
          disabled="{{isLoading}}"
        >
          {{isLoading ? 'æœç´¢ä¸­...' : 'æœç´¢'}}
        </button>
      </view>

      <!-- æœç´¢å†å² -->
      <view class="search-history" wx:if="{{courseHistory.length > 0}}">
        <view class="history-header">
          <text class="history-title">æœç´¢å†å²</text>
          <text class="clear-btn" bindtap="clearSearchHistory">æ¸…é™¤</text>
        </view>
        <view class="history-list">
          <view 
            class="history-item"
            wx:for="{{courseHistory}}"
            wx:key="course_id"
            data-courseid="{{item.course_id}}"
            bindtap="onHistoryItemTap"
          >
            <text class="history-course">{{item.course_name || item.course_id}}</text>
            <text class="history-time">{{item.time}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯¾ç¨‹ç»Ÿè®¡ç»“æœ -->
    <view class="stats-result card" wx:if="{{courseStats}}">
      <view class="result-header">
        <text class="result-title">{{courseStats.course_name}}</text>
        <text class="detail-btn" bindtap="showStatsDetail">è¯¦æƒ…</text>
      </view>

      <!-- å†å²æ•°æ® -->
      <view class="stats-section" wx:if="{{courseStats.historical}}">
        <view class="section-header">
          <text class="section-title">ğŸ“š å†å²å‚è€ƒæ•°æ®</text>
          <view class="data-badge historical">å®˜æ–¹æ•°æ®</view>
        </view>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{courseStats.historical.average_score}}</text>
            <text class="stat-label">å¹³å‡åˆ†</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{courseStats.historical.sample_count}}</text>
            <text class="stat-label">æ ·æœ¬æ•°</text>
          </view>
        </view>
      </view>

      <!-- ä¼—åŒ…æ•°æ® -->
      <view class="stats-section" wx:if="{{courseStats.crowdsourced}}">
        <view class="section-header">
          <text class="section-title">ğŸ‘¥ ä¼—åŒ…æ•°æ®</text>
          <view class="data-badge crowdsourced">å®æ—¶æ•°æ®</view>
        </view>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{courseStats.crowdsourced.average_score}}</text>
            <text class="stat-label">å¹³å‡åˆ†</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{courseStats.crowdsourced.sample_count}}</text>
            <text class="stat-label">æ ·æœ¬æ•°</text>
          </view>
        </view>
      </view>

      <!-- ç»¼åˆæ•°æ® -->
      <view class="combined-stats" wx:if="{{courseStats.combined_average}}">
        <view class="combined-header">
          <text class="combined-title">ğŸ¯ ç»¼åˆå¹³å‡åˆ†</text>
        </view>
        <view class="combined-value">
          <text class="combined-score">{{courseStats.combined_average}}</text>
          <text class="combined-desc">åŸºäº {{courseStats.total_samples}} ä¸ªæ ·æœ¬</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­å†…æ’åæ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'rank'}}">
    <view class="rank-card card">
      <view class="rank-header">
        <text class="rank-title">ç­å†…æˆç»©æ’å</text>
        <text class="rank-desc">æŸ¥çœ‹æ‚¨åœ¨ç­çº§ä¸­çš„æˆç»©æ’åï¼ˆä»…æœ¬äººå¯è§ï¼‰</text>
      </view>

      <view class="rank-search">
        <button 
          class="rank-btn {{isLoading ? 'loading' : ''}}"
          bindtap="queryClassRank"
          disabled="{{isLoading || !searchCourseId}}"
        >
          {{isLoading ? 'æŸ¥è¯¢ä¸­...' : 'æŸ¥è¯¢ç­å†…æ’å'}}
        </button>
        <text class="rank-hint">è¯·å…ˆåœ¨è¯¾ç¨‹ç»Ÿè®¡ä¸­æœç´¢è¯¾ç¨‹</text>
      </view>

      <!-- æ’åç»“æœ -->
      <view class="rank-result" wx:if="{{classRank}}">
        <view class="rank-result-header">
          <text class="rank-course">{{classRank.course_name}}</text>
          <text class="rank-detail-btn" bindtap="showRankDetail">è¯¦æƒ…</text>
        </view>

        <view class="rank-display">
          <view class="rank-main">
            <text class="rank-position">{{classRank.rank}}</text>
            <text class="rank-label">ç­å†…æ’å</text>
          </view>
          
          <view class="rank-stats">
            <view class="rank-stat">
              <text class="rank-stat-value">{{classRank.user_score}}</text>
              <text class="rank-stat-label">æ‚¨çš„æˆç»©</text>
            </view>
            <view class="rank-stat">
              <text class="rank-stat-value">{{classRank.percentileText}}%</text>
              <text class="rank-stat-label">ç™¾åˆ†ä½</text>
            </view>
            <view class="rank-stat">
              <text class="rank-stat-value">{{classRank.class_average}}</text>
              <text class="rank-stat-label">ç­çº§å¹³å‡</text>
            </view>
          </view>
        </view>

        <view class="rank-analysis">
          <text class="analysis-text {{classRank.is_above_average ? 'above' : 'below'}}">
            {{classRank.is_above_average ? 'ğŸ‰ æ‚¨çš„æˆç»©è¶…è¿‡äº†ç­çº§å¹³å‡æ°´å¹³' : 'ğŸ’ª ç»§ç»­åŠªåŠ›ï¼Œäº‰å–æ›´å¥½æˆç»©'}}
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ•°æ®è´¡çŒ®æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'contribute'}}">
    <view class="contribute-card card">
      <view class="contribute-header">
        <text class="contribute-title">æ•°æ®è´¡çŒ®è®¾ç½®</text>
        <text class="contribute-desc">å¸®åŠ©æ„å»ºæ›´å®Œå–„çš„æ•°æ®ç”Ÿæ€</text>
      </view>

      <!-- è´¡çŒ®å¼€å…³ -->
      <view class="contribute-setting">
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-name">å¯ç”¨æ•°æ®è´¡çŒ®</text>
            <text class="setting-desc">åŒ¿åè´¡çŒ®æ‚¨çš„æˆç»©æ•°æ®ç”¨äºç»Ÿè®¡åˆ†æ</text>
          </view>
          <switch 
            checked="{{contributionEnabled}}"
            bindchange="toggleContribution"
            color="#007AFF"
          />
        </view>
      </view>

      <!-- è´¡çŒ®è¯´æ˜ -->
      <view class="contribute-info">
        <view class="info-section">
          <text class="info-title">ğŸ”’ éšç§ä¿æŠ¤</text>
          <text class="info-content">â€¢ æ‰€æœ‰æ•°æ®å‡åŒ¿ååŒ–å¤„ç†\nâ€¢ ä¸ä¼šæ³„éœ²ä¸ªäººèº«ä»½ä¿¡æ¯\nâ€¢ ä»…ç”¨äºç»Ÿè®¡åˆ†æç›®çš„</text>
        </view>

        <view class="info-section">
          <text class="info-title">ğŸ“Š æ•°æ®ç”¨é€”</text>
          <text class="info-content">â€¢ è®¡ç®—è¯¾ç¨‹å†å²å¹³å‡åˆ†\nâ€¢ æä¾›ç­å†…æ’ååˆ†æ\nâ€¢ æ”¹å–„æ•°æ®å‡†ç¡®æ€§</text>
        </view>

        <view class="info-section">
          <text class="info-title">ğŸ¤ å…±å»ºå…±äº«</text>
          <text class="info-content">â€¢ å¸®åŠ©å…¶ä»–åŒå­¦è·å¾—å‡†ç¡®æ•°æ®\nâ€¢ å…±åŒæ„å»ºæ›´å¥½çš„å­¦ä¹ ç¯å¢ƒ\nâ€¢ éšæ—¶å¯ä»¥å…³é—­è´¡çŒ®åŠŸèƒ½</text>
        </view>
      </view>

      <!-- æ‰‹åŠ¨è´¡çŒ®æŒ‰é’® -->
      <view class="manual-contribute" wx:if="{{contributionEnabled}}">
        <button 
          class="contribute-btn"
          bindtap="contributeGrades"
        >
          ç«‹å³è´¡çŒ®æˆç»©æ•°æ®
        </button>
        <text class="contribute-note">å°†å½“å‰æˆç»©æ•°æ®åŒæ­¥åˆ°ç»Ÿè®¡ç³»ç»Ÿ</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <view class="empty-state" wx:if="{{!courseStats && !classRank && activeTab !== 'contribute'}}">
    <text class="empty-icon">ğŸ“ˆ</text>
    <text class="empty-text">æš‚æ— ç»Ÿè®¡æ•°æ®</text>
    <text class="empty-desc">è¯·æœç´¢è¯¾ç¨‹æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</text>
  </view>
</view>
