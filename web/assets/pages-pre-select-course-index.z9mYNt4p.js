import{a0 as e,r as l,o as a,c as t,w as s,a as i,n as o,e as n,d as r,j as c,t as u,b as d,E as p,k as h,g as m,p as f,Z as _,Y as y,q as v,s as g,u as k,a1 as b,f as w,Q as C,F as A,C as S,I as O,$,K as x,l as V,A as z,v as B}from"./index-BW-mWJBn.js";import{_ as E,r as j,a as I,o as T,b as H}from"./uni-app.es.CTLAGo9d.js";import{P as M}from"./PageLayout.DwCYY6nH.js";import{M as N}from"./ModernCard.BT3-a6NA.js";import{L as P,E as U}from"./EmptyState.hWf-1pBX.js";const J=E({name:"uniCollapseItem",props:{title:{type:String,default:""},name:{type:[Number,String],default:""},disabled:{type:Boolean,default:!1},showAnimation:{type:Boolean,default:!0},open:{type:Boolean,default:!1},thumb:{type:String,default:""},titleBorder:{type:String,default:"auto"},border:{type:Boolean,default:!0},showArrow:{type:Boolean,default:!0}},data:()=>({isOpen:!1,isheight:null,height:0,elId:`Uni_${Math.ceil(1e6*Math.random()).toString(36)}`,nameSync:0}),watch:{open(e){this.isOpen=e,this.onClick(e,"init")}},updated(e){this.$nextTick((()=>{this.init(!0)}))},created(){this.collapse=this.getCollapse(),this.oldHeight=0,this.onClick(this.open,"init")},unmounted(){this.__isUnmounted=!0,this.uninstall()},mounted(){this.collapse&&(""!==this.name?this.nameSync=this.name:this.nameSync=this.collapse.childrens.length+"",-1===this.collapse.names.indexOf(this.nameSync)?this.collapse.names.push(this.nameSync):console.warn(`name 值 ${this.nameSync} 重复`),-1===this.collapse.childrens.indexOf(this)&&this.collapse.childrens.push(this),this.init())},methods:{init(e){this.getCollapseHeight(e)},uninstall(){this.collapse&&(this.collapse.childrens.forEach(((e,l)=>{e===this&&this.collapse.childrens.splice(l,1)})),this.collapse.names.forEach(((e,l)=>{e===this.nameSync&&this.collapse.names.splice(l,1)})))},onClick(e,l){this.disabled||(this.isOpen=e,this.isOpen&&this.collapse&&this.collapse.setAccordion(this),"init"!==l&&this.collapse.onChange(e,this))},getCollapseHeight(l,a=0){e().in(this).select(`#${this.elId}`).fields({size:!0},(e=>{if(!(a>=10)){if(!e)return a++,void this.getCollapseHeight(!1,a);this.height=e.height,this.isheight=!0,l||this.onClick(this.isOpen,"init")}})).exec()},getNvueHwight(e){dom.getComponentRect(this.$refs["collapse--hook"],(l=>{if(l&&l.result&&l.size){if(this.height=l.size.height,this.isheight=!0,e)return;this.onClick(this.open,"init")}}))},getCollapse(e="uniCollapse"){let l=this.$parent,a=l.$options.name;for(;a!==e;){if(l=l.$parent,!l)return!1;a=l.$options.name}return l}}},[["render",function(e,f,_,y,v,g){const k=p,b=h,w=m,C=j(l("uni-icons"),I);return a(),t(w,{class:"uni-collapse-item"},{default:s((()=>[i(w,{onClick:f[0]||(f[0]=e=>g.onClick(!v.isOpen)),class:o(["uni-collapse-item__title",{"is-open":v.isOpen&&"auto"===_.titleBorder,"uni-collapse-item-border":"none"!==_.titleBorder}])},{default:s((()=>[i(w,{class:"uni-collapse-item__title-wrap"},{default:s((()=>[n(e.$slots,"title",{},(()=>[i(w,{class:o(["uni-collapse-item__title-box",{"is-disabled":_.disabled}])},{default:s((()=>[_.thumb?(a(),t(k,{key:0,src:_.thumb,class:"uni-collapse-item__title-img"},null,8,["src"])):r("",!0),i(b,{class:"uni-collapse-item__title-text"},{default:s((()=>[c(u(_.title),1)])),_:1})])),_:1},8,["class"])]),!0)])),_:3}),_.showArrow?(a(),t(w,{key:0,class:o([{"uni-collapse-item__title-arrow-active":v.isOpen,"uni-collapse-item--animation":!0===_.showAnimation},"uni-collapse-item__title-arrow"])},{default:s((()=>[i(C,{color:_.disabled?"#ddd":"#bbb",size:"14",type:"bottom"},null,8,["color"])])),_:1},8,["class"])):r("",!0)])),_:3},8,["class"]),i(w,{class:o(["uni-collapse-item__wrap",{"is--transition":_.showAnimation}]),style:d({height:(v.isOpen?v.height:0)+"px"})},{default:s((()=>[i(w,{id:v.elId,ref:"collapse--hook",class:o(["uni-collapse-item__wrap-content",{open:v.isheight,"uni-collapse-item--border":_.border&&v.isOpen}])},{default:s((()=>[n(e.$slots,"default",{},void 0,!0)])),_:3},8,["id","class"])])),_:3},8,["class","style"])])),_:3})}],["__scopeId","data-v-10d4b229"]]);const L=E({name:"uniCollapse",emits:["change","activeItem","input","update:modelValue"],props:{value:{type:[String,Array],default:""},modelValue:{type:[String,Array],default:""},accordion:{type:[Boolean,String],default:!1}},data:()=>({}),computed:{dataValue(){let e="string"==typeof this.value&&""===this.value||Array.isArray(this.value)&&0===this.value.length;"string"==typeof this.modelValue&&""===this.modelValue||Array.isArray(this.modelValue)&&this.modelValue.length;return e?this.modelValue:this.value}},watch:{dataValue(e){this.setOpen(e)}},created(){this.childrens=[],this.names=[]},mounted(){this.$nextTick((()=>{this.setOpen(this.dataValue)}))},methods:{setOpen(e){let l="string"==typeof e,a=Array.isArray(e);this.childrens.forEach(((t,s)=>{if(l&&e===t.nameSync){if(!this.accordion)return void console.warn("accordion 属性为 false ,v-model 类型应该为 array");t.isOpen=!0}a&&e.forEach((e=>{if(e===t.nameSync){if(this.accordion)return void console.warn("accordion 属性为 true ,v-model 类型应该为 string");t.isOpen=!0}}))})),this.emit(e)},setAccordion(e){this.accordion&&this.childrens.forEach(((l,a)=>{e!==l&&(l.isOpen=!1)}))},resize(){this.childrens.forEach(((e,l)=>{e.getCollapseHeight()}))},onChange(e,l){let a=[];this.accordion?a=e?l.nameSync:"":this.childrens.forEach(((e,l)=>{e.isOpen&&a.push(e.nameSync)})),this.$emit("change",a),this.emit(a)},emit(e){this.$emit("input",e),this.$emit("update:modelValue",e)}}},[["render",function(e,l,i,o,r,c){const u=m;return a(),t(u,{class:"uni-collapse"},{default:s((()=>[n(e.$slots,"default",{},void 0,!0)])),_:3})}],["__scopeId","data-v-65472c35"]]),q=E({__name:"index",setup(e){const n=f(!0),d=f(null),p=f(null),E=f([]),q=f({course_id_or_name:"",teacher_name:"",week_day:"",class_period:""}),R=["1","2","3","4","5","6","7"],D=["1-2","3-4","5-6","7-8","9-11","12-13"],F=D.map((e=>`${e}节`)),K=_((()=>{const e=d.value;return!(!e||!Array.isArray(e.modules))&&e.modules.some((e=>Array.isArray(e.courses)&&e.courses.length>0))})),Q=_((()=>{const e=d.value;return e&&Array.isArray(e.modules)?e.modules.reduce(((e,l)=>e+(l.count||0)),0):0}));function Y(){return!!v("token")||(g({title:"请先登录",icon:"none"}),k({url:"/pages/index/index"}),!1)}function Z(e){q.value.week_day=R[e.detail.value]}function G(e){q.value.class_period=D[e.detail.value]}function W(e){const l=Array.isArray(null==e?void 0:e.conflicts)?e.conflicts.filter(Boolean):[];return(null==e?void 0:e.conflict_text)||(null==e?void 0:e.conflict_detail)||(l.length?l.join("；"):"与已选或待选课程存在时间冲突")}async function X(){if(!Y())return;const e=function(){var e,l,a,t;const s={course_id_or_name:null==(e=q.value.course_id_or_name)?void 0:e.trim(),teacher_name:null==(l=q.value.teacher_name)?void 0:l.trim(),week_day:null==(a=q.value.week_day)?void 0:a.trim(),class_period:null==(t=q.value.class_period)?void 0:t.trim()};return Object.fromEntries(Object.entries(s).filter((([,e])=>!!e)))}();if(!e.course_id_or_name&&!e.teacher_name)return void g({title:"请填写课程名/编号或教师名",icon:"none"});n.value=!0;const l=v("token"),a=`${V().globalData.apiBaseURL}/api/v1/pre-select-course/query`;try{const{statusCode:t,data:s,header:i}=await z({url:a,method:"POST",header:{"Content-Type":"application/json",...l?{Authorization:"Bearer "+l}:{}},data:e});if(200===t&&s&&s.ok)d.value=s.data||{modules:[],errors:[]},Array.isArray(d.value.modules)||(d.value.modules=[]),Array.isArray(d.value.errors)||(d.value.errors=[]),p.value=null,K.value?E.value=d.value.modules.filter((e=>e.courses&&e.courses.length>0)).map((e=>e.module)):E.value=[];else if(401===t||403===t)B("token"),g({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>k({url:"/pages/index/index"})),1200);else{const l=(null==i?void 0:i.Allow)||(null==i?void 0:i.allow),o=s&&(s.detail||s.message)||"查询失败";g({title:o,icon:"none"}),d.value={modules:[],errors:[]},p.value={url:a,method:"POST",payload:JSON.stringify(e),statusCode:t,allow:l||"",message:"string"==typeof s?s:JSON.stringify(s)},console.warn("预选课查询失败",p.value)}}catch(t){console.error("请求失败",t),g({title:"网络连接失败",icon:"none"}),d.value={modules:[],errors:[]},p.value={url:a,method:"POST",payload:JSON.stringify(e),statusCode:-1,allow:"",message:String((null==t?void 0:t.message)||t)}}finally{n.value=!1}}function ee(){if(!p.value)return;const e=JSON.stringify(p.value,null,2);S({data:e,success:()=>g({title:"已复制",icon:"none"})})}function le(){X()}function ae(){q.value={course_id_or_name:"",teacher_name:"",week_day:"",class_period:""},d.value=null,E.value=[]}return T((()=>{Y()&&(y({title:"预选课查询"}),n.value=!1)})),H((()=>{Y()})),(e,f)=>{const _=m,y=h,v=O,g=$,k=j(l("uni-icons"),I),S=x,V=j(l("uni-collapse-item"),J),z=j(l("uni-collapse"),L);return a(),t(M,null,{default:s((()=>[n.value?(a(),t(P,{key:0,text:"正在加载数据..."})):(a(),t(_,{key:1,class:"page-container"},{default:s((()=>[i(_,{class:"background-decoration"},{default:s((()=>[i(_,{class:"circle circle-1"}),i(_,{class:"circle circle-2"}),i(_,{class:"circle circle-3"})])),_:1}),i(_,{class:"page-header"},{default:s((()=>[i(_,{class:"header-content"},{default:s((()=>[i(y,{class:"page-title"},{default:s((()=>[c("预选课查询")])),_:1}),i(y,{class:"page-subtitle"},{default:s((()=>[c("Pre-select Course Search")])),_:1})])),_:1})])),_:1}),i(_,{class:"content-wrapper"},{default:s((()=>[i(N,{title:"筛选与操作"},{default:s((()=>[i(_,{class:"filters-grid"},{default:s((()=>[i(_,{class:"form-item"},{default:s((()=>[i(y,{class:"label"},{default:s((()=>[c("课程名/编号")])),_:1}),i(v,{class:"input",modelValue:q.value.course_id_or_name,"onUpdate:modelValue":f[0]||(f[0]=e=>q.value.course_id_or_name=e),modelModifiers:{trim:!0},placeholder:"如 大学英语 或 g1234"},null,8,["modelValue"])])),_:1}),i(_,{class:"form-item"},{default:s((()=>[i(y,{class:"label"},{default:s((()=>[c("教师名")])),_:1}),i(v,{class:"input",modelValue:q.value.teacher_name,"onUpdate:modelValue":f[1]||(f[1]=e=>q.value.teacher_name=e),modelModifiers:{trim:!0},placeholder:"如 张三"},null,8,["modelValue"])])),_:1}),i(_,{class:"form-item"},{default:s((()=>[i(y,{class:"label"},{default:s((()=>[c("星期")])),_:1}),i(g,{mode:"selector",range:R,onChange:Z},{default:s((()=>[i(_,{class:o(["picker-value",{"is-selected":q.value.week_day}])},{default:s((()=>[c(u(q.value.week_day?`星期${q.value.week_day}`:"选择星期（可选）"),1)])),_:1},8,["class"])])),_:1})])),_:1}),i(_,{class:"form-item"},{default:s((()=>[i(y,{class:"label"},{default:s((()=>[c("节次")])),_:1}),i(g,{mode:"selector",range:b(F),onChange:G},{default:s((()=>[i(_,{class:o(["picker-value",{"is-selected":q.value.class_period}])},{default:s((()=>[c(u(q.value.class_period?`${q.value.class_period}节`:"选择节次（可选）"),1)])),_:1},8,["class"])])),_:1},8,["range"])])),_:1})])),_:1}),i(_,{class:"search-tip",style:{margin:"12rpx 0 0 0",color:"#868e96","font-size":"24rpx"}},{default:s((()=>[c(" 支持模糊搜索，建议使用课程代码，速度更快，结果更精准 ")])),_:1}),i(_,{class:"card-actions-wrapper"},{default:s((()=>[i(S,{class:"action-btn secondary-btn",onClick:ae},{default:s((()=>[i(k,{type:"refresh",size:"20",color:"#495057"}),i(y,null,{default:s((()=>[c("重置")])),_:1})])),_:1}),i(S,{class:"action-btn primary-btn",onClick:le},{default:s((()=>[i(k,{type:"paperplane",size:"20",color:"#fff"}),i(y,null,{default:s((()=>[c("查询")])),_:1})])),_:1})])),_:1})])),_:1}),p.value?(a(),t(N,{key:0,title:"查询出错"},{default:s((()=>[i(_,{class:"card-section"},{default:s((()=>[i(y,{class:"section-desc"},{default:s((()=>[c("抱歉，查询时遇到问题，请稍后重试。")])),_:1}),i(y,{class:"section-desc muted-text"},{default:s((()=>[c("状态码："+u(p.value.statusCode),1)])),_:1})])),_:1}),i(_,{class:"button-group",style:{"margin-top":"20rpx"}},{default:s((()=>[i(S,{class:"action-btn secondary-btn",onClick:ee},{default:s((()=>[i(k,{type:"copy",size:"20",color:"#495057"}),i(y,null,{default:s((()=>[c("复制详细诊断信息")])),_:1})])),_:1})])),_:1})])),_:1})):r("",!0),K.value?(a(),t(_,{key:2,class:"results-container"},{default:s((()=>[i(_,{class:"results-summary"},{default:s((()=>[i(y,null,{default:s((()=>[c("查询到 "+u(Q.value)+" 门相关课程，已按模块分组",1)])),_:1})])),_:1}),i(z,{modelValue:E.value,"onUpdate:modelValue":f[2]||(f[2]=e=>E.value=e),class:"results-collapse"},{default:s((()=>[(a(!0),w(A,null,C(d.value.modules,(e=>(a(),t(V,{key:e.module,name:e.module,title:`${e.module_name} (${e.count||0})`},{default:s((()=>[e.courses&&e.courses.length?(a(),t(_,{key:0,class:"course-list"},{default:s((()=>[(a(!0),w(A,null,C(e.courses,(l=>(a(),t(_,{class:"course-item",key:`${e.module}-${l.course_id}-${l.group_name}`},{default:s((()=>[i(_,{class:"course-header"},{default:s((()=>[i(_,{class:"course-title-group"},{default:s((()=>[i(y,{class:"course-name"},{default:s((()=>[c(u(l.course_name),1)])),_:2},1024),i(y,{class:"course-meta"},{default:s((()=>[c(u(l.course_id)+" / "+u(l.group_name),1)])),_:2},1024)])),_:2},1024),i(_,{class:"meta-tags"},{default:s((()=>[l.credits?(a(),t(y,{key:0,class:"pill pill-ghost"},{default:s((()=>[c(u(l.credits)+" 学分",1)])),_:2},1024)):r("",!0),i(y,{class:o(["pill",l.remain_count>0?"pill-success":"pill-danger"])},{default:s((()=>[c(" 余量 "+u(l.remain_count??"—"),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024),i(_,{class:"course-details"},{default:s((()=>[i(_,{class:"detail-item"},{default:s((()=>[i(k,{type:"person",size:"16",color:"#868e96"}),i(y,null,{default:s((()=>[c(u(l.teacher_name),1)])),_:2},1024)])),_:2},1024),i(_,{class:"detail-item"},{default:s((()=>[i(k,{type:"location",size:"16",color:"#868e96"}),i(y,null,{default:s((()=>[c(u(l.location)+" @ "+u(l.campus_name),1)])),_:2},1024)])),_:2},1024),i(_,{class:"detail-item full-width"},{default:s((()=>[i(k,{type:"calendar",size:"16",color:"#868e96"}),i(y,null,{default:s((()=>[c(u(l.time_text),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),l.time_conflict?(a(),t(_,{key:0,class:"conflict-box"},{default:s((()=>[i(k,{type:"info",size:"18",color:"#c92a2a"}),i(y,{class:"conflict-text"},{default:s((()=>[c(u(W(l)),1)])),_:2},1024)])),_:2},1024)):r("",!0)])),_:2},1024)))),128))])),_:2},1024)):(a(),t(_,{key:1,class:"empty-module"},{default:s((()=>[i(y,{class:"muted-text"},{default:s((()=>[c("本模块无相关课程")])),_:1})])),_:1}))])),_:2},1032,["name","title"])))),128))])),_:1},8,["modelValue"])])),_:1})):(a(),t(U,{key:1,"icon-type":"info-filled",title:"暂无结果",description:"请先输入课程名/编号或教师名进行查询","show-retry":!1}))])),_:1})])),_:1}))])),_:1})}}},[["__scopeId","data-v-55dc6297"]]);export{q as default};
