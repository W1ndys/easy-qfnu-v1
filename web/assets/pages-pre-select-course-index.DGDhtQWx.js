import{a0 as e,r as l,o as t,c as a,w as s,a as i,n as o,e as n,d as c,j as r,t as u,b as d,E as p,k as m,g as h,p as f,Z as _,Y as y,q as v,s as g,u as k,_ as b,a1 as w,f as C,Q as A,F as S,C as x,K as O,I as $,$ as V,l as z,A as B,v as j}from"./index-9gdLdziS.js";import{_ as E,r as I,a as T,o as H,b as M}from"./uni-app.es.KXFQ3NMT.js";import{P as N}from"./PageLayout.Ds9gNSiK.js";import{M as P}from"./ModernCard.rFVzwg9q.js";import{L as U,E as J}from"./EmptyState.BHJdz-yy.js";const L=E({name:"uniCollapseItem",props:{title:{type:String,default:""},name:{type:[Number,String],default:""},disabled:{type:Boolean,default:!1},showAnimation:{type:Boolean,default:!0},open:{type:Boolean,default:!1},thumb:{type:String,default:""},titleBorder:{type:String,default:"auto"},border:{type:Boolean,default:!0},showArrow:{type:Boolean,default:!0}},data:()=>({isOpen:!1,isheight:null,height:0,elId:`Uni_${Math.ceil(1e6*Math.random()).toString(36)}`,nameSync:0}),watch:{open(e){this.isOpen=e,this.onClick(e,"init")}},updated(e){this.$nextTick((()=>{this.init(!0)}))},created(){this.collapse=this.getCollapse(),this.oldHeight=0,this.onClick(this.open,"init")},unmounted(){this.__isUnmounted=!0,this.uninstall()},mounted(){this.collapse&&(""!==this.name?this.nameSync=this.name:this.nameSync=this.collapse.childrens.length+"",-1===this.collapse.names.indexOf(this.nameSync)?this.collapse.names.push(this.nameSync):console.warn(`name 值 ${this.nameSync} 重复`),-1===this.collapse.childrens.indexOf(this)&&this.collapse.childrens.push(this),this.init())},methods:{init(e){this.getCollapseHeight(e)},uninstall(){this.collapse&&(this.collapse.childrens.forEach(((e,l)=>{e===this&&this.collapse.childrens.splice(l,1)})),this.collapse.names.forEach(((e,l)=>{e===this.nameSync&&this.collapse.names.splice(l,1)})))},onClick(e,l){this.disabled||(this.isOpen=e,this.isOpen&&this.collapse&&this.collapse.setAccordion(this),"init"!==l&&this.collapse.onChange(e,this))},getCollapseHeight(l,t=0){e().in(this).select(`#${this.elId}`).fields({size:!0},(e=>{if(!(t>=10)){if(!e)return t++,void this.getCollapseHeight(!1,t);this.height=e.height,this.isheight=!0,l||this.onClick(this.isOpen,"init")}})).exec()},getNvueHwight(e){dom.getComponentRect(this.$refs["collapse--hook"],(l=>{if(l&&l.result&&l.size){if(this.height=l.size.height,this.isheight=!0,e)return;this.onClick(this.open,"init")}}))},getCollapse(e="uniCollapse"){let l=this.$parent,t=l.$options.name;for(;t!==e;){if(l=l.$parent,!l)return!1;t=l.$options.name}return l}}},[["render",function(e,f,_,y,v,g){const k=p,b=m,w=h,C=I(l("uni-icons"),T);return t(),a(w,{class:"uni-collapse-item"},{default:s((()=>[i(w,{onClick:f[0]||(f[0]=e=>g.onClick(!v.isOpen)),class:o(["uni-collapse-item__title",{"is-open":v.isOpen&&"auto"===_.titleBorder,"uni-collapse-item-border":"none"!==_.titleBorder}])},{default:s((()=>[i(w,{class:"uni-collapse-item__title-wrap"},{default:s((()=>[n(e.$slots,"title",{},(()=>[i(w,{class:o(["uni-collapse-item__title-box",{"is-disabled":_.disabled}])},{default:s((()=>[_.thumb?(t(),a(k,{key:0,src:_.thumb,class:"uni-collapse-item__title-img"},null,8,["src"])):c("",!0),i(b,{class:"uni-collapse-item__title-text"},{default:s((()=>[r(u(_.title),1)])),_:1})])),_:1},8,["class"])]),!0)])),_:3}),_.showArrow?(t(),a(w,{key:0,class:o([{"uni-collapse-item__title-arrow-active":v.isOpen,"uni-collapse-item--animation":!0===_.showAnimation},"uni-collapse-item__title-arrow"])},{default:s((()=>[i(C,{color:_.disabled?"#ddd":"#bbb",size:"14",type:"bottom"},null,8,["color"])])),_:1},8,["class"])):c("",!0)])),_:3},8,["class"]),i(w,{class:o(["uni-collapse-item__wrap",{"is--transition":_.showAnimation}]),style:d({height:(v.isOpen?v.height:0)+"px"})},{default:s((()=>[i(w,{id:v.elId,ref:"collapse--hook",class:o(["uni-collapse-item__wrap-content",{open:v.isheight,"uni-collapse-item--border":_.border&&v.isOpen}])},{default:s((()=>[n(e.$slots,"default",{},void 0,!0)])),_:3},8,["id","class"])])),_:3},8,["class","style"])])),_:3})}],["__scopeId","data-v-10d4b229"]]);const q=E({name:"uniCollapse",emits:["change","activeItem","input","update:modelValue"],props:{value:{type:[String,Array],default:""},modelValue:{type:[String,Array],default:""},accordion:{type:[Boolean,String],default:!1}},data:()=>({}),computed:{dataValue(){let e="string"==typeof this.value&&""===this.value||Array.isArray(this.value)&&0===this.value.length;"string"==typeof this.modelValue&&""===this.modelValue||Array.isArray(this.modelValue)&&this.modelValue.length;return e?this.modelValue:this.value}},watch:{dataValue(e){this.setOpen(e)}},created(){this.childrens=[],this.names=[]},mounted(){this.$nextTick((()=>{this.setOpen(this.dataValue)}))},methods:{setOpen(e){let l="string"==typeof e,t=Array.isArray(e);this.childrens.forEach(((a,s)=>{if(l&&e===a.nameSync){if(!this.accordion)return void console.warn("accordion 属性为 false ,v-model 类型应该为 array");a.isOpen=!0}t&&e.forEach((e=>{if(e===a.nameSync){if(this.accordion)return void console.warn("accordion 属性为 true ,v-model 类型应该为 string");a.isOpen=!0}}))})),this.emit(e)},setAccordion(e){this.accordion&&this.childrens.forEach(((l,t)=>{e!==l&&(l.isOpen=!1)}))},resize(){this.childrens.forEach(((e,l)=>{e.getCollapseHeight()}))},onChange(e,l){let t=[];this.accordion?t=e?l.nameSync:"":this.childrens.forEach(((e,l)=>{e.isOpen&&t.push(e.nameSync)})),this.$emit("change",t),this.emit(t)},emit(e){this.$emit("input",e),this.$emit("update:modelValue",e)}}},[["render",function(e,l,i,o,c,r){const u=h;return t(),a(u,{class:"uni-collapse"},{default:s((()=>[n(e.$slots,"default",{},void 0,!0)])),_:3})}],["__scopeId","data-v-65472c35"]]),R=E({__name:"index",setup(e){const n=f(!0),d=f(null),p=f(null),E=f([]),R=f(!0),D=f({course_id_or_name:"",teacher_name:"",week_day:"",class_period:""}),F=["1","2","3","4","5","6","7"],K=["1-2","3-4","5-6","7-8","9-11","12-13"],Q=K.map((e=>`${e}节`)),Y=_((()=>{const e=d.value;return!(!e||!Array.isArray(e.modules))&&e.modules.some((e=>Array.isArray(e.courses)&&e.courses.length>0))})),Z=_((()=>{const e=d.value;return e&&Array.isArray(e.modules)?e.modules.reduce(((e,l)=>e+(l.count||0)),0):0}));function G(){return!!v("token")||(g({title:"请先登录",icon:"none"}),k({url:"/pages/index/index"}),!1)}function W(e){D.value.week_day=F[e.detail.value]}function X(e){D.value.class_period=K[e.detail.value]}function ee(e){const l=Array.isArray(null==e?void 0:e.conflicts)?e.conflicts.filter(Boolean):[];return(null==e?void 0:e.conflict_text)||(null==e?void 0:e.conflict_detail)||(l.length?l.join("；"):"与已选或待选课程存在时间冲突")}async function le(){if(!G())return;const e=function(){var e,l,t,a;const s={course_id_or_name:null==(e=D.value.course_id_or_name)?void 0:e.trim(),teacher_name:null==(l=D.value.teacher_name)?void 0:l.trim(),week_day:null==(t=D.value.week_day)?void 0:t.trim(),class_period:null==(a=D.value.class_period)?void 0:a.trim()};return Object.fromEntries(Object.entries(s).filter((([,e])=>!!e)))}();if(!e.course_id_or_name&&!e.teacher_name)return void g({title:"请填写课程名/编号或教师名",icon:"none"});n.value=!0;const l=v("token"),t=`${z().globalData.apiBaseURL}/api/v1/pre-select-course/query`;try{const{statusCode:a,data:s,header:i}=await B({url:t,method:"POST",header:{"Content-Type":"application/json",...l?{Authorization:"Bearer "+l}:{}},data:e});if(200===a&&s&&s.ok)d.value=s.data||{modules:[],errors:[]},Array.isArray(d.value.modules)||(d.value.modules=[]),Array.isArray(d.value.errors)||(d.value.errors=[]),p.value=null,Y.value?E.value=d.value.modules.filter((e=>e.courses&&e.courses.length>0)).map((e=>e.module)):E.value=[];else if(401===a||403===a)j("token"),g({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>k({url:"/pages/index/index"})),1200);else{const l=(null==i?void 0:i.Allow)||(null==i?void 0:i.allow),o=s&&(s.detail||s.message)||"查询失败";g({title:o,icon:"none"}),d.value={modules:[],errors:[]},p.value={url:t,method:"POST",payload:JSON.stringify(e),statusCode:a,allow:l||"",message:"string"==typeof s?s:JSON.stringify(s)},console.warn("预选课查询失败",p.value)}}catch(a){console.error("请求失败",a),g({title:"网络连接失败",icon:"none"}),d.value={modules:[],errors:[]},p.value={url:t,method:"POST",payload:JSON.stringify(e),statusCode:-1,allow:"",message:String((null==a?void 0:a.message)||a)}}finally{n.value=!1}}function te(){if(!p.value)return;const e=JSON.stringify(p.value,null,2);x({data:e,success:()=>g({title:"已复制",icon:"none"})})}function ae(){le()}function se(){D.value={course_id_or_name:"",teacher_name:"",week_day:"",class_period:""},d.value=null,E.value=[]}function ie(){const e=document.querySelector(".tip-modal-overlay");e?(e.classList.add("closing"),setTimeout((()=>{R.value=!1}),200)):R.value=!1}return H((()=>{G()&&(y({title:"预选课查询"}),n.value=!1,R.value=!0)})),M((()=>{G()})),(e,f)=>{const _=m,y=I(l("uni-icons"),T),v=h,g=O,k=$,x=V,z=I(l("uni-collapse-item"),L),B=I(l("uni-collapse"),q);return t(),a(N,null,{default:s((()=>[n.value?(t(),a(U,{key:0,text:"正在加载数据..."})):c("",!0),R.value?(t(),a(v,{key:1,class:"tip-modal-overlay",onClick:ie},{default:s((()=>[i(v,{class:"tip-modal",onClick:f[0]||(f[0]=b((()=>{}),["stop"]))},{default:s((()=>[i(v,{class:"tip-header"},{default:s((()=>[i(_,{class:"tip-title"},{default:s((()=>[r("使用提示")])),_:1}),i(v,{class:"tip-close",onClick:ie},{default:s((()=>[i(y,{type:"close",size:"20",color:"#868e96"})])),_:1})])),_:1}),i(v,{class:"tip-content",style:{"flex-direction":"row","flex-wrap":"wrap","justify-content":"center"}},{default:s((()=>[i(_,{class:"tip-text"},{default:s((()=>[r(" 本数据基于你的学生身份进行搜索，如果搜索没有结果，但你从夫子校园或其他地方搜到了开课数据，说明教务系统没有对你开放这个课程的搜索权限 ")])),_:1})])),_:1}),i(v,{class:"tip-footer"},{default:s((()=>[i(g,{class:"tip-btn",onClick:ie},{default:s((()=>[r("我已知晓")])),_:1})])),_:1})])),_:1})])),_:1})):(t(),a(v,{key:2,class:"page-container"},{default:s((()=>[i(v,{class:"background-decoration"},{default:s((()=>[i(v,{class:"circle circle-1"}),i(v,{class:"circle circle-2"}),i(v,{class:"circle circle-3"})])),_:1}),i(v,{class:"page-header"},{default:s((()=>[i(v,{class:"header-content"},{default:s((()=>[i(_,{class:"page-title"},{default:s((()=>[r("预选课查询")])),_:1}),i(_,{class:"page-subtitle"},{default:s((()=>[r("Pre-select Course Search")])),_:1})])),_:1})])),_:1}),i(v,{class:"content-wrapper"},{default:s((()=>[i(P,{title:"筛选与操作"},{default:s((()=>[i(v,{class:"filters-grid"},{default:s((()=>[i(v,{class:"form-item"},{default:s((()=>[i(_,{class:"label"},{default:s((()=>[r("课程名/编号")])),_:1}),i(k,{class:"input",modelValue:D.value.course_id_or_name,"onUpdate:modelValue":f[1]||(f[1]=e=>D.value.course_id_or_name=e),modelModifiers:{trim:!0},placeholder:"如 大学英语 或 g1234"},null,8,["modelValue"])])),_:1}),i(v,{class:"form-item"},{default:s((()=>[i(_,{class:"label"},{default:s((()=>[r("教师名")])),_:1}),i(k,{class:"input",modelValue:D.value.teacher_name,"onUpdate:modelValue":f[2]||(f[2]=e=>D.value.teacher_name=e),modelModifiers:{trim:!0},placeholder:"如 张三"},null,8,["modelValue"])])),_:1}),i(v,{class:"form-item"},{default:s((()=>[i(_,{class:"label"},{default:s((()=>[r("星期")])),_:1}),i(x,{mode:"selector",range:F,onChange:W},{default:s((()=>[i(v,{class:o(["picker-value",{"is-selected":D.value.week_day}])},{default:s((()=>[r(u(D.value.week_day?`星期${D.value.week_day}`:"选择星期（可选）"),1)])),_:1},8,["class"])])),_:1})])),_:1}),i(v,{class:"form-item"},{default:s((()=>[i(_,{class:"label"},{default:s((()=>[r("节次")])),_:1}),i(x,{mode:"selector",range:w(Q),onChange:X},{default:s((()=>[i(v,{class:o(["picker-value",{"is-selected":D.value.class_period}])},{default:s((()=>[r(u(D.value.class_period?`${D.value.class_period}节`:"选择节次（可选）"),1)])),_:1},8,["class"])])),_:1},8,["range"])])),_:1})])),_:1}),i(v,{class:"search-tip",style:{margin:"12rpx 0 0 0",color:"#868e96","font-size":"24rpx"}},{default:s((()=>[r(" 支持模糊搜索，建议使用课程代码，速度更快，结果更精准 ")])),_:1}),i(v,{class:"card-actions-wrapper"},{default:s((()=>[i(g,{class:"action-btn secondary-btn",onClick:se},{default:s((()=>[i(y,{type:"refresh",size:"20",color:"#495057"}),i(_,null,{default:s((()=>[r("重置")])),_:1})])),_:1}),i(g,{class:"action-btn primary-btn",onClick:ae},{default:s((()=>[i(y,{type:"paperplane",size:"20",color:"#fff"}),i(_,null,{default:s((()=>[r("查询")])),_:1})])),_:1})])),_:1})])),_:1}),p.value?(t(),a(P,{key:0,title:"查询出错"},{default:s((()=>[i(v,{class:"card-section"},{default:s((()=>[i(_,{class:"section-desc"},{default:s((()=>[r("抱歉，查询时遇到问题，请稍后重试。")])),_:1}),i(_,{class:"section-desc muted-text"},{default:s((()=>[r("状态码："+u(p.value.statusCode),1)])),_:1})])),_:1}),i(v,{class:"button-group",style:{"margin-top":"20rpx"}},{default:s((()=>[i(g,{class:"action-btn secondary-btn",onClick:te},{default:s((()=>[i(y,{type:"copy",size:"20",color:"#495057"}),i(_,null,{default:s((()=>[r("复制详细诊断信息")])),_:1})])),_:1})])),_:1})])),_:1})):c("",!0),Y.value?(t(),a(v,{key:2,class:"results-container"},{default:s((()=>[i(v,{class:"results-summary"},{default:s((()=>[i(_,null,{default:s((()=>[r("查询到 "+u(Z.value)+" 门相关课程，已按模块分组",1)])),_:1})])),_:1}),i(B,{modelValue:E.value,"onUpdate:modelValue":f[3]||(f[3]=e=>E.value=e),class:"results-collapse"},{default:s((()=>[(t(!0),C(S,null,A(d.value.modules,(e=>(t(),a(z,{key:e.module,name:e.module,title:`${e.module_name} (${e.count||0})`},{default:s((()=>[e.courses&&e.courses.length?(t(),a(v,{key:0,class:"course-list"},{default:s((()=>[(t(!0),C(S,null,A(e.courses,(l=>(t(),a(v,{class:"course-item",key:`${e.module}-${l.course_id}-${l.group_name}`},{default:s((()=>[i(v,{class:"course-header"},{default:s((()=>[i(v,{class:"course-title-group"},{default:s((()=>[i(_,{class:"course-name"},{default:s((()=>[r(u(l.course_name),1)])),_:2},1024),i(_,{class:"course-meta"},{default:s((()=>[r(u(l.course_id)+" / "+u(l.group_name),1)])),_:2},1024)])),_:2},1024),i(v,{class:"meta-tags"},{default:s((()=>[l.credits?(t(),a(_,{key:0,class:"pill pill-ghost"},{default:s((()=>[r(u(l.credits)+" 学分",1)])),_:2},1024)):c("",!0),i(_,{class:o(["pill",l.remain_count>0?"pill-success":"pill-danger"])},{default:s((()=>[r(" 余量 "+u(l.remain_count??"—"),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024),i(v,{class:"course-details"},{default:s((()=>[i(v,{class:"detail-item"},{default:s((()=>[i(y,{type:"person",size:"16",color:"#868e96"}),i(_,null,{default:s((()=>[r(u(l.teacher_name),1)])),_:2},1024)])),_:2},1024),i(v,{class:"detail-item"},{default:s((()=>[i(y,{type:"location",size:"16",color:"#868e96"}),i(_,null,{default:s((()=>[r(u(l.location)+" @ "+u(l.campus_name),1)])),_:2},1024)])),_:2},1024),i(v,{class:"detail-item full-width"},{default:s((()=>[i(y,{type:"calendar",size:"16",color:"#868e96"}),i(_,null,{default:s((()=>[r(u(l.time_text),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),l.time_conflict?(t(),a(v,{key:0,class:"conflict-box"},{default:s((()=>[i(y,{type:"info",size:"18",color:"#c92a2a"}),i(_,{class:"conflict-text"},{default:s((()=>[r(u(ee(l)),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)))),128))])),_:2},1024)):(t(),a(v,{key:1,class:"empty-module"},{default:s((()=>[i(_,{class:"muted-text"},{default:s((()=>[r("本模块无相关课程")])),_:1})])),_:1}))])),_:2},1032,["name","title"])))),128))])),_:1},8,["modelValue"])])),_:1})):(t(),a(J,{key:1,"icon-type":"info-filled",title:"暂无结果",description:"请先输入课程名/编号或教师名进行查询","show-retry":!1}))])),_:1})])),_:1}))])),_:1})}}},[["__scopeId","data-v-b4cd490a"]]);export{R as default};
