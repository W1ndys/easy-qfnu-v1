import{r as e,o as t,c as a,w as s,a as l,b as r,h as u,t as o,k as n,i as c,d as i,A as d,X as f,a0 as m,j as _,B as p,m as v,F as h,O as g,Y as y,U as b,D as x,f as k,E as w,H as S,J as C,u as N,G as A,e as j,K as z}from"./index-0mg6GXrD.js";import{_ as M,r as $,a as R,o as B,b as E,c as D}from"./uni-icons.XO2TjAUy.js";import{P as Y}from"./PageLayout.BoIXII-u.js";import{L as q}from"./LoadingScreen.DoE9gj6w.js";import{E as I}from"./EmptyState.KQrZbZfX.js";import{M as L}from"./ModernCard.wmLqeEzj.js";const T=M({__name:"DataStatusCard",props:{dataSource:{type:String,default:"cache"},updatedAt:{type:String,default:""},isRefreshing:{type:Boolean,default:!1}},emits:["refresh"],setup(f,{emit:m}){const _=e=>{if(!e)return"未知";try{const t=new Date(e),a=new Date-t,s=Math.floor(a/864e5),l=Math.floor(a/36e5),r=Math.floor(a/6e4);return s>0?`${s}天前`:l>0?`${l}小时前`:r>0?`${r}分钟前`:"刚刚"}catch(t){return"未知"}},p=m,v=()=>{p("refresh")};return(m,p)=>{const h=$(e("uni-icons"),R),g=c,y=i,b=d;return t(),a(L,{title:"数据状态",class:"data-status-card"},{default:s((()=>[l(y,{class:"data-status-container"},{default:s((()=>[l(y,{class:"status-info"},{default:s((()=>[l(y,{class:"status-row"},{default:s((()=>[l(y,{class:"status-item"},{default:s((()=>[l(h,{type:"cloud",size:"20",color:"live"===f.dataSource?"#52c41a":"#1890ff"},null,8,["color"]),l(g,{class:"status-label"},{default:s((()=>[r("数据来源:")])),_:1}),l(y,{class:u(["source-chip","live"===f.dataSource?"chip-live":"chip-cache"])},{default:s((()=>[l(y,{class:u(["source-dot","live"===f.dataSource?"dot-live":"dot-cache"])},null,8,["class"]),l(g,null,{default:s((()=>[r(o("live"===f.dataSource?"实时获取":"缓存数据"),1)])),_:1})])),_:1},8,["class"])])),_:1}),f.updatedAt?(t(),a(y,{key:0,class:"status-item"},{default:s((()=>[l(h,{type:"calendar",size:"20",color:"#666"}),l(g,{class:"status-label"},{default:s((()=>[r("更新时间:")])),_:1}),l(y,{class:"updated-chip"},{default:s((()=>[l(g,null,{default:s((()=>[r(o(_(f.updatedAt)),1)])),_:1})])),_:1})])),_:1})):n("",!0)])),_:1}),l(y,{class:"refresh-tip"},{default:s((()=>[l(h,{type:"info",size:"16",color:"#faad14"}),l(g,{class:"tip-text"},{default:s((()=>[r("如果没有新出成绩，无需刷新")])),_:1})])),_:1})])),_:1}),l(y,{class:"refresh-actions"},{default:s((()=>[l(b,{class:u(["refresh-btn",{loading:f.isRefreshing}]),disabled:f.isRefreshing,onClick:v},{default:s((()=>[l(h,{type:"refresh",size:"16",color:"#1890ff",class:u({spinning:f.isRefreshing})},null,8,["class"]),l(g,null,{default:s((()=>[r(o(f.isRefreshing?"刷新中...":"刷新数据"),1)])),_:1})])),_:1},8,["class","disabled"])])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-f381eca2"]]),F=M({__name:"EnrollmentSettings",props:{enrollmentYear:{type:[String,Number],default:null},currentSemester:{type:[String,Number],default:null}},emits:["year-change"],setup(u,{emit:n}){const d=u,_=n,p=f((()=>{const e=(new Date).getFullYear();return Array.from({length:5},((t,a)=>String(e-a)))})),v=f((()=>p.value.indexOf(String(d.enrollmentYear)))),h=e=>{const t=p.value[e.detail.value];_("year-change",t)};return(n,d)=>{const f=$(e("uni-icons"),R),_=c,g=i,y=m;return t(),a(L,{title:"学籍设置",class:"settings-card"},{default:s((()=>[l(g,{class:"enrollment-notice"},{default:s((()=>[l(f,{type:"info",size:"16",color:"#1890ff"}),l(_,{class:"notice-text"},{default:s((()=>[r("入伍、留级等学生请选择你所在班级的入学年份")])),_:1})])),_:1}),l(g,{class:"setting-item"},{default:s((()=>[l(_,{class:"setting-label"},{default:s((()=>[r("入学年份:")])),_:1}),l(y,{mode:"selector",range:p.value,value:v.value,onChange:h},{default:s((()=>[l(g,{class:"picker-value"},{default:s((()=>[l(_,null,{default:s((()=>[r(o(u.enrollmentYear||"请选择"),1)])),_:1}),l(f,{type:"bottom",size:"16",color:"#666"})])),_:1})])),_:1},8,["range","value"])])),_:1}),l(g,{class:"setting-item"},{default:s((()=>[l(_,{class:"setting-label"},{default:s((()=>[r("当前学期:")])),_:1}),l(_,{class:"setting-value"},{default:s((()=>[r(o(u.currentSemester?`第 ${u.currentSemester} 学期`:"请先选择入学年份"),1)])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-904a75e3"]]),O=M({__name:"TotalProgressCard",props:{modules:{type:Array,default:()=>[]}},setup(e){const d=e=>{const t=Number(e);return isNaN(t)?"0":t%1==0?String(t):t.toFixed(1)},m=e,p=f((()=>m.modules.reduce(((e,t)=>e+(Number(t.required_credits)||0)),0))),v=f((()=>m.modules.reduce(((e,t)=>e+(Number(t.completed_credits)||0)),0))),h=f((()=>p.value<=0?0:Math.min(100,Math.max(0,Math.round(v.value/p.value*100))))),g=f((()=>v.value<p.value));return(e,f)=>{const m=c,y=i;return t(),a(L,{title:"总学分进度",class:"total-progress-card"},{default:s((()=>[l(y,{class:"total-progress-container"},{default:s((()=>[l(y,{class:"total-header"},{default:s((()=>[l(y,{class:"total-title-section"},{default:s((()=>[l(m,{class:"total-title"},{default:s((()=>[r("培养方案总进度")])),_:1}),l(y,{class:u(["status-chip",g.value?"chip-module-incomplete":"chip-module-complete"])},{default:s((()=>[l(m,null,{default:s((()=>[r(o(g.value?"未修满":"已修满"),1)])),_:1})])),_:1},8,["class"])])),_:1}),l(y,{class:"total-credits-info"},{default:s((()=>[l(m,{class:"total-credits-text"},{default:s((()=>[r(o(d(v.value))+"/"+o(d(p.value))+" 学分",1)])),_:1}),g.value?(t(),a(m,{key:0,class:"total-shortage-text"},{default:s((()=>[r("差 "+o(d(p.value-v.value))+" 学分",1)])),_:1})):n("",!0)])),_:1}),l(y,{class:"total-progress-bar-container"},{default:s((()=>[l(y,{class:"progress-bar total-progress-bar"},{default:s((()=>[l(y,{class:u(["progress-fill",{danger:g.value}]),style:_({width:h.value+"%"})},null,8,["style","class"])])),_:1}),l(m,{class:"progress-text total-progress-text"},{default:s((()=>[r(o(h.value)+"%",1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-7b954b59"]]),P=M({__name:"ModuleList",props:{modules:{type:Array,default:()=>[]},currentSemester:{type:[String,Number],default:null}},emits:["copy-course-code"],setup(d,{emit:m}){const b=e=>{const t=Number(e);return isNaN(t)?"0":t%1==0?String(t):t.toFixed(1)},x=e=>{var t;return(null==(t=e.courses)?void 0:t.length)?e.courses.filter((e=>{var t;return!!(null==(t=e.completion_status)?void 0:t.includes("已修"))})).reduce(((e,t)=>{if(t.hours&&"object"==typeof t.hours)for(const[a,s]of Object.entries(t.hours))e[a]=(e[a]||0)+(Number(s)||0);return e}),{}):{total:0}},k=e=>{if(!e||"object"!=typeof e)return[];const t={lecture:"讲授",practice:"实践",seminar:"研讨",experiment:"实验",design:"设计",computer:"上机",discussion:"讨论",extracurricular:"课外",online:"在线"};return Object.entries(e).filter((([e,t])=>"total"!==e&&Number(t)>0)).map((([e,a])=>`${t[e]||e}: ${a}`))},w=d,S=m,C=p([]),N=()=>{C.value=w.modules.map((()=>!1))};f((()=>(w.modules.length!==C.value.length&&N(),w.modules)));const A=f((()=>[...w.modules].sort(((e,t)=>{const a=B(e),s=B(t);return a&&!s?-1:!a&&s?1:0})).map((e=>{const t=B(e);return{...e,courses:[...e.courses||[]].sort(((e,a)=>{const s=z(e),l=z(a);if(t){if(!s&&l)return-1;if(s&&!l)return 1;if(!s&&!l){const t=M(e),s=M(a);if(t&&!s)return-1;if(!t&&s)return 1}}else{if(s&&!l)return-1;if(!s&&l)return 1}const r=Number(e.semester)||0,u=Number(a.semester)||0;return r!==u?u-r:0}))}})))),j=e=>w.modules.findIndex((t=>t.module_name===e.module_name)),z=e=>{var t;return!!(null==(t=e.completion_status)?void 0:t.includes("已修"))},M=e=>{if(!e.semester||!w.currentSemester)return!1;const t=Number(e.semester);return t<=w.currentSemester&&t%2==w.currentSemester%2},B=e=>(Number(null==e?void 0:e.completed_credits)||0)<(Number(null==e?void 0:e.required_credits)||0),E=e=>{const t=Number(null==e?void 0:e.required_credits)||0,a=Number(null==e?void 0:e.completed_credits)||0;return t<=0?0:Math.min(100,Math.max(0,Math.round(a/t*100)))};return N(),(d,f)=>{const m=c,p=i,w=$(e("uni-icons"),R);return t(),a(L,{title:"培养方案模块"},{default:s((()=>[l(p,{class:"modules-list"},{default:s((()=>[(t(!0),v(h,null,g(A.value,((e,c)=>(t(),a(p,{key:e.module_name,class:u(["module-card",{incomplete:B(e),expanded:C.value[j(e)]}])},{default:s((()=>[l(p,{class:"module-header",onClick:t=>{return a=j(e),void(C.value[a]=!C.value[a]);var a}},{default:s((()=>[l(p,{class:"header-info"},{default:s((()=>[l(p,{class:"header-top"},{default:s((()=>[l(m,{class:"module-title"},{default:s((()=>[r(o(e.module_name),1)])),_:2},1024),l(p,{class:u(["status-chip",B(e)?"chip-module-incomplete":"chip-module-complete"])},{default:s((()=>[l(m,null,{default:s((()=>[r(o(B(e)?"未修满":"已修满"),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),l(p,{class:"header-middle"},{default:s((()=>[l(p,{class:"credits-info"},{default:s((()=>[l(m,{class:"credits-text"},{default:s((()=>[r(o(b(e.completed_credits))+"/"+o(b(e.required_credits))+" 学分",1)])),_:2},1024),l(m,{class:"course-count-text"},{default:s((()=>[r("共 "+o((e.courses||[]).length)+" 门课程",1)])),_:2},1024),B(e)?(t(),a(m,{key:0,class:"shortage-text"},{default:s((()=>[r("差 "+o(b(Number(e.required_credits)-Number(e.completed_credits)))+" 学分",1)])),_:2},1024)):n("",!0)])),_:2},1024),l(p,{class:"expand-action"},{default:s((()=>[C.value[j(e)]?(t(),a(m,{key:1,class:"hint-text"},{default:s((()=>[r("点击收起")])),_:1})):(t(),a(m,{key:0,class:"hint-text"},{default:s((()=>[r("点击展开")])),_:1})),l(w,{class:u(["chevron-icon",{expanded:C.value[j(e)]}]),type:"arrowdown",size:"20",color:"#7F4515"},null,8,["class"])])),_:2},1024)])),_:2},1024),l(p,{class:"progress-container"},{default:s((()=>[l(p,{class:"progress-bar"},{default:s((()=>[l(p,{class:u(["progress-fill",{danger:B(e)}]),style:_({width:E(e)+"%"})},null,8,["style","class"])])),_:2},1024),l(m,{class:"progress-text"},{default:s((()=>[r(o(E(e))+"%",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),l(p,{class:"course-details"},{default:s((()=>[e.subtotal?(t(),a(p,{key:0,class:"module-subtotal"},{default:s((()=>[l(m,{class:"subtotal-title"},{default:s((()=>[r("模块要求小计")])),_:1}),l(m,{class:"subtotal-credits"},{default:s((()=>[r("要求学分 "+o(e.subtotal.total_credits),1)])),_:2},1024),l(m,{class:"subtotal-hours"},{default:s((()=>{var t;return[r("要求总学时 "+o((null==(t=e.subtotal.hours)?void 0:t.total)||0),1)]})),_:2},1024),l(p,{class:"subtotal-divider"}),l(m,{class:"subtotal-title"},{default:s((()=>[r("已修课程小计")])),_:1}),l(p,{class:"subtotal-completed-group"},{default:s((()=>[l(m,{class:"subtotal-hours"},{default:s((()=>[r(" 已修总学时 "+o(x(e).total||0),1)])),_:2},1024),(t(!0),v(h,null,g(k(x(e)),(e=>(t(),a(m,{key:e,class:"subtotal-meta"},{default:s((()=>[r(o(e),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)):n("",!0),l(p,{class:"course-sort-hint"},{default:s((()=>[l(p,{class:"sort-hint-text"},{default:s((()=>[l(w,{type:"info",size:"16",color:"#666"}),l(m,null,{default:s((()=>[r(o(B(e)?"未修课程已置顶显示，本学期课程优先":"已修课程已置顶显示"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),l(p,{class:"course-list"},{default:s((()=>[(t(!0),v(h,null,g(e.courses||[],(e=>(t(),a(p,{key:(e.course_code||"")+(e.course_name||""),class:u(["course-item",{completed:z(e)}])},{default:s((()=>[l(p,{class:"course-main"},{default:s((()=>[l(p,{class:"course-title-section"},{default:s((()=>[l(p,{class:"course-name-wrapper"},{default:s((()=>[l(m,{class:"course-name"},{default:s((()=>[r(o(e.course_name),1)])),_:2},1024),M(e)&&!z(e)?(t(),a(m,{key:0,class:"current-semester-tag"},{default:s((()=>[r("本学期可选")])),_:1})):n("",!0)])),_:2},1024),e.course_code?(t(),a(m,{key:0,class:"course-code",onClick:y((t=>{return a=e.course_code,void S("copy-course-code",a);var a}),["stop"])},{default:s((()=>[r("代码: "+o(e.course_code),1)])),_:2},1032,["onClick"])):n("",!0)])),_:2},1024),l(p,{class:"chips"},{default:s((()=>[l(m,{class:u(["chip completion-chip",z(e)?"chip-completed":"chip-incomplete"])},{default:s((()=>[r(o(e.completion_status||"未修"),1)])),_:2},1032,["class"]),e.course_nature?(t(),a(m,{key:0,class:"chip chip-neutral"},{default:s((()=>[r(o(e.course_nature),1)])),_:2},1024)):n("",!0),e.course_attribute?(t(),a(m,{key:1,class:"chip chip-neutral"},{default:s((()=>[r(o(e.course_attribute),1)])),_:2},1024)):n("",!0)])),_:2},1024)])),_:2},1024),l(p,{class:"course-meta"},{default:s((()=>{var u;return[l(m,{class:"meta"},{default:s((()=>[r("学分 "+o(e.credits),1)])),_:2},1024),e.semester?(t(),a(m,{key:0,class:"meta"},{default:s((()=>[r("学期 "+o(e.semester),1)])),_:2},1024)):n("",!0),(null==(u=e.hours)?void 0:u.total)?(t(),a(m,{key:1,class:"meta"},{default:s((()=>[r("总学时 "+o(e.hours.total),1)])),_:2},1024)):n("",!0),(t(!0),v(h,null,g(k(e.hours),(e=>(t(),a(m,{key:e,class:"meta"},{default:s((()=>[r(o(e),1)])),_:2},1024)))),128))]})),_:2},1024)])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1})])),_:1})}}},[["__scopeId","data-v-464b5f03"]]),U=M({__name:"NoticeModal",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(u,{emit:o}){const f=o,m=()=>{f("close")},_=()=>{f("confirm")},p=()=>{window.open("https://jwc.qfnu.edu.cn/info/1068/7039.htm","_blank")};return(o,f)=>{const v=$(e("uni-icons"),R),h=c,g=i,x=d;return t(),a(b,{name:"modal",appear:""},{default:s((()=>[u.visible?(t(),a(g,{key:0,class:"modal-overlay",onClick:m},{default:s((()=>[l(g,{class:"modal-container",onClick:f[0]||(f[0]=y((()=>{}),["stop"]))},{default:s((()=>[l(g,{class:"modal-header"},{default:s((()=>[l(v,{type:"info-filled",size:"24",color:"#1890ff"}),l(h,{class:"modal-title"},{default:s((()=>[r("培养方案说明")])),_:1})])),_:1}),l(g,{class:"modal-content"},{default:s((()=>[l(h,{class:"notice-text"},{default:s((()=>[r(" 本页面由教务系统培养方案表格直接生成，大部分专业的应修是160或170或175，该培养方案总和大部分都不足够（22级是），少的那些分就是你应该选的公选课的分。如果不够，请及时与对应负责老师沟通。 ")])),_:1}),l(h,{class:"notice-text",style:{"margin-top":"24rpx"}},{default:s((()=>[r(" 根据教务处官方规定：培养方案毕业学分原则上145-170学分，其中人文社会科学类专业毕业学分≤160学分，理科类专业毕业学分≤165学分，工科类专业毕业学分≤170学分，辅修学士学位专业毕业学分70学分左右。 ")])),_:1}),l(g,{style:{"margin-top":"16rpx"}},{default:s((()=>[l(h,{class:"notice-text",style:{"font-size":"24rpx",color:"#8c8c8c"}},{default:s((()=>[r("来源：")])),_:1}),l(h,{class:"link-text",onClick:p},{default:s((()=>[r("https://jwc.qfnu.edu.cn/info/1068/7039.htm")])),_:1})])),_:1})])),_:1}),l(g,{class:"modal-actions"},{default:s((()=>[l(x,{class:"action-btn primary-btn",onClick:_,style:{"background-color":"#834A1A",color:"white"}},{default:s((()=>[r("我已阅读")])),_:1})])),_:1})])),_:1})])),_:1})):n("",!0)])),_:1})}}},[["__scopeId","data-v-35525f39"]]),G=M({__name:"course-plan",setup(e){const r=p(!0),u=p([]),o=p(!1),n=p(null),c=p(null),d=p("cache"),f=p(""),m=p(!1);B((async()=>{const e=x("enrollmentYear");e&&(n.value=e,await v(e)),_(),console.log("用户进入培养方案页面")})),E((()=>{x("token")||(k({title:"请先登录",icon:"none"}),w({url:"/pages/index/index"}))})),D((async()=>{if(!x("token"))return k({title:"请先登录",icon:"none"}),w({url:"/pages/index/index"}),void S();await g(!0),S()}));const _=()=>{if(!x("token"))return k({title:"请先登录",icon:"none"}),void w({url:"/pages/index/index"});h()},v=async e=>{var t,a;if(e)try{const s=x("token"),l=await C({url:`${N().globalData.apiBaseURL}/api/v1/semester-info/${e}`,method:"GET",header:{Authorization:"Bearer "+s}});if(200!==l.statusCode||!(null==(t=l.data)?void 0:t.success))throw new Error((null==(a=l.data)?void 0:a.message)||"获取学期信息失败");c.value=l.data.data.current_semester}catch(s){console.error("获取当前学期失败",s),k({title:s.message||"获取学期信息失败",icon:"none"}),c.value=null}else c.value=null},h=async()=>{var e,t,a;const s=x("token");if(!s)return k({title:"请先登录",icon:"none"}),void w({url:"/pages/index/index"});r.value=!0;try{const l=await C({url:`${N().globalData.apiBaseURL}/api/v1/course-plan`,method:"GET",header:{Authorization:"Bearer "+s}});let o=null;if(200!==l.statusCode){if(401===l.statusCode)return A("token"),k({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>w({url:"/pages/index/index"})),1500);{const e=(null==(t=l.data)?void 0:t.detail)||(null==(a=l.data)?void 0:a.message)||"未知错误";throw new Error(`请求错误：${l.statusCode} - ${e}`)}}if((null==(e=l.data)?void 0:e.success)?(o=l.data.data,d.value=l.data.source||"cache",f.value=l.data.updated_at||"","live"!==d.value||m.value||k({title:"已获取最新数据",icon:"success",duration:2e3})):o=l.data,!o||!Array.isArray(o.modules))return k({title:"培养方案格式异常",icon:"none"}),void(u.value=[]);u.value=o.modules,u.value.length>0&&y()}catch(l){console.error("获取培养方案失败",l),k({title:l.message||"获取培养方案失败，请稍后重试",icon:"none",duration:2e3})}finally{r.value=!1}},g=async(e=!1)=>{var t,a,s;const l=x("token");if(!l)return k({title:"请先登录",icon:"none"}),void w({url:"/pages/index/index"});m.value=!0,e||(r.value=!0);try{const u=await C({url:`${N().globalData.apiBaseURL}/api/v1/course-plan/refresh`,method:"POST",header:{Authorization:"Bearer "+l}});if(200===u.statusCode&&(null==(t=u.data)?void 0:t.success))await h(),k({title:"数据已刷新",icon:"success",duration:2e3});else{if(401!==u.statusCode)throw new Error((null==(a=u.data)?void 0:a.detail)||(null==(s=u.data)?void 0:s.message)||"刷新失败");A("token"),k({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>w({url:"/pages/index/index"})),1500)}}catch(u){console.error("刷新缓存失败",u),k({title:u.message||"刷新失败，请稍后重试",icon:"none",duration:2e3})}finally{m.value=!1,e||(r.value=!1)}},y=()=>{setTimeout((()=>{o.value=!0}),500)},b=e=>{e&&j({data:e,success:()=>k({title:"课程代码已复制",icon:"none"})})},M=async e=>{n.value=e,z("enrollmentYear",e),await v(e),k({title:`学籍已设置为 ${e} 级`,icon:"none"})},$=()=>{o.value=!1},R=()=>{o.value=!1};return(e,_)=>{const p=i;return t(),a(Y,null,{default:s((()=>[r.value?(t(),a(q,{key:0,text:"正在获取培养方案..."})):(t(),a(p,{key:1,class:"page-rounded-container"},{default:s((()=>[0===u.value.length?(t(),a(I,{key:0,"icon-type":"info-filled",title:"暂无培养方案数据",description:"请稍后重试或下拉刷新","show-retry":!0,onRetry:h})):(t(),a(p,{key:1},{default:s((()=>[l(T,{"data-source":d.value,"updated-at":f.value,"is-refreshing":m.value,onRefresh:g},null,8,["data-source","updated-at","is-refreshing"]),l(F,{"enrollment-year":n.value,"current-semester":c.value,onYearChange:M},null,8,["enrollment-year","current-semester"]),l(O,{modules:u.value},null,8,["modules"]),l(P,{modules:u.value,"current-semester":c.value,onCopyCourseCode:b},null,8,["modules","current-semester"])])),_:1}))])),_:1})),l(U,{visible:o.value,onClose:R,onConfirm:$},null,8,["visible"])])),_:1})}}},[["__scopeId","data-v-d688e2e8"]]);export{G as default};
