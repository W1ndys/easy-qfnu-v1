import{p as e,P as t,q as s,s as a,u as l,x as r,z as o,l as u,v as c,r as n,c as d,w as i,o as f,a as m,j as _,n as p,t as v,d as h,b,f as y,K as x,F as g,Q as k,k as N,g as w,J as C,B as j}from"./index-C0NC_SWr.js";import{_ as M,o as q,b as $,c as z,r as E,a as A}from"./uni-app.es.BJASGa_D.js";import{P as B,M as F}from"./ModernCard.BCsMIRzD.js";import{L as T,E as I}from"./EmptyState.DSbhcwo_.js";const L=M({__name:"index",setup(M){const L=e(!0),O=e([]),P=e([]),R=e(!1),S=t((()=>[...O.value].sort(((e,t)=>{const s=H(e),a=H(t);return s&&!a?-1:!s&&a?1:0})).map((e=>{const t=H(e);return{...e,courses:[...e.courses||[]].sort(((e,s)=>{const a=Q(e),l=Q(s);if(t){if(!a&&l)return-1;if(a&&!l)return 1;if(!a&&!l){const t=U(e),a=U(s);if(t&&!a)return-1;if(!t&&a)return 1}}else{if(a&&!l)return-1;if(!a&&l)return 1}const r=Number(e.semester)||0,o=Number(s.semester)||0;return r!==o?o-r:0}))}}))));q((()=>{D()})),$((()=>{if(!s("token"))return a({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"})})),z((async()=>{if(!s("token"))return a({title:"请先登录",icon:"none"}),l({url:"/pages/index/index"}),void r();await G(),r()}));const D=()=>{if(!s("token"))return a({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"});G()},G=async()=>{var e,t,r;const n=s("token");if(!n)return a({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"});L.value=!0;try{const s=await o({url:`${u().globalData.apiBaseURL}/api/v1/course-plan`,method:"GET",header:{Authorization:"Bearer "+n}});let d=null;if(200!==s.statusCode){if(401===s.statusCode)return console.error("身份验证失败，请重新登录"),c("token"),a({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{l({url:"/pages/index/index"})}),1500);if(404===s.statusCode)return console.error("未找到培养方案数据"),void a({title:"未找到培养方案数据",icon:"none"});{const e=(null==(t=s.data)?void 0:t.detail)||(null==(r=s.data)?void 0:r.message)||"未知错误";throw console.error(`请求错误：${s.statusCode}`,s.data,e),new Error(`请求错误：${s.statusCode} - ${e}`)}}if(d=(null==(e=s.data)?void 0:e.success)?s.data.data:s.data,console.log("培养方案数据获取成功",d),!d)throw new Error("无有效数据");if(!Array.isArray(d.modules))return console.warn("返回的培养方案格式异常",d),a({title:"培养方案格式异常",icon:"none"}),void(O.value=[]);O.value=d.modules,console.log(`成功加载了${O.value.length}个培养方案模块`),P.value=O.value.map((()=>!1)),0===O.value.length?a({title:"暂无培养方案数据",icon:"none"}):J()}catch(d){console.error("获取培养方案失败",d),a({title:d.message||"获取培养方案失败，请稍后重试",icon:"none",duration:2e3})}finally{L.value=!1}},J=()=>{setTimeout((()=>{R.value=!0}),500)},K=e=>O.value.findIndex((t=>t.module_name===e.module_name)),Q=e=>!!e.completion_status&&e.completion_status.includes("已修"),U=e=>{if(!e.semester)return!1;const t=Number(e.semester);return t<=7&&t%2==1},H=e=>{const t=Number(null==e?void 0:e.required_credits)||0;return(Number(null==e?void 0:e.completed_credits)||0)<t},V=e=>{const t=Number(null==e?void 0:e.required_credits)||0,s=Number(null==e?void 0:e.completed_credits)||0;if(t<=0)return 0;return Math.min(100,Math.max(0,Math.round(s/t*100)))},W=e=>{if(!e.courses||0===e.courses.length)return{total:0};return e.courses.filter(Q).reduce(((e,t)=>{if(t.hours&&"object"==typeof t.hours)for(const[s,a]of Object.entries(t.hours))e[s]=(e[s]||0)+(Number(a)||0);return e}),{})},X=e=>{if(!e||"object"!=typeof e)return[];const t={lecture:"讲授",practice:"实践",seminar:"研讨",experiment:"实验",design:"设计",computer:"上机",discussion:"讨论",extracurricular:"课外",online:"在线"};return Object.entries(e).filter((([e,t])=>"total"!==e&&Number(t)>0)).map((([e,s])=>`${t[e]||e}: ${s}`))},Y=e=>{const t=Number(e);return Number.isNaN(t)?"0":t%1==0?String(t):t.toFixed(1)},Z=t((()=>O.value.reduce(((e,t)=>e+(Number(t.required_credits)||0)),0))),ee=t((()=>O.value.reduce(((e,t)=>e+(Number(t.completed_credits)||0)),0))),te=t((()=>{if(Z.value<=0)return 0;return Math.min(100,Math.max(0,Math.round(ee.value/Z.value*100)))})),se=t((()=>ee.value<Z.value)),ae=()=>{R.value=!1},le=()=>{R.value=!1};return(e,t)=>{const s=N,l=w,r=E(n("uni-icons"),A),o=C;return f(),d(B,null,{default:i((()=>[L.value?(f(),d(T,{key:0,text:"正在获取培养方案..."})):(f(),d(l,{key:1,class:"page-rounded-container"},{default:i((()=>[0===O.value.length?(f(),d(I,{key:0,"icon-type":"info-filled",title:"暂无培养方案数据",description:"请稍后重试或下拉刷新","show-retry":!0,onRetry:G})):(f(),d(l,{key:1},{default:i((()=>[m(F,{title:"总学分进度",class:"total-progress-card"},{default:i((()=>[m(l,{class:"total-progress-container"},{default:i((()=>[m(l,{class:"total-header"},{default:i((()=>[m(l,{class:"total-title-section"},{default:i((()=>[m(s,{class:"total-title"},{default:i((()=>[_("培养方案总进度")])),_:1}),m(l,{class:p(["status-chip",se.value?"chip-module-incomplete":"chip-module-complete"])},{default:i((()=>[m(s,null,{default:i((()=>[_(v(se.value?"未修满":"已修满"),1)])),_:1})])),_:1},8,["class"])])),_:1}),m(l,{class:"total-credits-info"},{default:i((()=>[m(s,{class:"total-credits-text"},{default:i((()=>[_(v(Y(ee.value))+"/"+v(Y(Z.value))+" 学分",1)])),_:1}),se.value?(f(),d(s,{key:0,class:"total-shortage-text"},{default:i((()=>[_("差 "+v(Y(Z.value-ee.value))+" 学分",1)])),_:1})):h("",!0),m(s,{class:"total-hint-text"},{default:i((()=>[_(" (相对于系统内方案，实际差值要看总学分要求，大部分专业是少几分的) ")])),_:1})])),_:1}),m(l,{class:"total-progress-bar-container"},{default:i((()=>[m(l,{class:"progress-bar total-progress-bar"},{default:i((()=>[m(l,{class:p(["progress-fill",{danger:se.value}]),style:b({width:te.value+"%"})},null,8,["style","class"])])),_:1}),m(s,{class:"progress-text total-progress-text"},{default:i((()=>[_(v(te.value)+"%",1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),m(F,{title:"培养方案模块"},{default:i((()=>[m(l,{class:"modules-list"},{default:i((()=>[(f(!0),y(g,null,x(S.value,((e,t)=>(f(),d(l,{key:e.module_name,class:p(["module-card",{incomplete:H(e),expanded:P.value[K(e)]}])},{default:i((()=>[m(l,{class:"module-header",onClick:t=>{return s=K(e),void(P.value[s]=!P.value[s]);var s}},{default:i((()=>[m(l,{class:"header-info"},{default:i((()=>[m(l,{class:"header-top"},{default:i((()=>[m(s,{class:"module-title"},{default:i((()=>[_(v(e.module_name),1)])),_:2},1024),m(l,{class:p(["status-chip",H(e)?"chip-module-incomplete":"chip-module-complete"])},{default:i((()=>[m(s,null,{default:i((()=>[_(v(H(e)?"未修满":"已修满"),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),m(l,{class:"header-middle"},{default:i((()=>[m(l,{class:"credits-info"},{default:i((()=>[m(s,{class:"credits-text"},{default:i((()=>[_(v(Y(e.completed_credits))+"/"+v(Y(e.required_credits))+" 学分",1)])),_:2},1024),H(e)?(f(),d(s,{key:0,class:"shortage-text"},{default:i((()=>[_("差 "+v(Y(Number(e.required_credits)-Number(e.completed_credits)))+" 学分",1)])),_:2},1024)):h("",!0)])),_:2},1024),m(l,{class:"expand-action"},{default:i((()=>[P.value[K(e)]?(f(),d(s,{key:1,class:"hint-text"},{default:i((()=>[_("点击收起")])),_:1})):(f(),d(s,{key:0,class:"hint-text"},{default:i((()=>[_("点击展开")])),_:1})),m(r,{class:p(["chevron-icon",{expanded:P.value[K(e)]}]),type:"arrowdown",size:"20",color:"#7F4515"},null,8,["class"])])),_:2},1024)])),_:2},1024),m(l,{class:"progress-container"},{default:i((()=>[m(l,{class:"progress-bar"},{default:i((()=>[m(l,{class:p(["progress-fill",{danger:H(e)}]),style:b({width:V(e)+"%"})},null,8,["style","class"])])),_:2},1024),m(s,{class:"progress-text"},{default:i((()=>[_(v(V(e))+"%",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),m(l,{class:p(["course-details",{expanded:P.value[K(e)]}])},{default:i((()=>[e.subtotal?(f(),d(l,{key:0,class:"module-subtotal"},{default:i((()=>[m(s,{class:"subtotal-title"},{default:i((()=>[_("模块要求小计")])),_:1}),m(s,{class:"subtotal-credits"},{default:i((()=>[_("要求学分 "+v(e.subtotal.total_credits),1)])),_:2},1024),m(s,{class:"subtotal-hours"},{default:i((()=>{var t;return[_("要求总学时 "+v((null==(t=e.subtotal.hours)?void 0:t.total)||0),1)]})),_:2},1024),m(l,{class:"subtotal-divider"}),m(s,{class:"subtotal-title"},{default:i((()=>[_("已修课程小计")])),_:1}),m(l,{class:"subtotal-completed-group"},{default:i((()=>[m(s,{class:"subtotal-hours"},{default:i((()=>[_(" 已修总学时 "+v(W(e).total||0),1)])),_:2},1024),(f(!0),y(g,null,x(X(W(e)),(e=>(f(),d(s,{key:e,class:"subtotal-meta"},{default:i((()=>[_(v(e),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)):h("",!0),m(l,{class:"course-sort-hint"},{default:i((()=>[m(s,{class:"sort-hint-text"},{default:i((()=>[m(r,{type:"info",size:"16",color:"#666"}),_(" "+v(H(e)?"未修课程已置顶显示，本学期课程优先":"已修课程已置顶显示"),1)])),_:2},1024)])),_:2},1024),m(l,{class:"course-list"},{default:i((()=>[(f(!0),y(g,null,x(e.courses||[],(e=>(f(),d(l,{key:(e.course_code||"")+(e.course_name||""),class:p(["course-item",{completed:Q(e)}])},{default:i((()=>[m(l,{class:"course-main"},{default:i((()=>[m(l,{class:"course-title-section"},{default:i((()=>[m(l,{class:"course-name-wrapper"},{default:i((()=>[m(s,{class:"course-name"},{default:i((()=>[_(v(e.course_name),1)])),_:2},1024),U(e)&&!Q(e)?(f(),d(s,{key:0,class:"current-semester-tag"},{default:i((()=>[_("本学期可选")])),_:1})):h("",!0)])),_:2},1024),e.course_code?(f(),d(s,{key:0,class:"course-code",onClick:k((t=>{var s;(s=e.course_code)&&j({data:s,success:()=>{a({title:"课程代码已复制",icon:"none"})}})}),["stop"])},{default:i((()=>[_("代码: "+v(e.course_code),1)])),_:2},1032,["onClick"])):h("",!0)])),_:2},1024),m(l,{class:"chips"},{default:i((()=>[m(s,{class:p(["chip completion-chip",Q(e)?"chip-completed":"chip-incomplete"])},{default:i((()=>[_(v(e.completion_status||"未修"),1)])),_:2},1032,["class"]),e.course_nature?(f(),d(s,{key:0,class:"chip chip-neutral"},{default:i((()=>[_(v(e.course_nature),1)])),_:2},1024)):h("",!0),e.course_attribute?(f(),d(s,{key:1,class:"chip chip-neutral"},{default:i((()=>[_(v(e.course_attribute),1)])),_:2},1024)):h("",!0)])),_:2},1024)])),_:2},1024),m(l,{class:"course-meta"},{default:i((()=>{var t;return[m(s,{class:"meta"},{default:i((()=>[_("学分 "+v(e.credits),1)])),_:2},1024),e.semester?(f(),d(s,{key:0,class:"meta"},{default:i((()=>[_("学期 "+v(e.semester),1)])),_:2},1024)):h("",!0),(null==(t=e.hours)?void 0:t.total)?(f(),d(s,{key:1,class:"meta"},{default:i((()=>[_("总学时 "+v(e.hours.total),1)])),_:2},1024)):h("",!0),(f(!0),y(g,null,x(X(e.hours),(e=>(f(),d(s,{key:e,class:"meta"},{default:i((()=>[_(v(e),1)])),_:2},1024)))),128))]})),_:2},1024)])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1032,["class"])])),_:2},1032,["class"])))),128))])),_:1})])),_:1})])),_:1}))])),_:1})),R.value?(f(),d(l,{key:2,class:"modal-overlay",onClick:le},{default:i((()=>[m(l,{class:"modal-container",onClick:t[0]||(t[0]=k((()=>{}),["stop"]))},{default:i((()=>[m(l,{class:"modal-header"},{default:i((()=>[m(r,{type:"info-filled",size:"24",color:"#1890ff"}),m(s,{class:"modal-title"},{default:i((()=>[_("培养方案说明")])),_:1})])),_:1}),m(l,{class:"modal-content"},{default:i((()=>[m(s,{class:"notice-text"},{default:i((()=>[_(" 本页面由教务系统培养方案表格直接生成，大部分专业的应修是160或170或175，该培养方案总和大部分都不足够（22级是），少的那些分就是你应该选的公选课的分。如果不够，请及时与对应负责老师沟通。 ")])),_:1}),m(s,{class:"notice-text",style:{"margin-top":"24rpx"}},{default:i((()=>[_(" 根据教务处官方规定：培养方案毕业学分原则上145-170学分，其中人文社会科学类专业毕业学分≤160学分，理科类专业毕业学分≤165学分，工科类专业毕业学分≤170学分，辅修学士学位专业毕业学分70学分左右。 ")])),_:1}),m(s,{class:"notice-text",style:{"margin-top":"16rpx","font-size":"24rpx",color:"#8c8c8c"}},{default:i((()=>[_(" 来源：https://jwc.qfnu.edu.cn/info/1068/7039.htm ")])),_:1})])),_:1}),m(l,{class:"modal-actions"},{default:i((()=>[m(o,{class:"action-btn primary-btn",onClick:ae},{default:i((()=>[_(" 我已阅读 ")])),_:1})])),_:1})])),_:1})])),_:1})):h("",!0)])),_:1})}}},[["__scopeId","data-v-bf3be5b5"]]);export{L as default};
