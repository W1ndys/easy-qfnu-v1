import{o as e,c as a,w as s,a as t,j as l,t as u,d as c,f as d,F as o,K as i,g as r,r as n,n as f,k as _,p,q as g,s as v,u as m,z as y,l as h,v as k,E as x,H as b,J as G}from"./index-CQlUSE66.js";import{_ as A,r as C,a as P,o as N,b as j}from"./uni-app.es.BxkoSt8v.js";import{M as w,P as O}from"./ModernCard.B0MZPj1q.js";import{L as z,E}from"./EmptyState.CYfP0U8W.js";const T=A({__name:"GPAAnalysis",props:{gpaAnalysis:{type:Object,required:!0},effectiveGpa:{type:Object,default:null},yearlyGpa:{type:Object,default:null},semesterGpa:{type:Object,default:null},totalCourses:{type:Number,default:0}},setup:n=>(f,_)=>{const p=r;return e(),a(p,{class:"gpa-analysis"},{default:s((()=>[t(w,{title:"GPA综合分析",highlight:""},{default:s((()=>[t(p,{class:"main-gpa-container"},{default:s((()=>[t(p,{class:"main-gpa-item highlight"},{default:s((()=>[t(p,{class:"gpa-label"},{default:s((()=>[l("有效GPA")])),_:1}),n.effectiveGpa?(e(),a(p,{key:0,class:"gpa-value primary"},{default:s((()=>[l(u(n.effectiveGpa.weighted_gpa),1)])),_:1})):c("",!0),n.effectiveGpa?(e(),a(p,{key:1,class:"gpa-detail"},{default:s((()=>[l(" 学分: "+u(n.effectiveGpa.total_credit)+" | 课程: "+u(n.effectiveGpa.course_count),1)])),_:1})):c("",!0),t(p,{class:"gpa-note"},{default:s((()=>[l("去重修补考，取最高成绩")])),_:1})])),_:1}),t(p,{class:"gpa-divider"}),t(p,{class:"main-gpa-item"},{default:s((()=>[t(p,{class:"gpa-label"},{default:s((()=>[l("基础GPA")])),_:1}),t(p,{class:"gpa-value"},{default:s((()=>[l(u(n.gpaAnalysis.basic_gpa.weighted_gpa),1)])),_:1}),t(p,{class:"gpa-detail"},{default:s((()=>[l(" 学分: "+u(n.gpaAnalysis.basic_gpa.total_credit)+" | 课程: "+u(n.gpaAnalysis.basic_gpa.course_count),1)])),_:1}),t(p,{class:"gpa-note"},{default:s((()=>[l("包含所有成绩")])),_:1})])),_:1})])),_:1}),t(p,{class:"total-courses"},{default:s((()=>[l("总课程数: "+u(n.totalCourses),1)])),_:1})])),_:1}),n.yearlyGpa?(e(),a(w,{key:0,title:"按学年GPA分析"},{default:s((()=>[t(p,{class:"yearly-gpa-container"},{default:s((()=>[(e(!0),d(o,null,i(n.yearlyGpa,((c,d)=>(e(),a(p,{key:d,class:"yearly-item"},{default:s((()=>[t(p,{class:"year-title"},{default:s((()=>[l(u(d)+"学年",1)])),_:2},1024),t(p,{class:"year-gpa"},{default:s((()=>[l(u(c.weighted_gpa),1)])),_:2},1024),t(p,{class:"year-detail"},{default:s((()=>[l(" 学分: "+u(c.total_credit)+" | 课程: "+u(c.course_count),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):c("",!0),n.semesterGpa?(e(),a(w,{key:1,title:"按学期GPA分析"},{default:s((()=>[t(p,{class:"semester-gpa-container"},{default:s((()=>[(e(!0),d(o,null,i(n.semesterGpa,((c,d)=>(e(),a(p,{key:d,class:"semester-item"},{default:s((()=>[t(p,{class:"semester-title"},{default:s((()=>[l(u(d),1)])),_:2},1024),t(p,{class:"semester-gpa"},{default:s((()=>[l(u(c.weighted_gpa),1)])),_:2},1024),t(p,{class:"semester-detail"},{default:s((()=>[l(" 学分: "+u(c.total_credit)+" | 课程: "+u(c.course_count),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):c("",!0)])),_:1})}},[["__scopeId","data-v-ec33fa78"]]),B=A({__name:"GradesList",props:{semesters:{type:Array,required:!0}},setup(p){const g=e=>{const a=parseFloat(e);return isNaN(a)?"grade-other":a>=90?"grade-excellent":a>=80?"grade-good":a>=70?"grade-fair":a>=60?"grade-pass":"grade-fail"},v=e=>{const a=parseFloat(e);return isNaN(a)?"score-other":a>=90?"score-excellent":a>=80?"score-good":a>=70?"score-fair":a>=60?"score-pass":"score-fail"};return(m,y)=>{const h=_,k=r,x=C(n("uni-icons"),P);return e(),a(k,{class:"grades-list"},{default:s((()=>[(e(!0),d(o,null,i(p.semesters,(r=>(e(),a(w,{key:r.semesterName,title:r.semesterName},{headerExtra:s((()=>[t(k,{class:"semester-stats"},{default:s((()=>[t(h,{class:"stats-text"},{default:s((()=>[l(u(r.grades.length)+"门课程",1)])),_:2},1024)])),_:2},1024)])),default:s((()=>[t(k,{class:"grades-grid"},{default:s((()=>[(e(!0),d(o,null,i(r.grades,(d=>(e(),a(k,{key:d.courseCode,class:f(["grade-item",g(d.score)])},{default:s((()=>[t(k,{class:"grade-header"},{default:s((()=>[t(h,{class:"course-name"},{default:s((()=>[l(u(d.courseName),1)])),_:2},1024),t(k,{class:f(["grade-score",v(d.score)])},{default:s((()=>[l(u(d.score),1)])),_:2},1032,["class"])])),_:2},1024),t(k,{class:"grade-details"},{default:s((()=>[t(k,{class:"detail-item"},{default:s((()=>[t(x,{type:"creditcard",size:"14",color:"#9b0400"}),t(h,null,{default:s((()=>[l(u(d.credit)+"学分",1)])),_:2},1024)])),_:2},1024),t(k,{class:"detail-item"},{default:s((()=>[t(x,{type:"star",size:"14",color:"#9b0400"}),t(h,null,{default:s((()=>[l(u(d.gpa)+"绩点",1)])),_:2},1024)])),_:2},1024),d.courseCode?(e(),a(k,{key:0,class:"detail-item"},{default:s((()=>[t(x,{type:"list",size:"14",color:"#9b0400"}),t(h,null,{default:s((()=>[l(u(d.courseCode),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1032,["title"])))),128))])),_:1})}}},[["__scopeId","data-v-249ca226"]]),F=A({__name:"index",setup(n){const A=p(!0),C=p([]),P=p(null),w=p(null),F=p(null),L=p(null),q=p(0),I=p(!1),R=p([]),S=p([]),D=p(!0),M=p(!1),U=p(null);N((()=>{$()})),j((()=>{if(!g("token"))return v({title:"请先登录",icon:"none"}),void m({url:"/pages/index/index"})}));const $=()=>{if(!g("token"))return v({title:"请先登录",icon:"none"}),void m({url:"/pages/index/index"});H()},H=async()=>{const e=g("token");if(!e)return v({title:"请先登录",icon:"none"}),void m({url:"/pages/index/index"});A.value=!0;try{const a=await y({url:`${h().globalData.apiBaseURL}/api/v1/grades`,method:"GET",header:{Authorization:"Bearer "+e}});if(200===a.statusCode&&a.data.success){const e=a.data.data,s=J(e);C.value=s,P.value=a.data.gpa_analysis,w.value=a.data.semester_gpa,F.value=a.data.yearly_gpa,L.value=a.data.effective_gpa,q.value=a.data.total_courses,R.value=e||[]}else{if(401===a.statusCode)return console.log("Token无效，清除缓存并跳转到登录页"),k("token"),v({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{m({url:"/pages/index/index"})}),1500);{const e=a.data.detail||"获取成绩失败";v({title:e,icon:"none"})}}}catch(a){console.error("请求失败",a),v({title:"服务器连接失败",icon:"none"})}finally{A.value=!1}},J=e=>{if(!e||0===e.length)return[];const a={};e.forEach((e=>{const s=e.semester;a[s]||(a[s]=[]),a[s].push(e)}));const s=Object.keys(a).map((e=>({semesterName:e,grades:a[e]})));return s.sort(((e,a)=>a.semesterName.localeCompare(e.semesterName))),s},K=()=>{I.value=!I.value,I.value&&(S.value=[],U.value=null)},Q=()=>{S.value=R.value.map(((e,a)=>a)),U.value=null},V=()=>{S.value=[],U.value=null},W=e=>{D.value=e.detail.value.includes("remove"),U.value=null},X=async()=>{const e=g("token");if(!e)return v({title:"请先登录",icon:"none"}),void m({url:"/pages/index/index"});M.value=!0;try{const a=await y({url:`${h().globalData.apiBaseURL}/api/v1/gpa/calculate`,method:"POST",header:{Authorization:"Bearer "+e,"Content-Type":"application/json"},data:{exclude_indices:S.value,remove_duplicates:D.value}});if(200===a.statusCode&&a.data.success)U.value=a.data.data,v({title:"GPA计算完成",icon:"success"});else{if(401===a.statusCode)return k("token"),v({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{m({url:"/pages/index/index"})}),1500);{const e=a.data.detail||"GPA计算失败";v({title:e,icon:"none"})}}}catch(a){console.error("GPA计算请求失败",a),v({title:"网络连接失败",icon:"none"})}finally{M.value=!1}};return(n,p)=>{const g=_,v=r,m=x,y=b,h=G;return e(),a(O,null,{default:s((()=>[A.value?(e(),a(z,{key:0,text:"正在从教务系统同步成绩..."})):(e(),a(v,{key:1,class:"page-rounded-container"},{default:s((()=>[0===C.value.length?(e(),a(E,{key:0,"icon-type":"info-filled",title:"没有查询到任何成绩记录",description:"请检查网络连接或稍后重试","show-retry":!0,onRetry:H})):(e(),a(v,{key:1},{default:s((()=>[P.value?(e(),a(T,{key:0,"gpa-analysis":P.value,"effective-gpa":L.value,"yearly-gpa":F.value,"semester-gpa":w.value,"total-courses":q.value},null,8,["gpa-analysis","effective-gpa","yearly-gpa","semester-gpa","total-courses"])):c("",!0),t(v,{class:"custom-gpa-section"},{default:s((()=>[t(v,{class:"custom-gpa-header",onClick:K},{default:s((()=>[t(v,{class:"header-left"},{default:s((()=>[t(g,{class:"custom-gpa-title"},{default:s((()=>[l("自定义GPA计算（有bug暂时不要用）")])),_:1}),t(g,{class:"custom-gpa-desc"},{default:s((()=>[l("排除指定课程重新计算GPA")])),_:1})])),_:1}),t(v,{class:"header-right"},{default:s((()=>[t(g,{class:f(["toggle-icon",{expanded:I.value}])},{default:s((()=>[l(u(I.value?"收起":"展开"),1)])),_:1},8,["class"])])),_:1})])),_:1}),I.value?(e(),a(v,{key:0,class:"custom-gpa-content"},{default:s((()=>[t(v,{class:"tip-section"},{default:s((()=>[t(v,{class:"tip-icon"},{default:s((()=>[l("⚠️")])),_:1}),t(g,{class:"tip-text"},{default:s((()=>[l("勾选的课程将被排除，不参与GPA计算")])),_:1})])),_:1}),t(v,{class:"options-section"},{default:s((()=>[t(v,{class:"option-item"},{default:s((()=>[t(y,{onChange:W},{default:s((()=>[t(m,{value:"remove",checked:D.value},null,8,["checked"]),t(g,{class:"option-text"},{default:s((()=>[l("去除重修补考记录（只保留最高成绩）")])),_:1})])),_:1})])),_:1})])),_:1}),t(v,{class:"courses-section"},{default:s((()=>[t(v,{class:"section-header"},{default:s((()=>[t(g,{class:"section-title"},{default:s((()=>[l("选择要排除的课程：")])),_:1}),t(v,{class:"selection-actions"},{default:s((()=>[t(g,{class:"action-btn",onClick:Q},{default:s((()=>[l("全选")])),_:1}),t(g,{class:"action-btn",onClick:V},{default:s((()=>[l("清空")])),_:1})])),_:1})])),_:1}),t(v,{class:"courses-grid"},{default:s((()=>[(e(!0),d(o,null,i(R.value,((c,d)=>(e(),a(v,{key:c.index||d,class:f(["course-card",{excluded:S.value.includes(d)}]),onClick:e=>(e=>{const a=S.value.indexOf(e);a>-1?S.value.splice(a,1):S.value.push(e),U.value=null})(d)},{default:s((()=>[t(v,{class:"course-checkbox"},{default:s((()=>[t(m,{value:d.toString(),checked:S.value.includes(d)},null,8,["value","checked"])])),_:2},1024),t(v,{class:"course-content"},{default:s((()=>[t(g,{class:"course-name"},{default:s((()=>[l(u(c.courseName),1)])),_:2},1024),t(v,{class:"course-info"},{default:s((()=>[t(g,{class:"info-item"},{default:s((()=>[l(u(c.credit)+"学分",1)])),_:2},1024),t(g,{class:"info-item grade"},{default:s((()=>[l(u(c.score),1)])),_:2},1024),t(g,{class:"info-item semester"},{default:s((()=>[l(u(c.semester),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),t(v,{class:"calculate-section"},{default:s((()=>[t(v,{class:"exclude-summary"},{default:s((()=>[t(g,{class:"summary-text"},{default:s((()=>[l(" 已选择排除 "+u(S.value.length)+" 门课程 ",1)])),_:1})])),_:1}),t(h,{class:"calculate-btn",onClick:X,disabled:M.value},{default:s((()=>[l(u(M.value?"计算中...":"重新计算GPA"),1)])),_:1},8,["disabled"])])),_:1}),U.value?(e(),a(v,{key:0,class:"result-section"},{default:s((()=>[t(v,{class:"result-header"},{default:s((()=>[t(g,{class:"result-title"},{default:s((()=>[l("自定义计算结果")])),_:1})])),_:1}),t(v,{class:"result-content"},{default:s((()=>[t(v,{class:"gpa-display"},{default:s((()=>[t(g,{class:"gpa-label"},{default:s((()=>[l("加权平均GPA")])),_:1}),t(g,{class:"gpa-value"},{default:s((()=>{var e;return[l(u((null==(e=U.value.weighted_gpa)?void 0:e.toFixed(2))||"0.00"),1)]})),_:1})])),_:1}),t(v,{class:"result-stats"},{default:s((()=>[t(v,{class:"stat-item"},{default:s((()=>[t(g,{class:"stat-label"},{default:s((()=>[l("总学分")])),_:1}),t(g,{class:"stat-value"},{default:s((()=>[l(u(U.value.total_credit||0),1)])),_:1})])),_:1}),t(v,{class:"stat-item"},{default:s((()=>[t(g,{class:"stat-label"},{default:s((()=>[l("课程数量")])),_:1}),t(g,{class:"stat-value"},{default:s((()=>[l(u(U.value.course_count||0),1)])),_:1})])),_:1}),t(v,{class:"stat-item"},{default:s((()=>[t(g,{class:"stat-label"},{default:s((()=>[l("排除课程")])),_:1}),t(g,{class:"stat-value"},{default:s((()=>[l(u(S.value.length),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):c("",!0)])),_:1})):c("",!0)])),_:1}),t(B,{semesters:C.value},null,8,["semesters"])])),_:1}))])),_:1}))])),_:1})}}},[["__scopeId","data-v-67e5483f"]]);export{F as default};
