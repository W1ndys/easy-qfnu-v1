var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{B as a,L as s,o as l,c as o,w as n,a as c,h as r,b as i,t as u,D as d,K as p,G as f,u as _,J as m,f as g,E as h,M as y,N as v,g as C,d as b,i as k,r as x,m as E,F as q,O as w,k as A,A as z,P as j,Q as P,n as L,q as M,R as F,e as I}from"./index-DgTWGBVP.js";import{_ as H,r as K,a as S,o as B,b as D}from"./uni-icons.0Jh3hA-I.js";import{d as R}from"./jwt-decode.CzqhIVxf.js";import{P as O}from"./PageLayout.BUxPNhUG.js";import{M as T}from"./ModernCard.BLieR9Pt.js";import{_ as Y}from"./uni-popup.B9RPNUAF.js";const N=H({__name:"ProfileCard",setup(e,{expose:x}){class E{static getCurrentUserKey(){const e=d("token");if(!e)return null;try{const t=R(e);return t.sub||t.user_id||t.id||e.substring(0,32)}catch(t){return e.substring(0,32)}}static save(e){try{const t=this.getCurrentUserKey();if(!t)return void console.warn("无法获取用户标识，跳过缓存");const a={profile:e,timestamp:Date.now(),version:"1.1",userKey:t,tokenHash:this.getTokenHash()};p(this.CACHE_KEY,JSON.stringify(a))}catch(t){console.error("缓存个人信息失败",t)}}static getTokenHash(){const e=d("token");if(!e)return null;let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return t.toString()}static get(){try{const e=d(this.CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return this.isExpired(t.timestamp)||this.userKeyChanged(t)||this.tokenChanged(t)?(this.clear(),null):t.profile}catch(e){return this.clear(),null}}static isExpired(e){return Date.now()-e>this.CACHE_EXPIRE_TIME}static userKeyChanged(e){return e.userKey!==this.getCurrentUserKey()}static tokenChanged(e){return e.tokenHash&&e.tokenHash!==this.getTokenHash()}static isValid(){const e=d(this.CACHE_KEY);if(!e)return!1;try{const t=JSON.parse(e);return!this.isExpired(t.timestamp)&&!this.userKeyChanged(t)&&!this.tokenChanged(t)}catch{return!1}}static clear(){f(this.CACHE_KEY)}static clearAll(){f(this.CACHE_KEY)}}t(E,"CACHE_KEY","user_profile_cache"),t(E,"CACHE_EXPIRE_TIME",18e5);const q=a({student_name:"W1ndys",student_id:"加载中...",college:"曲奇学院",major:"曲奇专业",class_name:"22曲奇班"}),w=a(!1),A=async()=>{const e=d("token");if(!e)return void console.warn("未找到登录凭证");w.value=!0;const t=_().globalData.apiBaseURL;try{const a=await new Promise(((a,s)=>{m({url:`${t}/api/v1/profile`,method:"GET",header:{Authorization:`Bearer ${e}`},success:a,fail:s})}));if(200===a.statusCode&&a.data.success){const t=a.data.data,s=t.student_id||(()=>{try{return R(e).sub}catch(t){return console.error("Token解析失败",t),q.value.student_id}})();q.value={student_name:t.student_name||q.value.student_name,student_id:s,college:t.college||q.value.college,major:t.major||q.value.major,class_name:t.class_name||q.value.class_name},E.save(q.value),console.log("用户资料获取成功",q.value)}else{const e=a.data.message||`获取信息失败 (${a.statusCode})`;console.error("获取用户资料失败",e),g({title:e,icon:"none"}),401===a.statusCode&&(f("token"),setTimeout((()=>{h({url:"/pages/index/index"})}),1500))}}catch(a){console.error("获取个人信息请求失败",a),g({title:"网络请求失败，请稍后重试",icon:"none"})}finally{w.value=!1}},z=()=>{if(!d("token"))return void E.clearAll();E.isValid()||E.clear();(()=>{const e=E.get();return!!e&&(q.value={...e},!0)})()?"W1ndys"!==q.value.student_name&&"加载中..."!==q.value.student_id||(console.log("缓存数据不完整，从服务器重新获取"),A()):(console.log("缓存不可用，从服务器获取个人信息"),A())};return s((()=>{z()})),x({refreshProfile:async()=>{y({title:"正在刷新..."});try{await A(),g({title:"资料已刷新",icon:"success"})}finally{v()}},fetchProfile:A,profile:q,clearProfile:E.clear,clearAllProfiles:E.clearAll}),(e,t)=>{const a=C,s=b,d=k;return l(),o(T,{class:"profile-card",highlight:""},{default:n((()=>[c(s,{class:r(["profile-content",{loading:w.value}])},{default:n((()=>[c(s,{class:"identity-section"},{default:n((()=>[c(s,{class:"avatar-wrapper"},{default:n((()=>[c(a,{class:"avatar",src:"https://pic1.zhimg.com/80/v2-82c1c70c69720aadac79594ea50ed4a7.png",mode:"aspectFit"}),c(s,{class:r(["status-indicator",{"loading-pulse":w.value}])},null,8,["class"])])),_:1}),c(s,{class:"identity-info"},{default:n((()=>[c(d,{class:"welcome-text"},{default:n((()=>[i("欢迎回来~")])),_:1}),c(d,{class:"user-name"},{default:n((()=>[i(u(q.value.student_name),1)])),_:1}),c(d,{class:"user-id"},{default:n((()=>[i(u(q.value.student_id),1)])),_:1})])),_:1})])),_:1}),c(s,{class:"details-section"},{default:n((()=>[c(s,{class:"detail-item"},{default:n((()=>[c(d,{class:"detail-label"},{default:n((()=>[i("学院")])),_:1}),c(d,{class:"detail-value"},{default:n((()=>[i(u(q.value.college),1)])),_:1})])),_:1}),c(s,{class:"detail-item"},{default:n((()=>[c(d,{class:"detail-label"},{default:n((()=>[i("专业")])),_:1}),c(d,{class:"detail-value"},{default:n((()=>[i(u(q.value.major),1)])),_:1})])),_:1}),c(s,{class:"detail-item"},{default:n((()=>[c(d,{class:"detail-label"},{default:n((()=>[i("班级")])),_:1}),c(d,{class:"detail-value"},{default:n((()=>[i(u(q.value.class_name),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["class"])])),_:1})}}},[["__scopeId","data-v-6f9f23fb"]]),G=H({__name:"NoticeBar",props:{noticeData:{type:Object,required:!0,default:()=>({title:"重要通知：请加用户群防走丢！"})}},emits:["click"],setup(e,{emit:t}){const a=t,s=()=>{a("click")};return(t,a)=>{const r=K(x("uni-icons"),S),d=k,p=b;return l(),o(p,{class:"notice-bar",onClick:s},{default:n((()=>[c(r,{class:"notice-icon",type:"sound",size:"20",color:"#FF6B35"}),c(d,{class:"notice-text"},{default:n((()=>[i(u(e.noticeData.title),1)])),_:1}),c(r,{type:"right",size:"16",color:"#C0C4CC"})])),_:1})}}},[["__scopeId","data-v-54a5bb78"]]),U=H({__name:"FeatureGrid",props:{features:{type:Array,required:!0,default:()=>[]}},emits:["navigate"],setup(e,{emit:t}){const a=t;return(t,s)=>{const d=b,p=K(x("uni-icons"),S),f=k;return l(),o(T,{class:"grid-card"},{default:n((()=>[c(d,{class:"grid-title"},{default:n((()=>[i("核心功能")])),_:1}),c(d,{class:"grid-2x2"},{default:n((()=>[(l(!0),E(q,null,w(e.features,((e,t)=>(l(),o(d,{key:t,class:r(["grid-cell",{disabled:!e.url}]),onClick:e=>(e=>{a("navigate",e)})(t)},{default:n((()=>[c(d,{class:"cell-icon"},{default:n((()=>[c(p,{type:e.icon,size:"30",color:e.url?"#7F4515":"#C0C6CF"},null,8,["type","color"])])),_:2},1024),c(f,{class:"cell-title"},{default:n((()=>[i(u(e.text),1)])),_:2},1024),e.description?(l(),o(f,{key:0,class:"cell-desc"},{default:n((()=>[i(u(e.description),1)])),_:2},1024)):A("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})}}},[["__scopeId","data-v-24c1381c"]]),J=H({__name:"SystemActions",emits:["refresh","logout","userAgreement","clearCache","changelog","contact","feedback","sponsorList","shareSite"],setup(e,{emit:t}){const a=t,s=()=>a("refresh"),r=()=>a("logout"),u=()=>a("userAgreement"),d=()=>a("clearCache"),p=()=>a("changelog"),f=()=>a("contact"),_=()=>a("feedback"),m=()=>a("sponsorList"),g=()=>a("shareSite");return(e,t)=>{const a=K(x("uni-icons"),S),h=k,y=z,v=b;return l(),o(T,{title:"系统操作"},{default:n((()=>[c(v,{class:"quick-actions"},{default:n((()=>[c(y,{class:"action-btn btn-primary",onClick:s},{default:n((()=>[c(a,{type:"refresh",size:"20"}),c(h,null,{default:n((()=>[i("刷新数据")])),_:1})])),_:1}),c(y,{class:"action-btn btn-danger",onClick:r},{default:n((()=>[c(a,{type:"closeempty",size:"20"}),c(h,null,{default:n((()=>[i("退出登录")])),_:1})])),_:1}),c(y,{class:"action-btn btn-secondary",onClick:u},{default:n((()=>[c(a,{type:"paperplane",size:"20"}),c(h,null,{default:n((()=>[i("用户协议")])),_:1})])),_:1}),c(y,{class:"action-btn btn-danger",onClick:d},{default:n((()=>[c(a,{type:"trash",size:"20"}),c(h,null,{default:n((()=>[i("清除缓存")])),_:1})])),_:1}),c(y,{class:"action-btn btn-secondary",onClick:p},{default:n((()=>[c(a,{type:"list",size:"20"}),c(h,null,{default:n((()=>[i("更新日志")])),_:1})])),_:1}),c(y,{class:"action-btn btn-secondary",onClick:f},{default:n((()=>[c(a,{type:"chatbubble",size:"20"}),c(h,null,{default:n((()=>[i("联系作者")])),_:1})])),_:1}),c(y,{class:"action-btn btn-secondary",onClick:_},{default:n((()=>[c(a,{type:"compose",size:"20"}),c(h,null,{default:n((()=>[i("意见建议")])),_:1})])),_:1}),c(y,{class:"action-btn btn-secondary",onClick:m},{default:n((()=>[c(a,{type:"heart",size:"20"}),c(h,null,{default:n((()=>[i("赞赏名单")])),_:1})])),_:1}),c(y,{class:"action-btn btn-secondary",onClick:g},{default:n((()=>[c(a,{type:"redo",size:"20"}),c(h,null,{default:n((()=>[i("分享本站")])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-73f5e998"]]),Q=H({__name:"SupportCard",emits:["imageError","imageLoad"],setup(e,{emit:t}){const a=t,s=()=>{a("imageError")},r=()=>{a("imageLoad")};return(e,t)=>{const a=k,u=b,d=C;return l(),o(T,{title:"支持开发",class:"support-card"},{default:n((()=>[c(u,{class:"support-content"},{default:n((()=>[c(u,{class:"support-text"},{default:n((()=>[c(a,{class:"support-title"},{default:n((()=>[i("助力项目发展")])),_:1}),c(a,{class:"support-desc"},{default:n((()=>[i("本服务完全免费使用，服务器每日支出约为7元左右（选课高峰期翻2-3倍），以及前期服务器设备等支出几百依赖作者个人支出。如果想支持作者助力开发维护，欢迎赞赏~")])),_:1})])),_:1}),c(u,{class:"qr-code-container"},{default:n((()=>[c(d,{class:"qr-code",src:"https://picx.zhimg.com/80/v2-076422270c197b0031c609e47be2e36c_720w.png?source=d16d100b",mode:"aspectFit",onError:s,onLoad:r}),c(a,{class:"qr-code-label"},{default:n((()=>[i("微信赞赏")])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-11f0144d"]]),V=H({__name:"NoticeModal",props:{noticeData:{type:Object,required:!0,default:()=>({content:"",version:"1"})}},emits:["close","popupChange"],setup(e,{expose:t,emit:s}){const r=s,u=a(null),d=()=>{u.value&&u.value.close()},p=e=>{r("popupChange",e)},f=()=>{window.open("https://qm.qq.com/q/jKCk6GtL1e","_blank")},_=()=>{window.open("https://qm.qq.com/q/BBYFdHBDEc","_blank")};return t({openModal:()=>{u.value&&u.value.open()},closeNoticeModal:d}),(t,a)=>{const s=k,r=K(x("uni-icons"),S),m=b,g=j,h=z,y=K(x("uni-popup"),Y);return l(),o(y,{ref_key:"noticePopup",ref:u,type:"center",onChange:p},{default:n((()=>[c(m,{class:"popup-content"},{default:n((()=>[c(m,{class:"popup-header"},{default:n((()=>[c(s,{class:"popup-title"},{default:n((()=>[i("公告详情")])),_:1}),c(m,{class:"popup-close-btn",onClick:d},{default:n((()=>[c(r,{type:"closeempty",size:"22",color:"#909399"})])),_:1})])),_:1}),c(m,{class:"popup-body"},{default:n((()=>[c(g,{class:"status-text",nodes:e.noticeData.content},null,8,["nodes"]),c(m,{class:"community-content-wrapper"},{default:n((()=>[c(m,{class:"community-groups"},{default:n((()=>[c(m,{class:"group-item"},{default:n((()=>[c(m,{class:"group-info"},{default:n((()=>[c(m,{class:"group-name"},{default:n((()=>[c(r,{type:"sound",size:"20",color:"#7F4515"}),c(s,{class:"group-title"},{default:n((()=>[i("官方消息群")])),_:1})])),_:1}),c(s,{class:"group-desc"},{default:n((()=>[i("获取最新消息和通知")])),_:1})])),_:1}),c(h,{class:"popup-action-btn",onClick:f},{default:n((()=>[c(r,{type:"copy",size:"16",color:"#7F4515"}),c(s,null,{default:n((()=>[i("加入群聊")])),_:1})])),_:1})])),_:1}),c(m,{class:"group-item"},{default:n((()=>[c(m,{class:"group-info"},{default:n((()=>[c(m,{class:"group-name"},{default:n((()=>[c(r,{type:"star",size:"20",color:"#7F4515"}),c(s,{class:"group-title"},{default:n((()=>[i("开发交流群")])),_:1})])),_:1}),c(s,{class:"group-desc"},{default:n((()=>[i("建议反馈、开发想法交流")])),_:1})])),_:1}),c(h,{class:"popup-action-btn",onClick:_},{default:n((()=>[c(r,{type:"copy",size:"16",color:"#7F4515"}),c(s,null,{default:n((()=>[i("加入群聊")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},512)}}},[["__scopeId","data-v-1f2ce7a2"]]),W=H({__name:"CalendarModal",emits:["imageError","imageLoad"],setup(e,{expose:t,emit:s}){const r=s,u=a(null),d=()=>{u.value&&u.value.close()},p=()=>{r("imageError")},f=()=>{r("imageLoad")};return t({openModal:()=>{u.value&&u.value.open()},closeCalendarModal:d}),(e,t)=>{const a=k,s=K(x("uni-icons"),S),r=b,_=C,m=K(x("uni-popup"),Y);return l(),o(m,{ref_key:"calendarPopup",ref:u,type:"center"},{default:n((()=>[c(r,{class:"popup-content calendar-popup"},{default:n((()=>[c(r,{class:"popup-header"},{default:n((()=>[c(a,{class:"popup-title"},{default:n((()=>[i("校历")])),_:1}),c(r,{class:"popup-close-btn",onClick:d},{default:n((()=>[c(s,{type:"closeempty",size:"22",color:"#909399"})])),_:1})])),_:1}),c(r,{class:"popup-body"},{default:n((()=>[c(_,{class:"calendar-image",src:"https://picx.zhimg.com/80/v2-1c7d66141af0cd26e90ab42dda86acee.png",mode:"widthFix",onError:p,onLoad:f})])),_:1})])),_:1})])),_:1},512)}}},[["__scopeId","data-v-ae9d0b01"]]),X=H({__name:"dashboard",setup(e){const t=a(null),s=a(null),r=a(null),i=a({version:"8",title:"重要通知：请加用户群防走丢！",content:'<div style="line-height: 1.6;">\n            <p style="margin-bottom: 16rpx;">我们新增了用户QQ群，欢迎加入</p>\n            <p style="margin-bottom: 16rpx;">后期很有可能会推出QQ号强绑定，需要加群使用，请尽快加群，群额度有限</p>\n            <p style="margin-bottom: 16rpx; color: red;">仪表盘下方新增了分享本站功能，欢迎分享给朋友</p>\n            <p style="margin-bottom: 16rpx;">时间紧张，本网站即将面临四个月的暂停开发，2025年12月后左右恢复开发进度</p>\n            <p style="margin-bottom: 16rpx; color: red;">开学快乐！</p>\n        </div>',timestamp:Date.now(),forceShow:!1}),u=()=>{t.value&&t.value.openModal()},_=e=>{e.show||p("notice_read_version",i.value.version)},m=a([{text:"今日课表",description:"bug修复中",icon:"calendar",url:""},{text:"成绩分析",description:"查看成绩与GPA分析",icon:"paperplane",url:"/pages/grades/grades"},{text:"平均分查询",description:"查看课程平均分数据",icon:"bars",url:"/pages/average-scores/average-scores"},{text:"选课推荐",description:"智能推荐选课方案",icon:"star",url:"https://doc.easy-qfnu.top/EasySelectCourse/CourseSelectionRecommendation/",external:!0},{text:"培养方案",description:"查看模块完成进度",icon:"list",url:"/pages/course-plan/course-plan"},{text:"选课查询",description:"支持选课模块探测",icon:"checkmarkempty",url:"/pages/pre-select-course/pre-select-course"},{text:"查看校历",description:"查看最新校历",icon:"calendar",url:"calendar",external:!1},{text:"无课教室",description:"查询空闲教室",icon:"home",url:""},{text:"无考教室",description:"查询无考试教室",icon:"compose",url:""},{text:"排名查询",description:"即将推出",icon:"medal",url:""},{text:"更多功能",description:"敬请期待",icon:"gear",url:""}]),y=()=>{const e=d("token");if(e)try{R(e)}catch(t){f("token"),h({url:"/pages/index/index"})}else h({url:"/pages/index/index"})},v=e=>{const t=m.value[e];"calendar"===t.url?s.value.openModal():t.external?E(t.url):t.url?L({url:t.url}):g({title:"功能正在开发中...",icon:"none"})},C=()=>{r.value&&r.value.refreshProfile()},k=()=>{M({title:"确认退出",content:"确定要退出登录吗？",success:e=>{e.confirm&&(f("token"),r.value&&r.value.clearAllProfiles(),h({url:"/pages/index/index"}))}})},x=()=>{M({title:"清除缓存",content:"确定要清除所有本地缓存数据吗？",success:e=>{if(e.confirm){const e=d("token");F(),e&&p("token",e),r.value&&r.value.clearProfile(),g({title:"缓存已清除",icon:"success"})}}})},E=e=>{"undefined"!=typeof window?window.open(e,"_blank"):"undefined"!=typeof plus?plus.runtime.openURL(e):I({data:e,success:()=>{g({title:"外链已复制,请在浏览器中打开",icon:"success",duration:3e3})}})},q=()=>E("https://cq4hqujcxu3.feishu.cn/docx/EYE6d5ufAoQt5Axx7MFc4XMrnAf"),w=()=>E("https://cq4hqujcxu3.feishu.cn/docx/BO2od7OI8omtmTxGkB0cn305nFl"),A=()=>E("https://qm.qq.com/q/WBCJEU82A2"),z=()=>E("https://cq4hqujcxu3.feishu.cn/share/base/form/shrcnojLq3xgJ5m5Gzn5V87poHZ"),j=()=>E("https://cq4hqujcxu3.feishu.cn/docx/DE9Ed1l5iofB0exEYZncwMeenvd"),H=()=>{I({data:"我发现一个超级好用的曲师大教务工具... https://easy-qfnu.top"})},K=()=>{},S=()=>{},T=()=>{},Y=()=>{};return B((()=>{y(),(()=>{const e=i.value,t=d("notice_read_version");(e.version!==t||e.forceShow)&&P((()=>u()))})()})),D((()=>{y()})),(e,a)=>{const d=b;return l(),o(d,{class:"user-profile-page-wrapper"},{default:n((()=>[c(O,null,{default:n((()=>[c(d,{class:"page-rounded-container"},{default:n((()=>[c(N,{ref_key:"profileCardRef",ref:r},null,512),c(G,{"notice-data":i.value,onClick:u},null,8,["notice-data"]),c(U,{features:m.value,onNavigate:v},null,8,["features"]),c(J,{onRefresh:C,onLogout:k,onUserAgreement:q,onClearCache:x,onChangelog:w,onContact:A,onFeedback:z,onSponsorList:j,onShareSite:H}),c(Q,{onImageError:K,onImageLoad:S})])),_:1})])),_:1}),c(V,{ref_key:"noticeModalRef",ref:t,"notice-data":i.value,onPopupChange:_},null,8,["notice-data"]),c(W,{ref_key:"calendarModalRef",ref:s,onImageError:T,onImageLoad:Y},null,512)])),_:1})}}},[["__scopeId","data-v-f25cf9d5"]]);export{X as default};
