import{B as e,Z as t,C as a,r as l,o as s,m as o,a as r,w as u,c as n,b as c,k as i,t as d,L as f,h as _,_ as m,F as y,N as p,d as v,A as g,i as k,a8 as h,a9 as w,j as D,M as b,aa as C,a6 as S,H as T,D as $,J as x,u as M,G as z,E,a4 as Y,f as I}from"./index-BC9OPIEN.js";import{_ as F,r as N,a as j,o as L,b as A}from"./uni-icons.DUOOEYbj.js";import{P as U}from"./PageLayout.B8X6suc2.js";import{M as R}from"./ModernCard.COoxP8kg.js";import{L as V,E as H}from"./EmptyState.BVxVqI9x.js";const B=F({__name:"DateSelector",props:{modelValue:{type:[String,Date],default:()=>new Date}},emits:["update:modelValue","change"],setup(D,{emit:b}){const C=D,S=b,{selectedDate:T,dateInfo:$,goToPreviousDay:x,goToNextDay:M,setDate:z,formatDate:E}=function(){const a=e(new Date),l=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,s=e=>["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][e.getDay()],o=t((()=>{const e=a.value;return{date:l(e),weekDay:s(e),month:e.getMonth()+1,day:e.getDate(),year:e.getFullYear()}}));return{selectedDate:a,dateInfo:o,goToPreviousDay:()=>{const e=new Date(a.value);e.setDate(e.getDate()-1),a.value=e},goToNextDay:()=>{const e=new Date(a.value);e.setDate(e.getDate()+1),a.value=e},setDate:e=>{a.value="string"==typeof e?new Date(e):e},goToToday:()=>{a.value=new Date},formatDate:l}}(),Y=e(!1),I=t((()=>{const e=new Date,t=T.value;return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()})),F=t((()=>{const e=(new Date).getFullYear(),t=e+5,a=[];for(let l=e-5;l<=t;l++)a.push(l);return a})),L=t((()=>{const e=[];for(let t=1;t<=12;t++)e.push(t);return e})),A=t((()=>{const e=U.value.getFullYear(),t=U.value.getMonth()+1,a=new Date(e,t,0).getDate(),l=[];for(let s=1;s<=a;s++)l.push(s);return l})),U=e(new Date),R=e([0,0,0]);a((()=>C.modelValue),(e=>{e&&z(e)}),{immediate:!0}),a(T,(e=>{S("update:modelValue",E(e)),S("change",{date:E(e),dateInfo:$.value})}),{immediate:!0});const V=()=>{x()},H=()=>{M()},B=()=>{U.value=new Date(T.value),(e=>{const t=F.value.findIndex((t=>t===e.getFullYear())),a=e.getMonth(),l=e.getDate()-1;R.value=[Math.max(0,t),Math.max(0,a),Math.max(0,l)]})(U.value),Y.value=!0},O=()=>{Y.value=!1},P=e=>{const[t,a,l]=e.detail.value;R.value=e.detail.value;const s=F.value[t],o=a+1,r=A.value[l];U.value=new Date(s,o-1,r)},G=()=>{z(U.value),O()};return(e,t)=>{const a=v,D=N(l("uni-icons"),j),b=g,C=k,S=h,T=w;return s(),o(y,null,[r(a,{class:"date-selector"},{default:u((()=>[I.value?(s(),n(a,{key:0,class:"today-indicator"},{default:u((()=>[c("今日")])),_:1})):i("",!0),r(a,{class:"date-header"},{default:u((()=>[r(a,{class:"date-navigation"},{default:u((()=>[r(b,{class:"nav-btn",onClick:V},{default:u((()=>[r(D,{type:"left",size:"20",color:"#495057"})])),_:1}),r(a,{class:"date-display",onClick:B},{default:u((()=>[r(a,{class:"main-date"},{default:u((()=>[c(d(f($).month)+"月"+d(f($).day)+"日 ",1)])),_:1}),r(a,{class:"date-detail"},{default:u((()=>[r(C,{class:"weekday"},{default:u((()=>[c(d(f($).weekDay),1)])),_:1}),r(C,null,{default:u((()=>[c("•")])),_:1}),r(C,null,{default:u((()=>[c(d(f($).year),1)])),_:1})])),_:1})])),_:1}),r(b,{class:"nav-btn",onClick:H},{default:u((()=>[r(D,{type:"right",size:"20",color:"#495057"})])),_:1})])),_:1}),r(b,{class:"date-picker-btn",onClick:B},{default:u((()=>[r(D,{type:"calendar",size:"16",color:"#ffffff"})])),_:1})])),_:1})])),_:1}),Y.value?(s(),n(a,{key:0,class:"date-picker-overlay",onClick:O},{default:u((()=>[r(a,{class:_(["date-picker-popup",{show:Y.value}]),onClick:t[0]||(t[0]=m((()=>{}),["stop"]))},{default:u((()=>[r(a,{class:"picker-header"},{default:u((()=>[r(C,{class:"picker-title"},{default:u((()=>[c("选择日期")])),_:1}),r(b,{class:"picker-close",onClick:O},{default:u((()=>[r(D,{type:"closeempty",size:"16",color:"#6c757d"})])),_:1})])),_:1}),r(T,{value:R.value,onChange:P,class:"date-picker-view"},{default:u((()=>[r(S,null,{default:u((()=>[(s(!0),o(y,null,p(F.value,((e,t)=>(s(),n(a,{key:t,class:"picker-item"},{default:u((()=>[c(d(e)+"年 ",1)])),_:2},1024)))),128))])),_:1}),r(S,null,{default:u((()=>[(s(!0),o(y,null,p(L.value,((e,t)=>(s(),n(a,{key:t,class:"picker-item"},{default:u((()=>[c(d(e)+"月 ",1)])),_:2},1024)))),128))])),_:1}),r(S,null,{default:u((()=>[(s(!0),o(y,null,p(A.value,((e,t)=>(s(),n(a,{key:t,class:"picker-item"},{default:u((()=>[c(d(e)+"日 ",1)])),_:2},1024)))),128))])),_:1})])),_:1},8,["value"]),r(a,{class:"picker-actions"},{default:u((()=>[r(b,{class:"picker-btn cancel",onClick:O},{default:u((()=>[c("取消")])),_:1}),r(b,{class:"picker-btn confirm",onClick:G},{default:u((()=>[c("确定")])),_:1})])),_:1})])),_:1},8,["class"])])),_:1})):i("",!0)],64)}}},[["__scopeId","data-v-6f3c0845"]]);const O=F({__name:"CourseCard",props:{course:{type:Object,default:null},currentTime:{type:String,default:""}},emits:["click"],setup(e,{emit:a}){const o=e,m=a,{timeDisplay:y,cardStyle:p,getTypeTagStyle:g,formatTeacher:h,formatClassName:w,formatLocation:b}=function(e){return{timeDisplay:t((()=>{var t;if(!(null==(t=e.course)?void 0:t.time_info))return"";const{period_name:a,start_time:l,end_time:s,time_slots:o}=e.course.time_info;return`${a} ${l}-${s}`})),cardStyle:t((()=>({background:"#ffffff",borderLeft:"4rpx solid #d4b896"}))),getTypeTagStyle:e=>({"必修":{background:"#ffebee",color:"#c62828"},"选修":{background:"#fff3e0",color:"#ef6c00"},"任选":{background:"#f3e5f5",color:"#7b1fa2"},"限选":{background:"#fff3e0",color:"#f57c00"},"实践":{background:"#e8f5e8",color:"#2e7d32"},"通识":{background:"#e3f2fd",color:"#1565c0"}}[e]||{background:"#f5f5f5",color:"#757575"}),formatTeacher:e=>e?e.split(",")[0].trim():"",formatClassName:e=>e?e.length>20?e.substring(0,20)+"...":e:"",formatLocation:e=>e?e.trim().replace(/\s+/g," "):""}}(o),C=t((()=>{var e;if(!(null==(e=o.course)?void 0:e.time_info)||!o.currentTime)return"";const{start_time:t,end_time:a}=o.course.time_info,l=o.currentTime;if(l>=t&&l<=a)return"current";if(l<t){const e=S(t),a=S(l);if(e-a<=30&&e-a>0)return"upcoming"}else if(l>a)return"finished";return""})),S=e=>{const[t,a]=e.split(":").map(Number);return 60*t+a},T=()=>{o.course&&m("click",o.course)};return(t,a)=>{const o=v,m=N(l("uni-icons"),j),h=k;return e.course?(s(),n(o,{key:0,class:_(["course-card",C.value]),style:D(f(p)),onClick:T},{default:u((()=>[r(o,{class:"course-header"},{default:u((()=>[r(o,{class:"course-title"},{default:u((()=>[c(d(e.course.name),1)])),_:1}),r(o,{class:"course-meta"},{default:u((()=>[r(o,{class:"time-info"},{default:u((()=>[r(m,{type:"clock",size:"16",color:"rgba(127,69,21,0.7)"}),r(h,null,{default:u((()=>[c(d(f(y)),1)])),_:1})])),_:1}),r(o,{class:"course-type-tag",style:D(f(g)(e.course.course_type))},{default:u((()=>[c(d(e.course.course_type),1)])),_:1},8,["style"])])),_:1})])),_:1}),r(o,{class:"course-body"},{default:u((()=>[r(o,{class:"course-details"},{default:u((()=>[r(o,{class:"detail-row"},{default:u((()=>[r(o,{class:"detail-icon"},{default:u((()=>[r(m,{type:"location",size:"16",color:"#6c757d"})])),_:1}),r(h,{class:"detail-text location"},{default:u((()=>[c(d(f(b)(e.course.location)),1)])),_:1})])),_:1}),e.course.class_name?(s(),n(o,{key:0,class:"detail-row"},{default:u((()=>[r(o,{class:"detail-icon"},{default:u((()=>[r(m,{type:"home",size:"16",color:"#495057"})])),_:1}),r(h,{class:"detail-text class-name"},{default:u((()=>[c(d(f(w)(e.course.class_name)),1)])),_:1})])),_:1})):i("",!0)])),_:1}),e.course.credits?(s(),n(o,{key:0,class:"credits-info"},{default:u((()=>[r(o,{class:"credits-label"},{default:u((()=>[r(m,{type:"star",size:"14",color:"#6c757d"}),r(h,null,{default:u((()=>[c("学分")])),_:1})])),_:1}),r(h,{class:"credits-value"},{default:u((()=>[c(d(e.course.credits),1)])),_:1})])),_:1})):i("",!0)])),_:1})])),_:1},8,["class","style"])):(s(),n(o,{key:1,class:"empty-course-card"},{default:u((()=>[r(o,{class:"empty-icon"},{default:u((()=>[r(m,{type:"calendar",size:"32",color:"#adb5bd"})])),_:1}),r(o,{class:"empty-title"},{default:u((()=>[c("暂无课程")])),_:1}),r(o,{class:"empty-desc"},{default:u((()=>[c("今天没有安排课程，好好休息吧！")])),_:1})])),_:1}))}}},[["__scopeId","data-v-87ba4b22"]]),P=F({__name:"DaySchedule",props:{selectedDate:{type:String,required:!0},courses:{type:Array,default:()=>[]},timeSlots:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["course-click"],setup(a,{emit:_}){const m=a,g=_,{currentTime:h,dayInfo:w,dayCourses:D,dayStats:T,isToday:$,timeSlots:x,freeTimeSlots:M,initTimeUpdate:z}=function(a){const l=e(""),s=()=>{const e=new Date,t=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0");l.value=`${t}:${a}`},o=t((()=>{if(!a.selectedDate)return null;const e=new Date(a.selectedDate),t=0===e.getDay()?7:e.getDay();return{date:a.selectedDate,weekday:t,weekdayName:n(t),formatDate:c(e)}})),r=t((()=>{if(!a.courses||!o.value)return[];const{weekday:e}=o.value;return a.courses.filter((t=>t.time_info&&t.time_info.weekday===e)).sort(((e,t)=>{var a,l;const s=(null==(a=e.time_info)?void 0:a.start_time)||"00:00",o=(null==(l=t.time_info)?void 0:l.start_time)||"00:00";return s.localeCompare(o)}))})),u=t((()=>{const e=r.value;if(0===e.length)return{totalCourses:0,totalHours:0,firstCourse:null,lastCourse:null,currentCourse:null,nextCourse:null};const t=e.reduce(((e,t)=>{var a;return e+((null==(a=t.time_info)?void 0:a.time_slots)||[]).length}),0),a=l.value,s=e.find((e=>{const{start_time:t,end_time:l}=e.time_info||{};return a>=t&&a<=l})),o=e.find((e=>{const{start_time:t}=e.time_info||{};return a<t}));return{totalCourses:e.length,totalHours:t,firstCourse:e[0],lastCourse:e[e.length-1],currentCourse:s,nextCourse:o}})),n=e=>({1:"星期一",2:"星期二",3:"星期三",4:"星期四",5:"星期五",6:"星期六",7:"星期日"}[e]||""),c=e=>{const t=e.getMonth()+1,a=e.getDate(),l=n(0===e.getDay()?7:e.getDay());return{month:t,day:a,weekday:l,full:`${t}月${a}日 ${l}`}},i=t((()=>{if(!a.selectedDate)return!1;const e=new Date,t=new Date(a.selectedDate);return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()})),d=t((()=>a.timeSlots?a.timeSlots.map((e=>{const t=r.value.filter((t=>{var a;return(null==(a=t.time_info)?void 0:a.period)===e.period}));return{...e,courses:t,isEmpty:0===t.length}})):[])),f=t((()=>d.value.filter((e=>e.isEmpty))));return{currentTime:l,dayInfo:o,dayCourses:r,dayStats:u,isToday:i,timeSlots:d,freeTimeSlots:f,initTimeUpdate:()=>(s(),setInterval(s,6e4)),updateCurrentTime:s,getWeekdayName:n,formatDisplayDate:c}}(m);let E=null;b((()=>{E=z()})),C((()=>{E&&clearInterval(E)}));const Y=(e,t)=>{if(0===t)return!0;const a=D.value[t-1];return!!(a&&e.time_info&&a.time_info)&&e.time_info.period!==a.time_info.period},I=e=>{g("course-click",{course:e,dayInfo:w.value,isToday:$.value})};return(e,t)=>{const _=k,m=v,g=N(l("uni-icons"),j);return s(),n(m,{class:"day-schedule"},{default:u((()=>[r(m,{class:"schedule-header"},{default:u((()=>[r(m,{class:"schedule-title"},{default:u((()=>{var e,t;return[c(d((null==(t=null==(e=f(w))?void 0:e.formatDate)?void 0:t.full)||"课程表")+" ",1),f($)?(s(),n(_,{key:0,class:"today-badge"},{default:u((()=>[c("今日")])),_:1})):i("",!0)]})),_:1}),r(m,{class:"schedule-stats"},{default:u((()=>[r(m,{class:"stat-item"},{default:u((()=>[r(g,{type:"calendar-filled",size:"16",color:"rgba(255,255,255,0.9)"}),r(_,null,{default:u((()=>[S("span",{class:"stat-value"},d(f(T).totalCourses),1),c(" 节课")])),_:1})])),_:1}),r(m,{class:"stat-item"},{default:u((()=>[r(g,{type:"clock-filled",size:"16",color:"rgba(255,255,255,0.9)"}),r(_,null,{default:u((()=>[S("span",{class:"stat-value"},d(f(T).totalHours),1),c(" 学时")])),_:1})])),_:1}),f($)&&f(h)?(s(),n(m,{key:0,class:"stat-item"},{default:u((()=>[r(g,{type:"pulse",size:"16",color:"rgba(255,255,255,0.9)"}),r(_,null,{default:u((()=>[c(d(f(h)),1)])),_:1})])),_:1})):i("",!0)])),_:1})])),_:1}),f(T).currentCourse?(s(),n(m,{key:0,class:"current-course-indicator"},{default:u((()=>[r(m,{class:"indicator-icon"},{default:u((()=>[r(g,{type:"play-filled",size:"16",color:"#ffffff"})])),_:1}),r(m,{class:"indicator-text"},{default:u((()=>[c(" 正在进行："+d(f(T).currentCourse.name),1)])),_:1}),r(m,{class:"indicator-time"},{default:u((()=>{var e;return[c(d(null==(e=f(T).currentCourse.time_info)?void 0:e.end_time)+" 结束 ",1)]})),_:1})])),_:1})):f(T).nextCourse&&f($)?(s(),n(m,{key:1,class:"next-course-indicator"},{default:u((()=>[r(m,{class:"indicator-icon"},{default:u((()=>[r(g,{type:"forward",size:"16",color:"#212529"})])),_:1}),r(m,{class:"indicator-text"},{default:u((()=>[c(" 下节课："+d(f(T).nextCourse.name),1)])),_:1}),r(m,{class:"indicator-time"},{default:u((()=>{var e;return[c(d(null==(e=f(T).nextCourse.time_info)?void 0:e.start_time)+" 开始 ",1)]})),_:1})])),_:1})):i("",!0),r(m,{class:"courses-container"},{default:u((()=>[f(D).length>0?(s(),n(m,{key:0,class:"courses-list"},{default:u((()=>[(s(!0),o(y,null,p(f(D),((e,t)=>(s(),o(y,{key:e.id},[Y(e,t)?(s(),n(m,{key:0,class:"time-slot-divider"},{default:u((()=>[r(m,{class:"divider-line"}),r(m,{class:"divider-label"},{default:u((()=>{var t;return[c(d(null==(t=e.time_info)?void 0:t.period_name),1)]})),_:2},1024),r(m,{class:"divider-line"})])),_:2},1024)):i("",!0),r(O,{course:e,"current-time":f(h),onClick:I},null,8,["course","current-time"])],64)))),128)),f(M).length>0&&f($)?(s(),n(m,{key:0,class:"free-time-notice"},{default:u((()=>[r(m,{class:"notice-icon"},{default:u((()=>[r(g,{type:"cup",size:"20",color:"#ffffff"})])),_:1}),r(m,{class:"notice-content"},{default:u((()=>[r(m,{class:"notice-title"},{default:u((()=>[c("空闲时间")])),_:1}),r(m,{class:"notice-desc"},{default:u((()=>[c(" 今天还有 "+d(f(M).length)+" 个时间段空闲，可以好好休息一下 ",1)])),_:1})])),_:1})])),_:1})):i("",!0)])),_:1})):(s(),n(m,{key:1,class:"empty-schedule"},{default:u((()=>[r(m,{class:"empty-icon"},{default:u((()=>[r(g,{type:"calendar",size:"48",color:"#adb5bd"})])),_:1}),r(m,{class:"empty-title"},{default:u((()=>[c(d(f($)?"今天":"当天")+"没有安排课程",1)])),_:1}),r(m,{class:"empty-desc"},{default:u((()=>[c(d(f($)?"好好享受这个美好的休息日吧！":"这天是个自由安排的日子"),1)])),_:1}),f($)?(s(),n(m,{key:0,class:"empty-suggestions"},{default:u((()=>[r(m,{class:"suggestion-item"},{default:u((()=>[r(g,{type:"star",size:"14",color:"#868e96"}),r(_,null,{default:u((()=>[c("可以复习之前的课程内容")])),_:1})])),_:1}),r(m,{class:"suggestion-item"},{default:u((()=>[r(g,{type:"heart",size:"14",color:"#868e96"}),r(_,null,{default:u((()=>[c("也可以预习明天的课程")])),_:1})])),_:1}),r(m,{class:"suggestion-item"},{default:u((()=>[r(g,{type:"smile",size:"14",color:"#868e96"}),r(_,null,{default:u((()=>[c("或者好好放松休息")])),_:1})])),_:1})])),_:1})):i("",!0)])),_:1}))])),_:1}),a.loading?(s(),n(m,{key:2,class:"schedule-loading"},{default:u((()=>[r(m,{class:"loading-spinner"}),r(_,{class:"loading-text"},{default:u((()=>[c("正在加载课程数据...")])),_:1})])),_:1})):i("",!0)])),_:1})}}},[["__scopeId","data-v-690e048a"]]),G={baseURL:null,endpoints:{classtable:"/api/v1/classtable"},timeout:1e4},q=e=>{const t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t},J=e=>{if(!e)return null;let t;if(t="string"==typeof e?new Date(e):e,isNaN(t.getTime()))throw new Error("无效的日期格式");return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},W=()=>[{period:1,name:"第一大节",time:"08:00-09:40",slots:[1,2]},{period:2,name:"第二大节",time:"10:00-11:40",slots:[3,4]},{period:3,name:"第三大节",time:"14:00-15:40",slots:[5,6]},{period:4,name:"第四大节",time:"16:00-17:40",slots:[7,8]},{period:5,name:"第五大节",time:"19:00-20:40",slots:[9,10]}],Z=()=>[{id:1,name:"星期一",short:"周一"},{id:2,name:"星期二",short:"周二"},{id:3,name:"星期三",short:"周三"},{id:4,name:"星期四",short:"周四"},{id:5,name:"星期五",short:"周五"},{id:6,name:"星期六",short:"周六"},{id:7,name:"星期日",short:"周日"}],K=async(e=null)=>{try{let t=null;if(e){if(!(e=>{if(!e)return!0;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);return t instanceof Date&&!isNaN(t.getTime())})(e))throw new Error("日期格式错误，请使用 YYYY-MM-DD 格式");t=J(e)}const a=$("token");if(!a)throw new Error("用户未登录");let l=`${G.baseURL||(G.baseURL=M().globalData.apiBaseURL),G.baseURL}${G.endpoints.classtable}`;t&&(l+=`?date=${t}`),console.log(`正在请求课程表数据: ${l}`);const s=await T({url:l,method:"GET",header:q(a),timeout:G.timeout}),{statusCode:o,data:r}=s;if(200===o){if(r.success||200===r.code)return console.log("课程表数据获取成功"),(e=>{var t;if(!e||!e.data)throw new Error("课程表数据格式错误");const{data:a}=e;a.courses&&Array.isArray(a.courses)||(console.warn("课程数据格式异常，使用空数组"),a.courses=[]),a.time_slots&&Array.isArray(a.time_slots)||(console.warn("时间段数据格式异常，使用默认配置"),a.time_slots=W()),a.weekdays&&Array.isArray(a.weekdays)||(console.warn("星期数据格式异常，使用默认配置"),a.weekdays=Z());const l=a.courses.map((e=>(e.id||(e.id=`course_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),e.time_info&&0===e.time_info.weekday&&(e.time_info.weekday=7),e.style||(e.style={color:"#7f4515",row:1,col:1,row_span:1,col_span:1}),e))),s={total_courses:l.length,total_hours:l.reduce(((e,t)=>{var a;return e+((null==(a=t.time_info)?void 0:a.time_slots)||[]).length}),0),courses_by_day:(null==(t=a.stats)?void 0:t.courses_by_day)||{}};return{...a,courses:l,stats:s,processed_at:(new Date).toISOString()}})(r);throw new Error(r.detail||r.message||"获取课程表失败")}{const e=((e,t,a="获取课程表")=>{let l=`${a}失败`;switch(e){case 400:l=t.detail||t.message||"请求参数错误";break;case 401:l="登录已过期，请重新登录",z("token"),setTimeout((()=>{E({url:"/pages/index/index"})}),1500);break;case 403:l="没有权限访问";break;case 404:l="服务不存在";break;case 422:l="请求数据格式错误";break;case 429:l="请求过于频繁，请稍后再试";break;case 500:l="服务器内部错误，请重新登录",z("token"),setTimeout((()=>{E({url:"/pages/index/index"})}),1500);break;case 502:case 503:case 504:l="服务暂时不可用，请稍后重试";break;default:l=t.detail||t.message||`${a}失败`}return{message:l,shouldRetry:[502,503,504,429].includes(e)}})(o,r,"获取课程表");throw new Error(e.message)}}catch(t){if(console.error("获取课程表失败:",t),t.errMsg){if(t.errMsg.includes("timeout"))throw new Error("请求超时，请检查网络连接");if(t.errMsg.includes("fail"))throw new Error("网络连接失败，请检查网络设置")}throw t}},Q="classtable_cache",X=6e5,ee=50,te=e=>{try{const t=$(Q)||{},a=J(e),l=t[a];return l&&Date.now()-l.timestamp<X?(console.log(`使用缓存的课程表数据: ${a}`),l.data):null}catch(t){return console.warn("读取课程表缓存失败:",t),null}},ae=F({__name:"classtable",setup(a){const o=e(!0),f=e(null),_=e(""),y=e(w(new Date)),p=e(null),h=e(!1);function w(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function D(){return!!$("token")||(I({title:"请先登录",icon:"none"}),E({url:"/pages/index/index"}),!1)}async function S(e=!0){e&&(o.value=!0),_.value="";try{const t=te(y.value);if(t&&e)return f.value=t,o.value=!1,void setTimeout((()=>{S(!1)}),100);console.log(`获取课程表数据: ${y.value}`);const a=await K(y.value);f.value=a,((e,t)=>{try{const a=$(Q)||{},l=J(e);a[l]={data:t,timestamp:Date.now()};const s=Date.now();Object.keys(a).forEach((e=>{s-a[e].timestamp>X&&delete a[e]}));const o=Object.keys(a);o.length>ee&&(o.sort(((e,t)=>a[e].timestamp-a[t].timestamp)),o.slice(0,o.length-ee).forEach((e=>{delete a[e]}))),x(Q,a),console.log(`课程表数据已缓存: ${l}`)}catch(_){console.warn("缓存课程表数据失败:",_)}})(y.value,a),console.log("课程表数据加载成功",a)}catch(t){console.error("获取课程表失败",t),_.value=t.message||"获取课程表失败";const a=te(y.value);a?(f.value=a,I({title:"已显示缓存数据，"+_.value,icon:"none",duration:3e3})):(f.value=null,e&&I({title:_.value,icon:"none"}))}finally{e&&(o.value=!1)}}function T(){S()}function M(e){console.log("日期改变:",e),y.value=e.date,S()}function z(e){console.log("课程点击:",e),p.value=e.course,I({title:`查看 ${e.course.name}`,icon:"none",duration:1e3})}function F(){p.value=null}return t((()=>!!f.value)),L((()=>{D()&&(Y({title:"课程表"}),S())})),A((()=>{if(!D())return;const e=w(new Date);if(y.value===e&&f.value){const e=f.value.processed_at;e&&Date.now()-new Date(e).getTime()>3e5&&S(!1)}})),b((()=>{})),C((()=>{})),(e,t)=>{const a=v,w=k,D=N(l("uni-icons"),j),b=g;return s(),n(U,null,{default:u((()=>[o.value?(s(),n(V,{key:0,text:"正在加载课程表数据..."})):(s(),n(a,{key:1,class:"page-container page-rounded-container"},{default:u((()=>[r(a,{class:"background-decoration"},{default:u((()=>[r(a,{class:"circle circle-1"}),r(a,{class:"circle circle-2"}),r(a,{class:"circle circle-3"})])),_:1}),r(a,{class:"page-header"},{default:u((()=>[r(a,{class:"header-content"},{default:u((()=>[r(w,{class:"page-title"},{default:u((()=>[c("课程表")])),_:1}),r(w,{class:"page-subtitle"},{default:u((()=>[c("Class Schedule")])),_:1})])),_:1})])),_:1}),r(a,{class:"content-wrapper"},{default:u((()=>{var e,l,m;return[r(B,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=e=>y.value=e),onChange:M},null,8,["modelValue"]),_.value&&!f.value?(s(),n(H,{key:0,"icon-type":"wifi-off",title:"加载失败",description:_.value,"show-retry":!0,onRetry:T},null,8,["description"])):(s(),n(P,{key:1,"selected-date":y.value,courses:(null==(e=f.value)?void 0:e.courses)||[],"time-slots":(null==(l=f.value)?void 0:l.time_slots)||[],loading:o.value,onCourseClick:z},null,8,["selected-date","courses","time-slots","loading"])),h.value&&(null==(m=f.value)?void 0:m.stats)?(s(),n(R,{key:2,title:"本周统计",class:"stats-card"},{default:u((()=>[r(a,{class:"stats-grid"},{default:u((()=>[r(a,{class:"stat-item"},{default:u((()=>[r(w,{class:"stat-value"},{default:u((()=>[c(d(f.value.stats.total_courses),1)])),_:1}),r(w,{class:"stat-label"},{default:u((()=>[c("总课程数")])),_:1})])),_:1}),r(a,{class:"stat-item"},{default:u((()=>[r(w,{class:"stat-value"},{default:u((()=>[c(d(f.value.stats.total_hours),1)])),_:1}),r(w,{class:"stat-label"},{default:u((()=>[c("总学时")])),_:1})])),_:1})])),_:1})])),_:1})):i("",!0)]})),_:1})])),_:1})),p.value?(s(),n(a,{key:2,class:"course-detail-modal",onClick:F},{default:u((()=>[r(a,{class:"modal-content",onClick:t[1]||(t[1]=m((()=>{}),["stop"]))},{default:u((()=>[r(a,{class:"modal-header"},{default:u((()=>[r(w,{class:"modal-title"},{default:u((()=>[c(d(p.value.name),1)])),_:1}),r(b,{class:"modal-close",onClick:F},{default:u((()=>[r(D,{type:"closeempty",size:"20",color:"#6c757d"})])),_:1})])),_:1}),r(a,{class:"modal-body"},{default:u((()=>[r(a,{class:"detail-section"},{default:u((()=>[r(a,{class:"section-title"},{default:u((()=>[c("课程信息")])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("任课教师：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.teacher),1)])),_:1})])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("上课地点：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.location),1)])),_:1})])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("课程类型：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.course_type),1)])),_:1})])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("学分：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.credits),1)])),_:1})])),_:1}),p.value.class_name?(s(),n(a,{key:0,class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("上课班级：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.class_name),1)])),_:1})])),_:1})):i("",!0)])),_:1}),p.value.time_info?(s(),n(a,{key:0,class:"detail-section"},{default:u((()=>[r(a,{class:"section-title"},{default:u((()=>[c("时间安排")])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("上课时间：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.time_info.weekday_name)+" "+d(p.value.time_info.period_name),1)])),_:1})])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("具体时段：")])),_:1}),r(w,{class:"value"},{default:u((()=>[c(d(p.value.time_info.start_time)+" - "+d(p.value.time_info.end_time),1)])),_:1})])),_:1}),r(a,{class:"detail-row"},{default:u((()=>[r(w,{class:"label"},{default:u((()=>[c("上课周次：")])),_:1}),r(w,{class:"value"},{default:u((()=>{var e;return[c("第"+d((null==(e=p.value.weeks)?void 0:e.join("、"))||"未知")+"周",1)]})),_:1})])),_:1})])),_:1})):i("",!0)])),_:1}),r(a,{class:"modal-footer"},{default:u((()=>[r(b,{class:"modal-btn",onClick:F},{default:u((()=>[c("确定")])),_:1})])),_:1})])),_:1})])),_:1})):i("",!0)])),_:1})}}},[["__scopeId","data-v-96ab4370"]]);export{ae as default};
