var e=Object.defineProperty,t=(t,s,a)=>(((t,s,a)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a})(t,"symbol"!=typeof s?s+"":s,a),a);import{J as s,D as a,G as o,B as l,u as n,H as r,f as i,E as c,$ as u,a0 as d}from"./index-DNZRe5Ot.js";import{d as g}from"./jwt-decode.Cq8nstY0.js";class f{static save(e){try{const t={profile:e,timestamp:Date.now(),version:"1.0"};s(this.CACHE_KEY,JSON.stringify(t)),console.log("个人信息已缓存",e)}catch(t){console.error("缓存个人信息失败",t)}}static get(){try{const e=a(this.CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return this.isExpired(t.timestamp)?(console.log("个人信息缓存已过期，清除缓存"),this.clear(),null):(console.log("从缓存读取个人信息",t.profile),t.profile)}catch(e){return console.error("读取个人信息缓存失败",e),this.clear(),null}}static isExpired(e){return Date.now()-e>this.CACHE_EXPIRE_TIME}static clear(){try{o(this.CACHE_KEY),console.log("个人信息缓存已清除")}catch(e){console.error("清除个人信息缓存失败",e)}}static update(e){const t=this.get();if(t){const s={...t,...e};return this.save(s),s}return null}static isValid(){try{const e=a(this.CACHE_KEY);if(!e)return!1;const t=JSON.parse(e);return!this.isExpired(t.timestamp)}catch(e){return!1}}}t(f,"CACHE_KEY","user_profile_cache"),t(f,"CACHE_EXPIRE_TIME",18e5);const m={getCachedProfile:()=>f.get(),getStudentId(){const e=f.get();return e?e.student_id:null},getStudentName(){const e=f.get();return e?e.student_name:null},getCollege(){const e=f.get();return e?e.college:null},getMajor(){const e=f.get();return e?e.major:null},getClassName(){const e=f.get();return e?e.class_name:null},isProfileAvailable:()=>f.isValid(),clearProfile(){f.clear()}};function h(){const e=l({student_name:"W1ndys",student_id:"加载中...",college:"曲奇学院",major:"曲奇专业",class_name:"22曲奇班"}),t=l(!1),s=()=>{const t=f.get();return!!t&&(e.value={...t},console.log("从缓存加载个人信息成功",e.value),!0)},m=async()=>{const s=a("token");if(!s)return void console.warn("未找到登录凭证");t.value=!0;const l=n().globalData.apiBaseURL;try{const a=await new Promise(((e,t)=>{r({url:`${l}/api/v1/profile`,method:"GET",header:{Authorization:`Bearer ${s}`},success:e,fail:t})}));if(200===a.statusCode&&a.data.success){const t=a.data.data,o=t.student_id||(()=>{try{return g(s).sub}catch(t){return console.error("Token解析失败",t),e.value.student_id}})();e.value={student_name:t.student_name||e.value.student_name,student_id:o,college:t.college||e.value.college,major:t.major||e.value.major,class_name:t.class_name||e.value.class_name},f.save(e.value),console.log("用户资料获取成功",e.value)}else{const e=a.data.message||`获取信息失败 (${a.statusCode})`;console.error("获取用户资料失败",e),i({title:e,icon:"none"}),401===a.statusCode&&(o("token"),setTimeout((()=>{c({url:"/pages/index/index"})}),1500))}}catch(u){console.error("获取个人信息请求失败",u),i({title:"网络请求失败，请稍后重试",icon:"none"})}finally{t.value=!1}};return{profile:e,loading:t,fetchProfile:m,refreshProfile:async()=>{u({title:"正在刷新..."});try{await m(),i({title:"资料已刷新",icon:"success"})}finally{d()}},initProfile:()=>{if(a("token")){s()?"W1ndys"!==e.value.student_name&&"加载中..."!==e.value.student_id||(console.log("缓存数据不完整，从服务器重新获取"),m()):(console.log("缓存不可用，从服务器获取个人信息"),m())}},forceRefreshProfile:async()=>{console.log("强制刷新个人信息"),f.clear(),await m()},loadFromCache:s,clearProfileCache:f.clear,getCachedProfile:f.get,isProfileCacheValid:f.isValid}}export{m as P,h as u};
