var e=Object.defineProperty,t=(t,s,r)=>(((t,s,r)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r})(t,"symbol"!=typeof s?s+"":s,r),r);import{D as s,J as r,G as a,B as n,u as o,H as l,f as c,E as i,Z as u,_ as h}from"./index-D7H84Z3a.js";import{d}from"./jwt-decode.DgGI4-tx.js";class g{static getCurrentUserKey(){const e=s("token");if(!e)return null;try{const t=d(e);return t.sub||t.user_id||t.id||e.substring(0,32)}catch(t){return e.substring(0,32)}}static save(e){try{const t=this.getCurrentUserKey();if(!t)return void console.warn("无法获取用户标识，跳过缓存");const s={profile:e,timestamp:Date.now(),version:"1.1",userKey:t,tokenHash:this.getTokenHash()};r(this.CACHE_KEY,JSON.stringify(s)),console.log("个人信息已缓存",{user:t,profile:e})}catch(t){console.error("缓存个人信息失败",t)}}static getTokenHash(){const e=s("token");if(!e)return null;let t=0;for(let s=0;s<e.length;s++){t=(t<<5)-t+e.charCodeAt(s),t&=t}return t.toString()}static get(){try{const e=s(this.CACHE_KEY);if(!e)return null;const t=JSON.parse(e);if(this.isExpired(t.timestamp))return console.log("个人信息缓存已过期，清除缓存"),this.clear(),null;const r=this.getCurrentUserKey();if(!r||t.userKey!==r)return console.log("缓存用户不匹配，清除旧缓存",{cached:t.userKey,current:r}),this.clear(),null;const a=this.getTokenHash();return t.tokenHash&&t.tokenHash!==a?(console.log("Token已变化，清除缓存"),this.clear(),null):(console.log("从缓存读取个人信息",t.profile),t.profile)}catch(e){return console.error("读取个人信息缓存失败",e),this.clear(),null}}static isExpired(e){return Date.now()-e>this.CACHE_EXPIRE_TIME}static clear(){try{a(this.CACHE_KEY),console.log("个人信息缓存已清除")}catch(e){console.error("清除个人信息缓存失败",e)}}static update(e){const t=this.get();if(t){const s={...t,...e};return this.save(s),s}return null}static isValid(){try{const e=s(this.CACHE_KEY);if(!e)return!1;const t=JSON.parse(e);if(this.isExpired(t.timestamp))return!1;const r=this.getCurrentUserKey();if(!r||t.userKey!==r)return!1;const a=this.getTokenHash();return!t.tokenHash||t.tokenHash===a}catch(e){return!1}}static clearAll(){try{a(this.CACHE_KEY),console.log("所有用户的个人信息缓存已清除")}catch(e){console.error("清除缓存失败",e)}}}t(g,"CACHE_KEY","user_profile_cache"),t(g,"CACHE_EXPIRE_TIME",18e5);const f={getCachedProfile:()=>g.get(),getStudentId(){const e=g.get();return e?e.student_id:null},getStudentName(){const e=g.get();return e?e.student_name:null},getCollege(){const e=g.get();return e?e.college:null},getMajor(){const e=g.get();return e?e.major:null},getClassName(){const e=g.get();return e?e.class_name:null},isProfileAvailable:()=>g.isValid(),clearProfile(){g.clear()},clearAllProfiles(){g.clearAll()},validateAndCleanCache:()=>s("token")?!!g.isValid()||(g.clear(),!1):(g.clearAll(),!1),getCacheDebugInfo(){const e=s("user_profile_cache");if(!e)return{status:"no_cache",message:"没有缓存数据"};try{const t=JSON.parse(e),s=g.getCurrentUserKey(),r=g.getTokenHash();return{status:"has_cache",cacheUserKey:t.userKey,currentUserKey:s,cacheTokenHash:t.tokenHash,currentTokenHash:r,isExpired:g.isExpired(t.timestamp),isValid:g.isValid(),timestamp:new Date(t.timestamp).toLocaleString(),version:t.version}}catch(t){return{status:"error",message:"缓存数据损坏",error:t.message}}}};function m(){const e=n({student_name:"W1ndys",student_id:"加载中...",college:"曲奇学院",major:"曲奇专业",class_name:"22曲奇班"}),t=n(!1),r=()=>{const t=g.get();return!!t&&(e.value={...t},console.log("从缓存加载个人信息成功",e.value),!0)},m=async()=>{const r=s("token");if(!r)return void console.warn("未找到登录凭证");t.value=!0;const n=o().globalData.apiBaseURL;try{const s=await new Promise(((e,t)=>{l({url:`${n}/api/v1/profile`,method:"GET",header:{Authorization:`Bearer ${r}`},success:e,fail:t})}));if(200===s.statusCode&&s.data.success){const t=s.data.data,a=t.student_id||(()=>{try{return d(r).sub}catch(t){return console.error("Token解析失败",t),e.value.student_id}})();e.value={student_name:t.student_name||e.value.student_name,student_id:a,college:t.college||e.value.college,major:t.major||e.value.major,class_name:t.class_name||e.value.class_name},g.save(e.value),console.log("用户资料获取成功",e.value)}else{const e=s.data.message||`获取信息失败 (${s.statusCode})`;console.error("获取用户资料失败",e),c({title:e,icon:"none"}),401===s.statusCode&&(a("token"),setTimeout((()=>{i({url:"/pages/index/index"})}),1500))}}catch(u){console.error("获取个人信息请求失败",u),c({title:"网络请求失败，请稍后重试",icon:"none"})}finally{t.value=!1}};return{profile:e,loading:t,fetchProfile:m,refreshProfile:async()=>{u({title:"正在刷新..."});try{await m(),c({title:"资料已刷新",icon:"success"})}finally{h()}},initProfile:()=>{if(!s("token"))return void g.clearAll();f.validateAndCleanCache();r()?"W1ndys"!==e.value.student_name&&"加载中..."!==e.value.student_id||(console.log("缓存数据不完整，从服务器重新获取"),m()):(console.log("缓存不可用，从服务器获取个人信息"),m())},forceRefreshProfile:async()=>{console.log("强制刷新个人信息"),g.clear(),await m()},loadFromCache:r,clearProfileCache:g.clear,getCachedProfile:g.get,isProfileCacheValid:g.isValid,getCacheDebugInfo:f.getCacheDebugInfo}}export{f as P,m as u};
