import{p as e,Y as a,q as t,s as l,u as s,x as u,z as o,l as r,v as c,r as n,c as i,w as d,o as f,a as _,j as m,n as v,t as p,d as h,b as g,f as y,P as b,F as x,Z as k,A as w,k as C,g as N,J as z,_ as $,B as j}from"./index-BtlZHxYj.js";import{_ as M,o as A,b as q,c as B,r as E,a as D}from"./uni-app.es.D07pM_46.js";import{P as T}from"./PageLayout.C2BaD--Z.js";import{M as L}from"./ModernCard.BUdm3G5B.js";import{L as S,E as F}from"./EmptyState.AlL-OWvg.js";const O=M({__name:"index",setup(M){const O=e(!0),P=e([]),R=e([]),Y=e(!1),U=e(null),G=e(null),I=a((()=>{const e=(new Date).getFullYear();return Array.from({length:5},((a,t)=>String(e-t)))})),J=a((()=>I.value.indexOf(String(U.value)))),Z=e("cache"),H=e(""),K=e(!1),Q=a((()=>[...P.value].sort(((e,a)=>{const t=oe(e),l=oe(a);return t&&!l?-1:!t&&l?1:0})).map((e=>{const a=oe(e);return{...e,courses:[...e.courses||[]].sort(((e,t)=>{const l=se(e),s=se(t);if(a){if(!l&&s)return-1;if(l&&!s)return 1;if(!l&&!s){const a=ue(e),l=ue(t);if(a&&!l)return-1;if(!a&&l)return 1}}else{if(l&&!s)return-1;if(!l&&s)return 1}const u=Number(e.semester)||0,o=Number(t.semester)||0;return u!==o?o-u:0}))}}))));A((async()=>{const e=t("enrollmentYear");e&&(U.value=e,await W(e)),V()})),q((()=>{t("token")||(l({title:"请先登录",icon:"none"}),s({url:"/pages/index/index"}))})),B((async()=>{if(!t("token"))return l({title:"请先登录",icon:"none"}),s({url:"/pages/index/index"}),void u();await ee(!0),u()}));const V=()=>{if(!t("token"))return l({title:"请先登录",icon:"none"}),void s({url:"/pages/index/index"});X()},W=async e=>{var a,s;if(e)try{const l=t("token"),u=await o({url:`${r().globalData.apiBaseURL}/api/v1/semester-info/${e}`,method:"GET",header:{Authorization:"Bearer "+l}});if(200!==u.statusCode||!(null==(a=u.data)?void 0:a.success))throw new Error((null==(s=u.data)?void 0:s.message)||"获取学期信息失败");G.value=u.data.data.current_semester}catch(u){console.error("获取当前学期失败",u),l({title:u.message||"获取学期信息失败",icon:"none"}),G.value=null}else G.value=null},X=async()=>{var e,a,u;const n=t("token");if(!n)return l({title:"请先登录",icon:"none"}),void s({url:"/pages/index/index"});O.value=!0;try{const t=await o({url:`${r().globalData.apiBaseURL}/api/v1/course-plan`,method:"GET",header:{Authorization:"Bearer "+n}});let i=null;if(200!==t.statusCode){if(401===t.statusCode)return c("token"),l({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>s({url:"/pages/index/index"})),1500);{const e=(null==(a=t.data)?void 0:a.detail)||(null==(u=t.data)?void 0:u.message)||"未知错误";throw new Error(`请求错误：${t.statusCode} - ${e}`)}}if((null==(e=t.data)?void 0:e.success)?(i=t.data.data,Z.value=t.data.source||"cache",H.value=t.data.updated_at||"","live"!==Z.value||K.value||l({title:"已获取最新数据",icon:"success",duration:2e3})):i=t.data,!i||!Array.isArray(i.modules))return l({title:"培养方案格式异常",icon:"none"}),void(P.value=[]);P.value=i.modules,R.value=P.value.map((()=>!1)),P.value.length>0&&te()}catch(i){console.error("获取培养方案失败",i),l({title:i.message||"获取培养方案失败，请稍后重试",icon:"none",duration:2e3})}finally{O.value=!1}},ee=async(e=!1)=>{var a,u,n;const i=t("token");if(!i)return l({title:"请先登录",icon:"none"}),void s({url:"/pages/index/index"});K.value=!0,e||(O.value=!0);try{const t=await o({url:`${r().globalData.apiBaseURL}/api/v1/course-plan/refresh`,method:"POST",header:{Authorization:"Bearer "+i}});if(200===t.statusCode&&(null==(a=t.data)?void 0:a.success))await X(),l({title:"数据已刷新",icon:"success",duration:2e3});else{if(401!==t.statusCode)throw new Error((null==(u=t.data)?void 0:u.detail)||(null==(n=t.data)?void 0:n.message)||"刷新失败");c("token"),l({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>s({url:"/pages/index/index"})),1500)}}catch(d){console.error("刷新缓存失败",d),l({title:d.message||"刷新失败，请稍后重试",icon:"none",duration:2e3})}finally{K.value=!1,e||(O.value=!1)}},ae=e=>{if(!e)return"未知";try{const a=new Date(e),t=new Date-a,l=Math.floor(t/864e5),s=Math.floor(t/36e5),u=Math.floor(t/6e4);return l>0?`${l}天前`:s>0?`${s}小时前`:u>0?`${u}分钟前`:"刚刚"}catch(a){return"未知"}},te=()=>{setTimeout((()=>{Y.value=!0}),500)},le=e=>P.value.findIndex((a=>a.module_name===e.module_name)),se=e=>{var a;return!!(null==(a=e.completion_status)?void 0:a.includes("已修"))},ue=e=>{if(!e.semester||!G.value)return!1;const a=Number(e.semester);return a<=G.value&&a%2==G.value%2},oe=e=>(Number(null==e?void 0:e.completed_credits)||0)<(Number(null==e?void 0:e.required_credits)||0),re=e=>{const a=Number(null==e?void 0:e.required_credits)||0,t=Number(null==e?void 0:e.completed_credits)||0;return a<=0?0:Math.min(100,Math.max(0,Math.round(t/a*100)))},ce=e=>{var a;return(null==(a=e.courses)?void 0:a.length)?e.courses.filter(se).reduce(((e,a)=>{if(a.hours&&"object"==typeof a.hours)for(const[t,l]of Object.entries(a.hours))e[t]=(e[t]||0)+(Number(l)||0);return e}),{}):{total:0}},ne=e=>{if(!e||"object"!=typeof e)return[];const a={lecture:"讲授",practice:"实践",seminar:"研讨",experiment:"实验",design:"设计",computer:"上机",discussion:"讨论",extracurricular:"课外",online:"在线"};return Object.entries(e).filter((([e,a])=>"total"!==e&&Number(a)>0)).map((([e,t])=>`${a[e]||e}: ${t}`))},ie=e=>{const a=Number(e);return isNaN(a)?"0":a%1==0?String(a):a.toFixed(1)},de=a((()=>P.value.reduce(((e,a)=>e+(Number(a.required_credits)||0)),0))),fe=a((()=>P.value.reduce(((e,a)=>e+(Number(a.completed_credits)||0)),0))),_e=a((()=>de.value<=0?0:Math.min(100,Math.max(0,Math.round(fe.value/de.value*100))))),me=a((()=>fe.value<de.value)),ve=async e=>{const a=I.value[e.detail.value];U.value=a,w("enrollmentYear",a),await W(a),l({title:`学籍已设置为 ${a} 级`,icon:"none"})},pe=()=>{Y.value=!1},he=()=>{Y.value=!1};return(e,a)=>{const t=E(n("uni-icons"),D),s=C,u=N,o=z,r=$;return f(),i(T,null,{default:d((()=>[O.value?(f(),i(S,{key:0,text:"正在获取培养方案..."})):(f(),i(u,{key:1,class:"page-rounded-container"},{default:d((()=>[0===P.value.length?(f(),i(F,{key:0,"icon-type":"info-filled",title:"暂无培养方案数据",description:"请稍后重试或下拉刷新","show-retry":!0,onRetry:X})):(f(),i(u,{key:1},{default:d((()=>[_(L,{title:"数据状态",class:"data-status-card"},{default:d((()=>[_(u,{class:"data-status-container"},{default:d((()=>[_(u,{class:"status-info"},{default:d((()=>[_(u,{class:"status-item"},{default:d((()=>[_(t,{type:"cloud",size:"20",color:"live"===Z.value?"#52c41a":"#1890ff"},null,8,["color"]),_(s,{class:"status-label"},{default:d((()=>[m("数据来源:")])),_:1}),_(s,{class:v(["status-value","live"===Z.value?"status-live":"status-cache"])},{default:d((()=>[m(p("live"===Z.value?"实时获取":"缓存数据"),1)])),_:1},8,["class"])])),_:1}),H.value?(f(),i(u,{key:0,class:"status-item"},{default:d((()=>[_(t,{type:"calendar",size:"20",color:"#666"}),_(s,{class:"status-label"},{default:d((()=>[m("更新时间:")])),_:1}),_(s,{class:"status-value"},{default:d((()=>[m(p(ae(H.value)),1)])),_:1})])),_:1})):h("",!0)])),_:1}),_(u,{class:"refresh-actions"},{default:d((()=>[_(o,{class:v(["refresh-btn",{loading:K.value}]),disabled:K.value,onClick:ee},{default:d((()=>[_(t,{type:"refresh",size:"18",color:"#1890ff",class:v({spinning:K.value})},null,8,["class"]),_(s,null,{default:d((()=>[m(p(K.value?"刷新中...":"刷新数据"),1)])),_:1})])),_:1},8,["class","disabled"])])),_:1})])),_:1})])),_:1}),_(L,{title:"学籍设置",class:"settings-card"},{default:d((()=>[_(u,{class:"enrollment-notice"},{default:d((()=>[_(t,{type:"info",size:"16",color:"#1890ff"}),_(s,{class:"notice-text"},{default:d((()=>[m("入伍、留级等学生请选择你所在班级的入学年份")])),_:1})])),_:1}),_(u,{class:"setting-item"},{default:d((()=>[_(s,{class:"setting-label"},{default:d((()=>[m("入学年份:")])),_:1}),_(r,{mode:"selector",range:I.value,value:J.value,onChange:ve},{default:d((()=>[_(u,{class:"picker-value"},{default:d((()=>[_(s,null,{default:d((()=>[m(p(U.value||"请选择"),1)])),_:1}),_(t,{type:"bottom",size:"16",color:"#666"})])),_:1})])),_:1},8,["range","value"])])),_:1}),_(u,{class:"setting-item"},{default:d((()=>[_(s,{class:"setting-label"},{default:d((()=>[m("当前学期:")])),_:1}),_(s,{class:"setting-value"},{default:d((()=>[m(p(G.value?`第 ${G.value} 学期`:"请先选择入学年份"),1)])),_:1})])),_:1})])),_:1}),_(L,{title:"总学分进度",class:"total-progress-card"},{default:d((()=>[_(u,{class:"total-progress-container"},{default:d((()=>[_(u,{class:"total-header"},{default:d((()=>[_(u,{class:"total-title-section"},{default:d((()=>[_(s,{class:"total-title"},{default:d((()=>[m("培养方案总进度")])),_:1}),_(u,{class:v(["status-chip",me.value?"chip-module-incomplete":"chip-module-complete"])},{default:d((()=>[_(s,null,{default:d((()=>[m(p(me.value?"未修满":"已修满"),1)])),_:1})])),_:1},8,["class"])])),_:1}),_(u,{class:"total-credits-info"},{default:d((()=>[_(s,{class:"total-credits-text"},{default:d((()=>[m(p(ie(fe.value))+"/"+p(ie(de.value))+" 学分",1)])),_:1}),me.value?(f(),i(s,{key:0,class:"total-shortage-text"},{default:d((()=>[m("差 "+p(ie(de.value-fe.value))+" 学分",1)])),_:1})):h("",!0)])),_:1}),_(u,{class:"total-progress-bar-container"},{default:d((()=>[_(u,{class:"progress-bar total-progress-bar"},{default:d((()=>[_(u,{class:v(["progress-fill",{danger:me.value}]),style:g({width:_e.value+"%"})},null,8,["style","class"])])),_:1}),_(s,{class:"progress-text total-progress-text"},{default:d((()=>[m(p(_e.value)+"%",1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),_(L,{title:"培养方案模块"},{default:d((()=>[_(u,{class:"modules-list"},{default:d((()=>[(f(!0),y(x,null,b(Q.value,((e,a)=>(f(),i(u,{key:e.module_name,class:v(["module-card",{incomplete:oe(e),expanded:R.value[le(e)]}])},{default:d((()=>[_(u,{class:"module-header",onClick:a=>{return t=le(e),void(R.value[t]=!R.value[t]);var t}},{default:d((()=>[_(u,{class:"header-info"},{default:d((()=>[_(u,{class:"header-top"},{default:d((()=>[_(s,{class:"module-title"},{default:d((()=>[m(p(e.module_name),1)])),_:2},1024),_(u,{class:v(["status-chip",oe(e)?"chip-module-incomplete":"chip-module-complete"])},{default:d((()=>[_(s,null,{default:d((()=>[m(p(oe(e)?"未修满":"已修满"),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),_(u,{class:"header-middle"},{default:d((()=>[_(u,{class:"credits-info"},{default:d((()=>[_(s,{class:"credits-text"},{default:d((()=>[m(p(ie(e.completed_credits))+"/"+p(ie(e.required_credits))+" 学分",1)])),_:2},1024),_(s,{class:"course-count-text"},{default:d((()=>[m("共 "+p((e.courses||[]).length)+" 门课程",1)])),_:2},1024),oe(e)?(f(),i(s,{key:0,class:"shortage-text"},{default:d((()=>[m("差 "+p(ie(Number(e.required_credits)-Number(e.completed_credits)))+" 学分",1)])),_:2},1024)):h("",!0)])),_:2},1024),_(u,{class:"expand-action"},{default:d((()=>[R.value[le(e)]?(f(),i(s,{key:1,class:"hint-text"},{default:d((()=>[m("点击收起")])),_:1})):(f(),i(s,{key:0,class:"hint-text"},{default:d((()=>[m("点击展开")])),_:1})),_(t,{class:v(["chevron-icon",{expanded:R.value[le(e)]}]),type:"arrowdown",size:"20",color:"#7F4515"},null,8,["class"])])),_:2},1024)])),_:2},1024),_(u,{class:"progress-container"},{default:d((()=>[_(u,{class:"progress-bar"},{default:d((()=>[_(u,{class:v(["progress-fill",{danger:oe(e)}]),style:g({width:re(e)+"%"})},null,8,["style","class"])])),_:2},1024),_(s,{class:"progress-text"},{default:d((()=>[m(p(re(e))+"%",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),_(u,{class:"course-details"},{default:d((()=>[e.subtotal?(f(),i(u,{key:0,class:"module-subtotal"},{default:d((()=>[_(s,{class:"subtotal-title"},{default:d((()=>[m("模块要求小计")])),_:1}),_(s,{class:"subtotal-credits"},{default:d((()=>[m("要求学分 "+p(e.subtotal.total_credits),1)])),_:2},1024),_(s,{class:"subtotal-hours"},{default:d((()=>{var a;return[m("要求总学时 "+p((null==(a=e.subtotal.hours)?void 0:a.total)||0),1)]})),_:2},1024),_(u,{class:"subtotal-divider"}),_(s,{class:"subtotal-title"},{default:d((()=>[m("已修课程小计")])),_:1}),_(u,{class:"subtotal-completed-group"},{default:d((()=>[_(s,{class:"subtotal-hours"},{default:d((()=>[m(" 已修总学时 "+p(ce(e).total||0),1)])),_:2},1024),(f(!0),y(x,null,b(ne(ce(e)),(e=>(f(),i(s,{key:e,class:"subtotal-meta"},{default:d((()=>[m(p(e),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)):h("",!0),_(u,{class:"course-sort-hint"},{default:d((()=>[_(s,{class:"sort-hint-text"},{default:d((()=>[_(t,{type:"info",size:"16",color:"#666"}),m(" "+p(oe(e)?"未修课程已置顶显示，本学期课程优先":"已修课程已置顶显示"),1)])),_:2},1024)])),_:2},1024),_(u,{class:"course-list"},{default:d((()=>[(f(!0),y(x,null,b(e.courses||[],(e=>(f(),i(u,{key:(e.course_code||"")+(e.course_name||""),class:v(["course-item",{completed:se(e)}])},{default:d((()=>[_(u,{class:"course-main"},{default:d((()=>[_(u,{class:"course-title-section"},{default:d((()=>[_(u,{class:"course-name-wrapper"},{default:d((()=>[_(s,{class:"course-name"},{default:d((()=>[m(p(e.course_name),1)])),_:2},1024),ue(e)&&!se(e)?(f(),i(s,{key:0,class:"current-semester-tag"},{default:d((()=>[m("本学期可选")])),_:1})):h("",!0)])),_:2},1024),e.course_code?(f(),i(s,{key:0,class:"course-code",onClick:k((a=>{var t;(t=e.course_code)&&j({data:t,success:()=>l({title:"课程代码已复制",icon:"none"})})}),["stop"])},{default:d((()=>[m("代码: "+p(e.course_code),1)])),_:2},1032,["onClick"])):h("",!0)])),_:2},1024),_(u,{class:"chips"},{default:d((()=>[_(s,{class:v(["chip completion-chip",se(e)?"chip-completed":"chip-incomplete"])},{default:d((()=>[m(p(e.completion_status||"未修"),1)])),_:2},1032,["class"]),e.course_nature?(f(),i(s,{key:0,class:"chip chip-neutral"},{default:d((()=>[m(p(e.course_nature),1)])),_:2},1024)):h("",!0),e.course_attribute?(f(),i(s,{key:1,class:"chip chip-neutral"},{default:d((()=>[m(p(e.course_attribute),1)])),_:2},1024)):h("",!0)])),_:2},1024)])),_:2},1024),_(u,{class:"course-meta"},{default:d((()=>{var a;return[_(s,{class:"meta"},{default:d((()=>[m("学分 "+p(e.credits),1)])),_:2},1024),e.semester?(f(),i(s,{key:0,class:"meta"},{default:d((()=>[m("学期 "+p(e.semester),1)])),_:2},1024)):h("",!0),(null==(a=e.hours)?void 0:a.total)?(f(),i(s,{key:1,class:"meta"},{default:d((()=>[m("总学时 "+p(e.hours.total),1)])),_:2},1024)):h("",!0),(f(!0),y(x,null,b(ne(e.hours),(e=>(f(),i(s,{key:e,class:"meta"},{default:d((()=>[m(p(e),1)])),_:2},1024)))),128))]})),_:2},1024)])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1})])),_:1})])),_:1}))])),_:1})),Y.value?(f(),i(u,{key:2,class:"modal-overlay",onClick:he},{default:d((()=>[_(u,{class:"modal-container",onClick:a[0]||(a[0]=k((()=>{}),["stop"]))},{default:d((()=>[_(u,{class:"modal-header"},{default:d((()=>[_(t,{type:"info-filled",size:"24",color:"#1890ff"}),_(s,{class:"modal-title"},{default:d((()=>[m("培养方案说明")])),_:1})])),_:1}),_(u,{class:"modal-content"},{default:d((()=>[_(s,{class:"notice-text"},{default:d((()=>[m(" 本页面由教务系统培养方案表格直接生成，大部分专业的应修是160或170或175，该培养方案总和大部分都不足够（22级是），少的那些分就是你应该选的公选课的分。如果不够，请及时与对应负责老师沟通。 ")])),_:1}),_(s,{class:"notice-text",style:{"margin-top":"24rpx"}},{default:d((()=>[m(" 根据教务处官方规定：培养方案毕业学分原则上145-170学分，其中人文社会科学类专业毕业学分≤160学分，理科类专业毕业学分≤165学分，工科类专业毕业学分≤170学分，辅修学士学位专业毕业学分70学分左右。 ")])),_:1}),_(s,{class:"notice-text",style:{"margin-top":"16rpx","font-size":"24rpx",color:"#8c8c8c"}},{default:d((()=>[m(" 来源：https://jwc.qfnu.edu.cn/info/1068/7039.htm ")])),_:1})])),_:1}),_(u,{class:"modal-actions"},{default:d((()=>[_(o,{class:"action-btn primary-btn",onClick:pe,style:{"background-color":"#834A1A",color:"white"}},{default:d((()=>[m("我已阅读")])),_:1})])),_:1})])),_:1})])),_:1})):h("",!0)])),_:1})}}},[["__scopeId","data-v-887fb725"]]);export{O as default};
