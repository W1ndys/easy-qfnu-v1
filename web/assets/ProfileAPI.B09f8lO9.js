var e=Object.defineProperty,t=(t,r,s)=>(((t,r,s)=>{r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s})(t,"symbol"!=typeof r?r+"":r,s),s);import{D as r,K as s,G as n}from"./index-D8yv_xul.js";import{d as i}from"./jwt-decode.B4TtOsy8.js";class a{static getCurrentUserKey(){const e=r("token");if(!e)return null;try{const t=i(e);return t.sub||t.user_id||t.id||e.substring(0,32)}catch(t){return e.substring(0,32)}}static save(e){try{const t=this.getCurrentUserKey();if(!t)return void console.warn("无法获取用户标识，跳过缓存");const r={profile:e,timestamp:Date.now(),version:"1.1",userKey:t,tokenHash:this.getTokenHash()};s(this.CACHE_KEY,JSON.stringify(r))}catch(t){console.error("缓存个人信息失败",t)}}static getTokenHash(){const e=r("token");if(!e)return null;let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return t.toString()}static get(){try{const e=r(this.CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return this.isExpired(t.timestamp)||this.userKeyChanged(t)||this.tokenChanged(t)?(this.clear(),null):t.profile}catch(e){return this.clear(),null}}static isExpired(e){return Date.now()-e>this.CACHE_EXPIRE_TIME}static userKeyChanged(e){return e.userKey!==this.getCurrentUserKey()}static tokenChanged(e){return e.tokenHash&&e.tokenHash!==this.getTokenHash()}static isValid(){const e=r(this.CACHE_KEY);if(!e)return!1;try{const t=JSON.parse(e);return!this.isExpired(t.timestamp)&&!this.userKeyChanged(t)&&!this.tokenChanged(t)}catch{return!1}}static clear(){n(this.CACHE_KEY)}static clearAll(){n(this.CACHE_KEY)}}t(a,"CACHE_KEY","user_profile_cache"),t(a,"CACHE_EXPIRE_TIME",18e5);const o={isProfileAvailable:()=>a.isValid(),getProfile:()=>a.get(),getStudentId:()=>{var e;return(null==(e=a.get())?void 0:e.student_id)||"加载中..."},getStudentName:()=>{var e;return(null==(e=a.get())?void 0:e.student_name)||"W1ndys"},getCollege:()=>{var e;return(null==(e=a.get())?void 0:e.college)||"曲奇学院"},getMajor:()=>{var e;return(null==(e=a.get())?void 0:e.major)||"曲奇专业"},getClassName:()=>{var e;return(null==(e=a.get())?void 0:e.class_name)||"22曲奇班"},saveProfile:e=>a.save(e),clearProfile:()=>a.clear()};export{a as P,o as a};
