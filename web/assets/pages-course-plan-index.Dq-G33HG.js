import{p as e,P as t,q as a,s,u as l,x as o,z as u,l as r,v as c,r as n,c as i,w as d,o as f,a as _,j as m,n as p,t as v,d as h,b as y,f as b,K as g,F as x,Q as k,k as w,g as N,J as C,B as M}from"./index-DKYs8gGt.js";import{_ as $,o as j,b as z,c as q,r as E,a as B}from"./uni-app.es.qT0Pi9gi.js";import{P as T,M as A}from"./ModernCard.Cz8bg0YJ.js";import{L as D,E as F}from"./EmptyState.CfGXD9SX.js";const L=$({__name:"index",setup($){const L=e(!0),O=e([]),P=e([]),R=e(!1),S=e("cache"),I=e(""),U=e(!1),G=t((()=>[...O.value].sort(((e,t)=>{const a=Z(e),s=Z(t);return a&&!s?-1:!a&&s?1:0})).map((e=>{const t=Z(e);return{...e,courses:[...e.courses||[]].sort(((e,a)=>{const s=X(e),l=X(a);if(t){if(!s&&l)return-1;if(s&&!l)return 1;if(!s&&!l){const t=Y(e),s=Y(a);if(t&&!s)return-1;if(!t&&s)return 1}}else{if(s&&!l)return-1;if(!s&&l)return 1}const o=Number(e.semester)||0,u=Number(a.semester)||0;return o!==u?u-o:0}))}}))));j((()=>{J()})),z((()=>{if(!a("token"))return s({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"})})),q((async()=>{if(!a("token"))return s({title:"请先登录",icon:"none"}),l({url:"/pages/index/index"}),void o();await K(),o()}));const J=()=>{if(!a("token"))return s({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"});K()},K=async()=>{var e,t,o;const n=a("token");if(!n)return s({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"});L.value=!0;try{const a=await u({url:`${r().globalData.apiBaseURL}/api/v1/course-plan`,method:"GET",header:{Authorization:"Bearer "+n}});let i=null;if(200!==a.statusCode){if(401===a.statusCode)return console.error("身份验证失败，请重新登录"),c("token"),s({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{l({url:"/pages/index/index"})}),1500);if(404===a.statusCode)return console.error("未找到培养方案数据"),void s({title:"未找到培养方案数据",icon:"none"});{const e=(null==(t=a.data)?void 0:t.detail)||(null==(o=a.data)?void 0:o.message)||"未知错误";throw console.error(`请求错误：${a.statusCode}`,a.data,e),new Error(`请求错误：${a.statusCode} - ${e}`)}}if((null==(e=a.data)?void 0:e.success)?(i=a.data.data,S.value=a.data.source||"cache",I.value=a.data.updated_at||"","live"===S.value&&s({title:"已获取最新数据",icon:"success",duration:2e3})):i=a.data,console.log("培养方案数据获取成功",i),!i)throw new Error("无有效数据");if(!Array.isArray(i.modules))return console.warn("返回的培养方案格式异常",i),s({title:"培养方案格式异常",icon:"none"}),void(O.value=[]);O.value=i.modules,console.log(`成功加载了${O.value.length}个培养方案模块`),P.value=O.value.map((()=>!1)),0===O.value.length?s({title:"暂无培养方案数据",icon:"none"}):V()}catch(i){console.error("获取培养方案失败",i),s({title:i.message||"获取培养方案失败，请稍后重试",icon:"none",duration:2e3})}finally{L.value=!1}},Q=async()=>{var e,t;const o=a("token");if(!o)return s({title:"请先登录",icon:"none"}),void l({url:"/pages/index/index"});U.value=!0;try{const a=await u({url:`${r().globalData.apiBaseURL}/api/v1/course-plan/refresh`,method:"POST",header:{Authorization:"Bearer "+o}});if(200!==a.statusCode){if(401===a.statusCode)return c("token"),s({title:"登录已过期，请重新登录",icon:"none"}),void setTimeout((()=>{l({url:"/pages/index/index"})}),1500);{const s=(null==(e=a.data)?void 0:e.detail)||(null==(t=a.data)?void 0:t.message)||"刷新失败";throw new Error(s)}}console.log("缓存刷新成功",a.data),await K(),s({title:"数据已刷新",icon:"success",duration:2e3})}catch(n){console.error("刷新缓存失败",n),s({title:n.message||"刷新失败，请稍后重试",icon:"none",duration:2e3})}finally{U.value=!1}},H=e=>{if(!e)return"未知";try{const t=new Date(e),a=new Date-t,s=Math.floor(a/864e5),l=Math.floor(a/36e5),o=Math.floor(a/6e4);return s>0?`${s}天前`:l>0?`${l}小时前`:o>0?`${o}分钟前`:"刚刚"}catch(t){return console.error("时间格式化失败",t),"未知"}},V=()=>{setTimeout((()=>{R.value=!0}),500)},W=e=>O.value.findIndex((t=>t.module_name===e.module_name)),X=e=>!!e.completion_status&&e.completion_status.includes("已修"),Y=e=>{if(!e.semester)return!1;const t=Number(e.semester);return t<=7&&t%2==1},Z=e=>{const t=Number(null==e?void 0:e.required_credits)||0;return(Number(null==e?void 0:e.completed_credits)||0)<t},ee=e=>{const t=Number(null==e?void 0:e.required_credits)||0,a=Number(null==e?void 0:e.completed_credits)||0;if(t<=0)return 0;return Math.min(100,Math.max(0,Math.round(a/t*100)))},te=e=>{if(!e.courses||0===e.courses.length)return{total:0};return e.courses.filter(X).reduce(((e,t)=>{if(t.hours&&"object"==typeof t.hours)for(const[a,s]of Object.entries(t.hours))e[a]=(e[a]||0)+(Number(s)||0);return e}),{})},ae=e=>{if(!e||"object"!=typeof e)return[];const t={lecture:"讲授",practice:"实践",seminar:"研讨",experiment:"实验",design:"设计",computer:"上机",discussion:"讨论",extracurricular:"课外",online:"在线"};return Object.entries(e).filter((([e,t])=>"total"!==e&&Number(t)>0)).map((([e,a])=>`${t[e]||e}: ${a}`))},se=e=>{const t=Number(e);return Number.isNaN(t)?"0":t%1==0?String(t):t.toFixed(1)},le=t((()=>O.value.reduce(((e,t)=>e+(Number(t.required_credits)||0)),0))),oe=t((()=>O.value.reduce(((e,t)=>e+(Number(t.completed_credits)||0)),0))),ue=t((()=>{if(le.value<=0)return 0;return Math.min(100,Math.max(0,Math.round(oe.value/le.value*100)))})),re=t((()=>oe.value<le.value)),ce=()=>{R.value=!1},ne=()=>{R.value=!1};return(e,t)=>{const a=E(n("uni-icons"),B),l=w,o=N,u=C;return f(),i(T,null,{default:d((()=>[L.value?(f(),i(D,{key:0,text:"正在获取培养方案..."})):(f(),i(o,{key:1,class:"page-rounded-container"},{default:d((()=>[0===O.value.length?(f(),i(F,{key:0,"icon-type":"info-filled",title:"暂无培养方案数据",description:"请稍后重试或下拉刷新","show-retry":!0,onRetry:K})):(f(),i(o,{key:1},{default:d((()=>[_(A,{title:"数据状态",class:"data-status-card"},{default:d((()=>[_(o,{class:"data-status-container"},{default:d((()=>[_(o,{class:"status-info"},{default:d((()=>[_(o,{class:"status-item"},{default:d((()=>[_(a,{type:"cloud",size:"20",color:"live"===S.value?"#52c41a":"#1890ff"},null,8,["color"]),_(l,{class:"status-label"},{default:d((()=>[m("数据来源:")])),_:1}),_(l,{class:p(["status-value","live"===S.value?"status-live":"status-cache"])},{default:d((()=>[m(v("live"===S.value?"实时获取":"缓存数据"),1)])),_:1},8,["class"])])),_:1}),I.value?(f(),i(o,{key:0,class:"status-item"},{default:d((()=>[_(a,{type:"calendar",size:"20",color:"#666"}),_(l,{class:"status-label"},{default:d((()=>[m("更新时间:")])),_:1}),_(l,{class:"status-value"},{default:d((()=>[m(v(H(I.value)),1)])),_:1})])),_:1})):h("",!0)])),_:1}),_(o,{class:"refresh-actions"},{default:d((()=>[_(u,{class:p(["refresh-btn",{loading:U.value}]),disabled:U.value,onClick:Q},{default:d((()=>[_(a,{type:"refresh",size:"18",color:"#1890ff",class:p({spinning:U.value})},null,8,["class"]),_(l,null,{default:d((()=>[m(v(U.value?"刷新中...":"刷新数据"),1)])),_:1})])),_:1},8,["class","disabled"])])),_:1})])),_:1})])),_:1}),_(A,{title:"总学分进度",class:"total-progress-card"},{default:d((()=>[_(o,{class:"total-progress-container"},{default:d((()=>[_(o,{class:"total-header"},{default:d((()=>[_(o,{class:"total-title-section"},{default:d((()=>[_(l,{class:"total-title"},{default:d((()=>[m("培养方案总进度")])),_:1}),_(o,{class:p(["status-chip",re.value?"chip-module-incomplete":"chip-module-complete"])},{default:d((()=>[_(l,null,{default:d((()=>[m(v(re.value?"未修满":"已修满"),1)])),_:1})])),_:1},8,["class"])])),_:1}),_(o,{class:"total-credits-info"},{default:d((()=>[_(l,{class:"total-credits-text"},{default:d((()=>[m(v(se(oe.value))+"/"+v(se(le.value))+" 学分",1)])),_:1}),re.value?(f(),i(l,{key:0,class:"total-shortage-text"},{default:d((()=>[m("差 "+v(se(le.value-oe.value))+" 学分",1)])),_:1})):h("",!0)])),_:1}),_(o,{class:"total-progress-bar-container"},{default:d((()=>[_(o,{class:"progress-bar total-progress-bar"},{default:d((()=>[_(o,{class:p(["progress-fill",{danger:re.value}]),style:y({width:ue.value+"%"})},null,8,["style","class"])])),_:1}),_(l,{class:"progress-text total-progress-text"},{default:d((()=>[m(v(ue.value)+"%",1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),_(A,{title:"培养方案模块"},{default:d((()=>[_(o,{class:"modules-list"},{default:d((()=>[(f(!0),b(x,null,g(G.value,((e,t)=>(f(),i(o,{key:e.module_name,class:p(["module-card",{incomplete:Z(e),expanded:P.value[W(e)]}])},{default:d((()=>[_(o,{class:"module-header",onClick:t=>{return a=W(e),void(P.value[a]=!P.value[a]);var a}},{default:d((()=>[_(o,{class:"header-info"},{default:d((()=>[_(o,{class:"header-top"},{default:d((()=>[_(l,{class:"module-title"},{default:d((()=>[m(v(e.module_name),1)])),_:2},1024),_(o,{class:p(["status-chip",Z(e)?"chip-module-incomplete":"chip-module-complete"])},{default:d((()=>[_(l,null,{default:d((()=>[m(v(Z(e)?"未修满":"已修满"),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),_(o,{class:"header-middle"},{default:d((()=>[_(o,{class:"credits-info"},{default:d((()=>[_(l,{class:"credits-text"},{default:d((()=>[m(v(se(e.completed_credits))+"/"+v(se(e.required_credits))+" 学分",1)])),_:2},1024),Z(e)?(f(),i(l,{key:0,class:"shortage-text"},{default:d((()=>[m("差 "+v(se(Number(e.required_credits)-Number(e.completed_credits)))+" 学分",1)])),_:2},1024)):h("",!0)])),_:2},1024),_(o,{class:"expand-action"},{default:d((()=>[P.value[W(e)]?(f(),i(l,{key:1,class:"hint-text"},{default:d((()=>[m("点击收起")])),_:1})):(f(),i(l,{key:0,class:"hint-text"},{default:d((()=>[m("点击展开")])),_:1})),_(a,{class:p(["chevron-icon",{expanded:P.value[W(e)]}]),type:"arrowdown",size:"20",color:"#7F4515"},null,8,["class"])])),_:2},1024)])),_:2},1024),_(o,{class:"progress-container"},{default:d((()=>[_(o,{class:"progress-bar"},{default:d((()=>[_(o,{class:p(["progress-fill",{danger:Z(e)}]),style:y({width:ee(e)+"%"})},null,8,["style","class"])])),_:2},1024),_(l,{class:"progress-text"},{default:d((()=>[m(v(ee(e))+"%",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),_(o,{class:p(["course-details",{expanded:P.value[W(e)]}])},{default:d((()=>[e.subtotal?(f(),i(o,{key:0,class:"module-subtotal"},{default:d((()=>[_(l,{class:"subtotal-title"},{default:d((()=>[m("模块要求小计")])),_:1}),_(l,{class:"subtotal-credits"},{default:d((()=>[m("要求学分 "+v(e.subtotal.total_credits),1)])),_:2},1024),_(l,{class:"subtotal-hours"},{default:d((()=>{var t;return[m("要求总学时 "+v((null==(t=e.subtotal.hours)?void 0:t.total)||0),1)]})),_:2},1024),_(o,{class:"subtotal-divider"}),_(l,{class:"subtotal-title"},{default:d((()=>[m("已修课程小计")])),_:1}),_(o,{class:"subtotal-completed-group"},{default:d((()=>[_(l,{class:"subtotal-hours"},{default:d((()=>[m(" 已修总学时 "+v(te(e).total||0),1)])),_:2},1024),(f(!0),b(x,null,g(ae(te(e)),(e=>(f(),i(l,{key:e,class:"subtotal-meta"},{default:d((()=>[m(v(e),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)):h("",!0),_(o,{class:"course-sort-hint"},{default:d((()=>[_(l,{class:"sort-hint-text"},{default:d((()=>[_(a,{type:"info",size:"16",color:"#666"}),m(" "+v(Z(e)?"未修课程已置顶显示，本学期课程优先":"已修课程已置顶显示"),1)])),_:2},1024)])),_:2},1024),_(o,{class:"course-list"},{default:d((()=>[(f(!0),b(x,null,g(e.courses||[],(e=>(f(),i(o,{key:(e.course_code||"")+(e.course_name||""),class:p(["course-item",{completed:X(e)}])},{default:d((()=>[_(o,{class:"course-main"},{default:d((()=>[_(o,{class:"course-title-section"},{default:d((()=>[_(o,{class:"course-name-wrapper"},{default:d((()=>[_(l,{class:"course-name"},{default:d((()=>[m(v(e.course_name),1)])),_:2},1024),Y(e)&&!X(e)?(f(),i(l,{key:0,class:"current-semester-tag"},{default:d((()=>[m("本学期可选")])),_:1})):h("",!0)])),_:2},1024),e.course_code?(f(),i(l,{key:0,class:"course-code",onClick:k((t=>{var a;(a=e.course_code)&&M({data:a,success:()=>{s({title:"课程代码已复制",icon:"none"})}})}),["stop"])},{default:d((()=>[m("代码: "+v(e.course_code),1)])),_:2},1032,["onClick"])):h("",!0)])),_:2},1024),_(o,{class:"chips"},{default:d((()=>[_(l,{class:p(["chip completion-chip",X(e)?"chip-completed":"chip-incomplete"])},{default:d((()=>[m(v(e.completion_status||"未修"),1)])),_:2},1032,["class"]),e.course_nature?(f(),i(l,{key:0,class:"chip chip-neutral"},{default:d((()=>[m(v(e.course_nature),1)])),_:2},1024)):h("",!0),e.course_attribute?(f(),i(l,{key:1,class:"chip chip-neutral"},{default:d((()=>[m(v(e.course_attribute),1)])),_:2},1024)):h("",!0)])),_:2},1024)])),_:2},1024),_(o,{class:"course-meta"},{default:d((()=>{var t;return[_(l,{class:"meta"},{default:d((()=>[m("学分 "+v(e.credits),1)])),_:2},1024),e.semester?(f(),i(l,{key:0,class:"meta"},{default:d((()=>[m("学期 "+v(e.semester),1)])),_:2},1024)):h("",!0),(null==(t=e.hours)?void 0:t.total)?(f(),i(l,{key:1,class:"meta"},{default:d((()=>[m("总学时 "+v(e.hours.total),1)])),_:2},1024)):h("",!0),(f(!0),b(x,null,g(ae(e.hours),(e=>(f(),i(l,{key:e,class:"meta"},{default:d((()=>[m(v(e),1)])),_:2},1024)))),128))]})),_:2},1024)])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1032,["class"])])),_:2},1032,["class"])))),128))])),_:1})])),_:1})])),_:1}))])),_:1})),R.value?(f(),i(o,{key:2,class:"modal-overlay",onClick:ne},{default:d((()=>[_(o,{class:"modal-container",onClick:t[0]||(t[0]=k((()=>{}),["stop"]))},{default:d((()=>[_(o,{class:"modal-header"},{default:d((()=>[_(a,{type:"info-filled",size:"24",color:"#1890ff"}),_(l,{class:"modal-title"},{default:d((()=>[m("培养方案说明")])),_:1})])),_:1}),_(o,{class:"modal-content"},{default:d((()=>[_(l,{class:"notice-text"},{default:d((()=>[m(" 本页面由教务系统培养方案表格直接生成，大部分专业的应修是160或170或175，该培养方案总和大部分都不足够（22级是），少的那些分就是你应该选的公选课的分。如果不够，请及时与对应负责老师沟通。 ")])),_:1}),_(l,{class:"notice-text",style:{"margin-top":"24rpx"}},{default:d((()=>[m(" 根据教务处官方规定：培养方案毕业学分原则上145-170学分，其中人文社会科学类专业毕业学分≤160学分，理科类专业毕业学分≤165学分，工科类专业毕业学分≤170学分，辅修学士学位专业毕业学分70学分左右。 ")])),_:1}),_(l,{class:"notice-text",style:{"margin-top":"16rpx","font-size":"24rpx",color:"#8c8c8c"}},{default:d((()=>[m(" 来源：https://jwc.qfnu.edu.cn/info/1068/7039.htm ")])),_:1})])),_:1}),_(o,{class:"modal-actions"},{default:d((()=>[_(u,{class:"action-btn primary-btn",onClick:ce},{default:d((()=>[m("我已阅读")])),_:1})])),_:1})])),_:1})])),_:1})):h("",!0)])),_:1})}}},[["__scopeId","data-v-23efd11e"]]);export{L as default};
